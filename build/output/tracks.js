/**
* EaselJS
* Visit http://easeljs.com/ for documentation, updates and examples.
*
* Copyright (c) 2011 Grant Skinner
* 
* Permission is hereby granted, free of charge, to any person
* obtaining a copy of this software and associated documentation
* files (the "Software"), to deal in the Software without
* restriction, including without limitation the rights to use,
* copy, modify, merge, publish, distribute, sublicense, and/or sell
* copies of the Software, and to permit persons to whom the
* Software is furnished to do so, subject to the following
* conditions:
* 
* The above copyright notice and this permission notice shall be
* included in all copies or substantial portions of the Software.
* 
* THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
* EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES
* OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
* NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT
* HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY,
* WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
* FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR
* OTHER DEALINGS IN THE SOFTWARE.
**/
(function(d){var c=function(){throw"UID cannot be instantiated";};c._nextID=0;c.get=function(){return c._nextID++};d.UID=c})(window);(function(d){var c=function(){throw"Ticker cannot be instantiated.";};c.useRAF=null;c._listeners=null;c._pauseable=null;c._paused=false;c._inited=false;c._startTime=0;c._pausedTime=0;c._ticks=0;c._pausedTickers=0;c._interval=50;c._lastTime=0;c._times=null;c._tickTimes=null;c._rafActive=false;c._timeoutID=null;c.addListener=function(a,b){c._inited||c.init();c.removeListener(a);c._pauseable[c._listeners.length]=b==null?true:b;c._listeners.push(a)};c.init=function(){c._inited=true;c._times=[];c._tickTimes=
[];c._pauseable=[];c._listeners=[];c._times.push(c._startTime=c._getTime());c.setInterval(c._interval)};c.removeListener=function(a){c._listeners!=null&&(a=c._listeners.indexOf(a),a!=-1&&(c._listeners.splice(a,1),c._pauseable.splice(a,1)))};c.removeAllListeners=function(){c._listeners=[];c._pauseable=[]};c.setInterval=function(a){c._lastTime=c._getTime();c._interval=a;c.timeoutID!=null&&clearTimeout(c.timeoutID);if(c.useRAF){if(c._rafActive)return;c._rafActive=true;var b=d.requestAnimationFrame||
d.webkitRequestAnimationFrame||d.mozRequestAnimationFrame||d.oRequestAnimationFrame||d.msRequestAnimationFrame;if(b){b(c._handleAF);return}}if(c._inited)c.timeoutID=setTimeout(c._handleTimeout,a)};c.getInterval=function(){return c._interval};c.setFPS=function(a){c.setInterval(1E3/a)};c.getFPS=function(){return 1E3/c._interval};c.getMeasuredFPS=function(a){if(c._times.length<2)return-1;a==null&&(a=c.getFPS()>>1);a=Math.min(c._times.length-1,a);return 1E3/((c._times[0]-c._times[a])/a)};c.setPaused=
function(a){c._paused=a};c.getPaused=function(){return c._paused};c.getTime=function(a){return c._getTime()-c._startTime-(a?c._pausedTime:0)};c.getTicks=function(a){return c._ticks-(a?c._pausedTickers:0)};c._handleAF=function(a){a-c._lastTime>=c._interval-1&&c._tick();c.useRAF?(d.requestAnimationFrame||d.webkitRequestAnimationFrame||d.mozRequestAnimationFrame||d.oRequestAnimationFrame||d.msRequestAnimationFrame)(c._handleAF,c.animationTarget):c._rafActive=false};c._handleTimeout=function(){c._tick();
if(!c.useRAF)c.timeoutID=setTimeout(c._handleTimeout,c._interval)};c._tick=function(){c._ticks++;var a=c._getTime(),b=a-c._lastTime,f=c._paused;f&&(c._pausedTickers++,c._pausedTime+=b);c._lastTime=a;for(var d=c._pauseable,e=c._listeners.slice(),h=e?e.length:0,j=0;j<h;j++){var k=d[j],l=e[j];l==null||f&&k||l.tick==null||l.tick(b,f)}for(c._tickTimes.unshift(c._getTime()-a);c._tickTimes.length>100;)c._tickTimes.pop();for(c._times.unshift(a);c._times.length>100;)c._times.pop()};c._getTime=function(){return(new Date).getTime()};
d.Ticker=c})(window);(function(d){var c=function(b,a,c,d,h){this.initialize(b,a,c,d,h)},a=c.prototype;a.stageX=0;a.stageY=0;a.type=null;a.nativeEvent=null;a.onMouseMove=null;a.onMouseUp=null;a.target=null;a.initialize=function(b,a,c,d,h){this.type=b;this.stageX=a;this.stageY=c;this.target=d;this.nativeEvent=h};a.clone=function(){return new c(this.type,this.stageX,this.stageY,this.target,this.nativeEvent)};a.toString=function(){return"[MouseEvent (type="+this.type+" stageX="+this.stageX+" stageY="+this.stageY+")]"};d.MouseEvent=
c})(window);(function(d){var c=function(b,a,c,d,h,j){this.initialize(b,a,c,d,h,j)},a=c.prototype;c.identity=null;c.DEG_TO_RAD=Math.PI/180;a.a=1;a.b=0;a.c=0;a.d=1;a.tx=0;a.ty=0;a.alpha=1;a.shadow=null;a.compositeOperation=null;a.initialize=function(b,a,c,d,h,j){if(b!=null)this.a=b;this.b=a||0;this.c=c||0;if(d!=null)this.d=d;this.tx=h||0;this.ty=j||0};a.prepend=function(b,a,c,d,h,j){var k=this.tx;if(b!=1||a!=0||c!=0||d!=1){var l=this.a,m=this.c;this.a=l*b+this.b*c;this.b=l*a+this.b*d;this.c=m*b+this.d*c;this.d=
m*a+this.d*d}this.tx=k*b+this.ty*c+h;this.ty=k*a+this.ty*d+j};a.append=function(b,a,c,d,h,j){var k=this.a,l=this.b,m=this.c,q=this.d;this.a=b*k+a*m;this.b=b*l+a*q;this.c=c*k+d*m;this.d=c*l+d*q;this.tx=h*k+j*m+this.tx;this.ty=h*l+j*q+this.ty};a.prependMatrix=function(b){this.prepend(b.a,b.b,b.c,b.d,b.tx,b.ty);this.prependProperties(b.alpha,b.shadow,b.compositeOperation)};a.appendMatrix=function(b){this.append(b.a,b.b,b.c,b.d,b.tx,b.ty);this.appendProperties(b.alpha,b.shadow,b.compositeOperation)};
a.prependTransform=function(b,a,d,e,h,j,k,l,m){if(h%360)var q=h*c.DEG_TO_RAD,h=Math.cos(q),q=Math.sin(q);else h=1,q=0;if(l||m)this.tx-=l,this.ty-=m;j||k?(j*=c.DEG_TO_RAD,k*=c.DEG_TO_RAD,this.prepend(h*d,q*d,-q*e,h*e,0,0),this.prepend(Math.cos(k),Math.sin(k),-Math.sin(j),Math.cos(j),b,a)):this.prepend(h*d,q*d,-q*e,h*e,b,a)};a.appendTransform=function(b,a,d,e,h,j,k,l,m){if(h%360)var q=h*c.DEG_TO_RAD,h=Math.cos(q),q=Math.sin(q);else h=1,q=0;j||k?(j*=c.DEG_TO_RAD,k*=c.DEG_TO_RAD,this.append(Math.cos(k),
Math.sin(k),-Math.sin(j),Math.cos(j),b,a),this.append(h*d,q*d,-q*e,h*e,0,0)):this.append(h*d,q*d,-q*e,h*e,b,a);if(l||m)this.tx-=l*this.a+m*this.c,this.ty-=l*this.b+m*this.d};a.rotate=function(b){var a=Math.cos(b),b=Math.sin(b),c=this.a,d=this.c,h=this.tx;this.a=c*a-this.b*b;this.b=c*b+this.b*a;this.c=d*a-this.d*b;this.d=d*b+this.d*a;this.tx=h*a-this.ty*b;this.ty=h*b+this.ty*a};a.skew=function(b,a){b*=c.DEG_TO_RAD;a*=c.DEG_TO_RAD;this.append(Math.cos(a),Math.sin(a),-Math.sin(b),Math.cos(b),0,0)};a.scale=
function(b,a){this.a*=b;this.d*=a;this.tx*=b;this.ty*=a};a.translate=function(b,a){this.tx+=b;this.ty+=a};a.identity=function(){this.alpha=this.a=this.d=1;this.b=this.c=this.tx=this.ty=0;this.shadow=this.compositeOperation=null};a.invert=function(){var b=this.a,a=this.b,c=this.c,d=this.d,h=this.tx,j=b*d-a*c;this.a=d/j;this.b=-a/j;this.c=-c/j;this.d=b/j;this.tx=(c*this.ty-d*h)/j;this.ty=-(b*this.ty-a*h)/j};a.isIdentity=function(){return this.tx==0&&this.ty==0&&this.a==1&&this.b==0&&this.c==0&&this.d==
1};a.decompose=function(b){b==null&&(b={});b.x=this.tx;b.y=this.ty;b.scaleX=Math.sqrt(this.a*this.a+this.b*this.b);b.scaleY=Math.sqrt(this.c*this.c+this.d*this.d);var a=Math.atan2(-this.c,this.d),d=Math.atan2(this.b,this.a);a==d?(b.rotation=d/c.DEG_TO_RAD,this.a<0&&this.d>=0&&(b.rotation+=b.rotation<=0?180:-180),b.skewX=b.skewY=0):(b.skewX=a/c.DEG_TO_RAD,b.skewY=d/c.DEG_TO_RAD);return b};a.reinitialize=function(b,a,c,d,h,j,k,l,m){this.initialize(b,a,c,d,h,j);this.alpha=k||1;this.shadow=l;this.compositeOperation=
m;return this};a.appendProperties=function(b,a,c){this.alpha*=b;this.shadow=a||this.shadow;this.compositeOperation=c||this.compositeOperation};a.prependProperties=function(b,a,c){this.alpha*=b;this.shadow=this.shadow||a;this.compositeOperation=this.compositeOperation||c};a.clone=function(){var b=new c(this.a,this.b,this.c,this.d,this.tx,this.ty);b.shadow=this.shadow;b.alpha=this.alpha;b.compositeOperation=this.compositeOperation;return b};a.toString=function(){return"[Matrix2D (a="+this.a+" b="+this.b+
" c="+this.c+" d="+this.d+" tx="+this.tx+" ty="+this.ty+")]"};c.identity=new c(1,0,0,1,0,0);d.Matrix2D=c})(window);(function(d){var c=function(b,a){this.initialize(b,a)},a=c.prototype;a.x=0;a.y=0;a.initialize=function(b,a){this.x=b==null?0:b;this.y=a==null?0:a};a.clone=function(){return new c(this.x,this.y)};a.toString=function(){return"[Point (x="+this.x+" y="+this.y+")]"};d.Point=c})(window);(function(d){var c=function(b,a,c,d){this.initialize(b,a,c,d)},a=c.prototype;a.x=0;a.y=0;a.width=0;a.height=0;a.initialize=function(b,a,c,d){this.x=b==null?0:b;this.y=a==null?0:a;this.width=c==null?0:c;this.height=d==null?0:d};a.clone=function(){return new c(this.x,this.y,this.width,this.height)};a.toString=function(){return"[Rectangle (x="+this.x+" y="+this.y+" width="+this.width+" height="+this.height+")]"};d.Rectangle=c})(window);(function(d){var c=function(b,a,c,d){this.initialize(b,a,c,d)},a=c.prototype;c.identity=null;a.color=null;a.offsetX=0;a.offsetY=0;a.blur=0;a.initialize=function(b,a,c,d){this.color=b;this.offsetX=a;this.offsetY=c;this.blur=d};a.toString=function(){return"[Shadow]"};a.clone=function(){return new c(this.color,this.offsetX,this.offsetY,this.blur)};c.identity=new c("transparent",0,0,0);d.Shadow=c})(window);(function(d){var c=function(b){this.initialize(b)},a=c.prototype;a.complete=true;a._animations=null;a._frames=null;a._images=null;a._data=null;a._loadCount=0;a._frameHeight=0;a._frameWidth=0;a._numFrames=0;a._regX=0;a._regY=0;a.initialize=function(b){var a,c,d;if(b!=null){if(b.images&&(c=b.images.length)>0){d=this._images=[];for(a=0;a<c;a++){var h=b.images[a];if(!(h instanceof Image)){var j=h,h=new Image;h.src=j}d.push(h);if(!h.getContext&&!h.complete)this._loadCount++,this.complete=false,function(b){h.onload=
function(){b._handleImageLoad()}}(this)}}if(b.frames!=null)if(b.frames instanceof Array){this._frames=[];d=b.frames;for(a=0,c=d.length;a<c;a++)j=d[a],this._frames.push({image:this._images[j[4]?j[4]:0],rect:new Rectangle(j[0],j[1],j[2],j[3]),regX:j[5]||0,regY:j[6]||0})}else c=b.frames,this._frameWidth=c.width,this._frameHeight=c.height,this._regX=c.regX||0,this._regY=c.regY||0,this._numFrames=c.count,this._loadCount==0&&this._calculateFrames();if((c=b.animations)!=null){this._animations=[];this._data=
{};for(var k in c){b={name:k};j=c[k];if(isNaN(j))if(j instanceof Array){b.frequency=j[3];b.next=j[2];d=b.frames=[];for(a=j[0];a<=j[1];a++)d.push(a)}else b.frequency=j.frequency,b.next=j.next,d=b.frames=j.frames.slice(0);else d=b.frames=[j];b.next=d.length<2||b.next==false?null:b.next==true?k:b.next;if(!b.frequency)b.frequency=1;this._animations.push(k);this._data[k]=b}}}};a.getNumFrames=function(b){return b==null?this._frames?this._frames.length:this._numFrames:(b=this._data[b],b==null?0:b.frames.length)};
a.getAnimations=function(){return this._animations.slice(0)};a.getAnimation=function(b){return this._data[b]};a.getFrame=function(b){return this.complete&&this._frames&&(frame=this._frames[b])?frame:null};a.toString=function(){return"[SpriteSheet]"};a.clone=function(){var b=new c;b.complete=this.complete;b._animations=this._animations;b._frames=this._frames;b._images=this._images;b._data=this._data;b._frameHeight=this._frameHeight;b._frameWidth=this._frameWidth;b._numFrames=this._numFrames;b._loadCount=
this._loadCount;return b};a._handleImageLoad=function(){if(--this._loadCount==0)this._calculateFrames(),this.complete=true};a._calculateFrames=function(){if(!(this._frames||this._frameWidth==0)){this._frames=[];for(var b=0,a=this._frameWidth,c=this._frameHeight,d=0,h=this._images;d<h.length;d++){for(var j=h[d],k=(j.width+1)/a|0,l=(j.height+1)/c|0,l=this._numFrames>0?Math.min(this._numFrames-b,k*l):k*l,m=0;m<l;m++)this._frames.push({image:j,rect:new Rectangle(m%k*a,(m/k|0)*c,a,c),regX:this._regX,regY:this._regY});
b+=l}this._numFrames=b}};d.SpriteSheet=c})(window);(function(d){function c(b,a){this.f=b;this.params=a}c.prototype.exec=function(b){this.f.apply(b,this.params)};var a=function(){this.initialize()},b=a.prototype;a.getRGB=function(b,a,c,d){b!=null&&c==null&&(d=a,c=b&255,a=b>>8&255,b=b>>16&255);return d==null?"rgb("+b+","+a+","+c+")":"rgba("+b+","+a+","+c+","+d+")"};a.getHSL=function(b,a,c,d){return d==null?"hsl("+b%360+","+a+"%,"+c+"%)":"hsla("+b%360+","+a+"%,"+c+"%,"+d+")"};a.STROKE_CAPS_MAP=["butt","round","square"];a.STROKE_JOINTS_MAP=["miter","round",
"bevel"];a._ctx=document.createElement("canvas").getContext("2d");a.beginCmd=new c(a._ctx.beginPath,[]);a.fillCmd=new c(a._ctx.fill,[]);a.strokeCmd=new c(a._ctx.stroke,[]);b._strokeInstructions=null;b._strokeStyleInstructions=null;b._fillInstructions=null;b._instructions=null;b._oldInstructions=null;b._activeInstructions=null;b._active=false;b._dirty=false;b.initialize=function(){this.clear();this._ctx=a._ctx};b.draw=function(b){this._dirty&&this._updateInstructions();for(var a=this._instructions,
c=0,d=a.length;c<d;c++)a[c].exec(b)};b.moveTo=function(b,a){this._activeInstructions.push(new c(this._ctx.moveTo,[b,a]));return this};b.lineTo=function(b,a){this._dirty=this._active=true;this._activeInstructions.push(new c(this._ctx.lineTo,[b,a]));return this};b.arcTo=function(b,a,d,h,j){this._dirty=this._active=true;this._activeInstructions.push(new c(this._ctx.arcTo,[b,a,d,h,j]));return this};b.arc=function(b,a,d,h,j,k){this._dirty=this._active=true;k==null&&(k=false);this._activeInstructions.push(new c(this._ctx.arc,
[b,a,d,h,j,k]));return this};b.quadraticCurveTo=function(b,a,d,h){this._dirty=this._active=true;this._activeInstructions.push(new c(this._ctx.quadraticCurveTo,[b,a,d,h]));return this};b.bezierCurveTo=function(b,a,d,h,j,k){this._dirty=this._active=true;this._activeInstructions.push(new c(this._ctx.bezierCurveTo,[b,a,d,h,j,k]));return this};b.rect=function(b,a,d,h){this._dirty=this._active=true;this._activeInstructions.push(new c(this._ctx.rect,[b,a,d,h]));return this};b.closePath=function(){if(this._active)this._dirty=
true,this._activeInstructions.push(new c(this._ctx.closePath,[]));return this};b.clear=function(){this._instructions=[];this._oldInstructions=[];this._activeInstructions=[];this._strokeStyleInstructions=this._strokeInstructions=this._fillInstructions=null;this._active=this._dirty=false;return this};b.beginFill=function(b){this._active&&this._newPath();this._fillInstructions=b?[new c(this._setProp,["fillStyle",b])]:null;return this};b.beginLinearGradientFill=function(b,a,d,h,j,k){this._active&&this._newPath();
d=this._ctx.createLinearGradient(d,h,j,k);h=0;for(j=b.length;h<j;h++)d.addColorStop(a[h],b[h]);this._fillInstructions=[new c(this._setProp,["fillStyle",d])];return this};b.beginRadialGradientFill=function(b,a,d,h,j,k,l,m){this._active&&this._newPath();d=this._ctx.createRadialGradient(d,h,j,k,l,m);h=0;for(j=b.length;h<j;h++)d.addColorStop(a[h],b[h]);this._fillInstructions=[new c(this._setProp,["fillStyle",d])];return this};b.beginBitmapFill=function(b,a){this._active&&this._newPath();var d=this._ctx.createPattern(b,
a||"");this._fillInstructions=[new c(this._setProp,["fillStyle",d])];return this};b.endFill=function(){this.beginFill(null);return this};b.setStrokeStyle=function(b,d,e,h){this._active&&this._newPath();this._strokeStyleInstructions=[new c(this._setProp,["lineWidth",b==null?"1":b]),new c(this._setProp,["lineCap",d==null?"butt":isNaN(d)?d:a.STROKE_CAPS_MAP[d]]),new c(this._setProp,["lineJoin",e==null?"miter":isNaN(e)?e:a.STROKE_JOINTS_MAP[e]]),new c(this._setProp,["miterLimit",h==null?"10":h])];return this};
b.beginStroke=function(b){this._active&&this._newPath();this._strokeInstructions=b?[new c(this._setProp,["strokeStyle",b])]:null;return this};b.beginLinearGradientStroke=function(b,a,d,h,j,k){this._active&&this._newPath();d=this._ctx.createLinearGradient(d,h,j,k);h=0;for(j=b.length;h<j;h++)d.addColorStop(a[h],b[h]);this._strokeInstructions=[new c(this._setProp,["strokeStyle",d])];return this};b.beginRadialGradientStroke=function(b,a,d,h,j,k,l,m){this._active&&this._newPath();d=this._ctx.createRadialGradient(d,
h,j,k,l,m);h=0;for(j=b.length;h<j;h++)d.addColorStop(a[h],b[h]);this._strokeInstructions=[new c(this._setProp,["strokeStyle",d])];return this};b.beginBitmapStroke=function(b,a){this._active&&this._newPath();var d=this._ctx.createPattern(b,a||"");this._strokeInstructions=[new c(this._setProp,["strokeStyle",d])];return this};b.endStroke=function(){this.beginStroke(null);return this};b.curveTo=b.quadraticCurveTo;b.drawRect=b.rect;b.drawRoundRect=function(b,a,c,d,j){this.drawRoundRectComplex(b,a,c,d,
j,j,j,j);return this};b.drawRoundRectComplex=function(b,a,d,h,j,k,l,m){this._dirty=this._active=true;this._activeInstructions.push(new c(this._ctx.moveTo,[b+j,a]),new c(this._ctx.lineTo,[b+d-k,a]),new c(this._ctx.arc,[b+d-k,a+k,k,-Math.PI/2,0,false]),new c(this._ctx.lineTo,[b+d,a+h-l]),new c(this._ctx.arc,[b+d-l,a+h-l,l,0,Math.PI/2,false]),new c(this._ctx.lineTo,[b+m,a+h]),new c(this._ctx.arc,[b+m,a+h-m,m,Math.PI/2,Math.PI,false]),new c(this._ctx.lineTo,[b,a+j]),new c(this._ctx.arc,[b+j,a+j,j,Math.PI,
Math.PI*3/2,false]));return this};b.drawCircle=function(b,a,c){this.arc(b,a,c,0,Math.PI*2);return this};b.drawEllipse=function(b,a,d,h){this._dirty=this._active=true;var j=d/2*0.5522848,k=h/2*0.5522848,l=b+d,m=a+h,d=b+d/2,h=a+h/2;this._activeInstructions.push(new c(this._ctx.moveTo,[b,h]),new c(this._ctx.bezierCurveTo,[b,h-k,d-j,a,d,a]),new c(this._ctx.bezierCurveTo,[d+j,a,l,h-k,l,h]),new c(this._ctx.bezierCurveTo,[l,h+k,d+j,m,d,m]),new c(this._ctx.bezierCurveTo,[d-j,m,b,h+k,b,h]));return this};b.drawPolyStar=
function(b,a,d,h,j,k){this._dirty=this._active=true;j==null&&(j=0);j=1-j;k==null?k=0:k/=180/Math.PI;var l=Math.PI/h;this._activeInstructions.push(new c(this._ctx.moveTo,[b+Math.cos(k)*d,a+Math.sin(k)*d]));for(var m=0;m<h;m++)k+=l,j!=1&&this._activeInstructions.push(new c(this._ctx.lineTo,[b+Math.cos(k)*d*j,a+Math.sin(k)*d*j])),k+=l,this._activeInstructions.push(new c(this._ctx.lineTo,[b+Math.cos(k)*d,a+Math.sin(k)*d]));return this};b.clone=function(){var b=new a;b._instructions=this._instructions.slice();
b._activeInstructions=this._activeInstructions.slice();b._oldInstructions=this._oldInstructions.slice();if(this._fillInstructions)b._fillInstructions=this._fillInstructions.slice();if(this._strokeInstructions)b._strokeInstructions=this._strokeInstructions.slice();if(this._strokeStyleInstructions)b._strokeStyleInstructions=this._strokeStyleInstructions.slice();b._active=this._active;b._dirty=this._dirty;return b};b.toString=function(){return"[Graphics]"};b.mt=b.moveTo;b.lt=b.lineTo;b.at=b.arcTo;b.bt=
b.bezierCurveTo;b.qt=b.quadraticCurveTo;b.a=b.arc;b.r=b.rect;b.cp=b.closePath;b.c=b.clear;b.f=b.beginFill;b.lf=b.beginLinearGradientFill;b.rf=b.beginRadialGradientFill;b.bf=b.beginBitmapFill;b.ef=b.endFill;b.ss=b.setStrokeStyle;b.s=b.beginStroke;b.ls=b.beginLinearGradientStroke;b.rs=b.beginRadialGradientStroke;b.bs=b.beginBitmapStroke;b.es=b.endStroke;b.dr=b.drawRect;b.rr=b.drawRoundRect;b.rc=b.drawRoundRectComplex;b.dc=b.drawCircle;b.de=b.drawEllipse;b.dp=b.drawPolyStar;b._updateInstructions=function(){this._instructions=
this._oldInstructions.slice();this._instructions.push(a.beginCmd);this._fillInstructions&&this._instructions.push.apply(this._instructions,this._fillInstructions);this._strokeInstructions&&(this._instructions.push.apply(this._instructions,this._strokeInstructions),this._strokeStyleInstructions&&this._instructions.push.apply(this._instructions,this._strokeStyleInstructions));this._instructions.push.apply(this._instructions,this._activeInstructions);this._fillInstructions&&this._instructions.push(a.fillCmd);
this._strokeInstructions&&this._instructions.push(a.strokeCmd)};b._newPath=function(){this._dirty&&this._updateInstructions();this._oldInstructions=this._instructions;this._activeInstructions=[];this._active=this._dirty=false};b._setProp=function(b,a){this[b]=a};d.Graphics=a})(window);(function(d){var c=function(){this.initialize()},a=c.prototype;c.suppressCrossDomainErrors=false;c._hitTestCanvas=document.createElement("canvas");c._hitTestCanvas.width=c._hitTestCanvas.height=1;c._hitTestContext=c._hitTestCanvas.getContext("2d");a.alpha=1;a.cacheCanvas=null;a.id=-1;a.mouseEnabled=true;a.name=null;a.parent=null;a.regX=0;a.regY=0;a.rotation=0;a.scaleX=1;a.scaleY=1;a.skewX=0;a.skewY=0;a.shadow=null;a.visible=true;a.x=0;a.y=0;a.compositeOperation=null;a.snapToPixel=false;a.onPress=
null;a.onClick=null;a.onDoubleClick=null;a.onMouseOver=null;a.onMouseOut=null;a.tick=null;a.filters=null;a.cacheID=0;a._cacheOffsetX=0;a._cacheOffsetY=0;a._cacheDataURLID=0;a._cacheDataURL=null;a._matrix=null;a.initialize=function(){this.id=UID.get();this._matrix=new Matrix2D};a.isVisible=function(){return this.visible&&this.alpha>0&&this.scaleX!=0&&this.scaleY!=0};a.draw=function(b,a){if(a||!this.cacheCanvas)return false;b.drawImage(this.cacheCanvas,this._cacheOffsetX,this._cacheOffsetY);return true};
a.cache=function(b,a,c,d){if(this.cacheCanvas==null)this.cacheCanvas=document.createElement("canvas");var h=this.cacheCanvas.getContext("2d");this.cacheCanvas.width=c;this.cacheCanvas.height=d;h.clearRect(0,0,c+1,d+1);h.setTransform(1,0,0,1,-b,-a);this.draw(h,true,this._matrix.reinitialize(1,0,0,1,-b,-a));this._cacheOffsetX=b;this._cacheOffsetY=a;this._applyFilters();this.cacheID++};a.updateCache=function(b){if(this.cacheCanvas==null)throw"cache() must be called before updateCache()";var a=this.cacheCanvas.getContext("2d");
a.setTransform(1,0,0,1,-this._cacheOffsetX,-this._cacheOffsetY);b?a.globalCompositeOperation=b:a.clearRect(0,0,this.cacheCanvas.width+1,this.cacheCanvas.height+1);this.draw(a,true);if(b)a.globalCompositeOperation="source-over";this._applyFilters();this.cacheID++};a.uncache=function(){this._cacheDataURL=this.cacheCanvas=null;this._cacheOffsetX=this._cacheOffsetY=0};a.getCacheDataURL=function(){if(!this.cacheCanvas)return null;if(this.cacheID!=this._cacheDataURLID)this._cacheDataURL=this.cacheCanvas.toDataURL();
return this._cacheDataURL};a.getStage=function(){for(var b=this;b.parent;)b=b.parent;return b instanceof Stage?b:null};a.localToGlobal=function(b,a){var c=this.getConcatenatedMatrix(this._matrix);if(c==null)return null;c.append(1,0,0,1,b,a);return new Point(c.tx,c.ty)};a.globalToLocal=function(b,a){var c=this.getConcatenatedMatrix(this._matrix);if(c==null)return null;c.invert();c.append(1,0,0,1,b,a);return new Point(c.tx,c.ty)};a.localToLocal=function(b,a,c){b=this.localToGlobal(b,a);return c.globalToLocal(b.x,
b.y)};a.setTransform=function(b,a,c,d,h,j,k,l,m){this.x=b||0;this.y=a||0;this.scaleX=c==null?1:c;this.scaleY=d==null?1:d;this.rotation=h||0;this.skewX=j||0;this.skewY=k||0;this.regX=l||0;this.regY=m||0};a.getConcatenatedMatrix=function(b){b?b.identity():b=new Matrix2D;for(var a=this;a!=null;)b.prependTransform(a.x,a.y,a.scaleX,a.scaleY,a.rotation,a.skewX,a.skewY,a.regX,a.regY),b.prependProperties(a.alpha,a.shadow,a.compositeOperation),a=a.parent;return b};a.hitTest=function(b,a){var d=c._hitTestContext,
e=c._hitTestCanvas;d.setTransform(1,0,0,1,-b,-a);this.draw(d);d=this._testHit(d);e.width=0;e.width=1;return d};a.clone=function(){var b=new c;this.cloneProps(b);return b};a.toString=function(){return"[DisplayObject (name="+this.name+")]"};a.cloneProps=function(b){b.alpha=this.alpha;b.name=this.name;b.regX=this.regX;b.regY=this.regY;b.rotation=this.rotation;b.scaleX=this.scaleX;b.scaleY=this.scaleY;b.shadow=this.shadow;b.skewX=this.skewX;b.skewY=this.skewY;b.visible=this.visible;b.x=this.x;b.y=this.y;
b.mouseEnabled=this.mouseEnabled;b.compositeOperation=this.compositeOperation;if(this.cacheCanvas)b.cacheCanvas=this.cacheCanvas.cloneNode(true),b.cacheCanvas.getContext("2d").putImageData(this.cacheCanvas.getContext("2d").getImageData(0,0,this.cacheCanvas.width,this.cacheCanvas.height),0,0)};a.applyShadow=function(b,a){a=a||Shadow.identity;b.shadowColor=a.color;b.shadowOffsetX=a.offsetX;b.shadowOffsetY=a.offsetY;b.shadowBlur=a.blur};a._testHit=function(b){try{var a=b.getImageData(0,0,1,1).data[3]>
1}catch(d){if(!c.suppressCrossDomainErrors)throw"An error has occured. This is most likely due to security restrictions on reading canvas pixel data with local or cross-domain images.";}return a};a._applyFilters=function(){if(this.filters&&this.filters.length!=0&&this.cacheCanvas)for(var b=this.filters.length,a=this.cacheCanvas.getContext("2d"),c=this.cacheCanvas.width,d=this.cacheCanvas.height,h=0;h<b;h++)this.filters[h].applyFilter(a,0,0,c,d)};d.DisplayObject=c})(window);(function(d){var c=function(){this.initialize()},a=c.prototype=new DisplayObject;a.children=null;a.DisplayObject_initialize=a.initialize;a.initialize=function(){this.DisplayObject_initialize();this.children=[]};a.isVisible=function(){return this.visible&&this.alpha>0&&this.children.length&&this.scaleX!=0&&this.scaleY!=0};a.DisplayObject_draw=a.draw;a.draw=function(b,a,d){var e=Stage._snapToPixelEnabled;if(this.DisplayObject_draw(b,a))return true;for(var d=d||this._matrix.reinitialize(1,0,0,1,0,0,
this.alpha,this.shadow,this.compositeOperation),a=this.children.length,h=this.children.slice(0),j=0;j<a;j++){var k=h[j];if(k.isVisible()){var l=false,m=k._matrix.reinitialize(d.a,d.b,d.c,d.d,d.tx,d.ty,d.alpha,d.shadow,d.compositeOperation);m.appendTransform(k.x,k.y,k.scaleX,k.scaleY,k.rotation,k.skewX,k.skewY,k.regX,k.regY);m.appendProperties(k.alpha,k.shadow,k.compositeOperation);if(!(k instanceof c&&k.cacheCanvas==null))e&&k.snapToPixel&&m.a==1&&m.b==0&&m.c==0&&m.d==1?b.setTransform(m.a,m.b,m.c,
m.d,m.tx+0.5|0,m.ty+0.5|0):b.setTransform(m.a,m.b,m.c,m.d,m.tx,m.ty),b.globalAlpha=m.alpha,b.globalCompositeOperation=m.compositeOperation||"source-over",(l=m.shadow)&&this.applyShadow(b,l);k.draw(b,false,m);l&&this.applyShadow(b)}}return true};a.addChild=function(b){var a=arguments.length;if(a>1){for(var c=0;c<a;c++)this.addChild(arguments[c]);return arguments[a-1]}b.parent&&b.parent.removeChild(b);b.parent=this;this.children.push(b);return b};a.addChildAt=function(b,a){var c=arguments.length;if(c>
2){for(var a=arguments[d-1],d=0;d<c-1;d++)this.addChildAt(arguments[d],a+d);return arguments[c-2]}b.parent&&b.parent.removeChild(b);b.parent=this;this.children.splice(a,0,b);return b};a.removeChild=function(b){var a=arguments.length;if(a>1){for(var c=true,d=0;d<a;d++)c=c&&this.removeChild(arguments[d]);return c}return this.removeChildAt(this.children.indexOf(b))};a.removeChildAt=function(b){var a=arguments.length;if(a>1){for(var c=[],d=0;d<a;d++)c[d]=arguments[d];c.sort(function(b,a){return a-b});
for(var h=true,d=0;d<a;d++)h=h&&this.removeChildAt(c[d]);return h}if(b<0||b>this.children.length-1)return false;a=this.children[b];if(a!=null)a.parent=null;this.children.splice(b,1);return true};a.removeAllChildren=function(){for(;this.children.length;)this.removeChildAt(0)};a.getChildAt=function(b){return this.children[b]};a.sortChildren=function(b){this.children.sort(b)};a.getChildIndex=function(b){return this.children.indexOf(b)};a.getNumChildren=function(){return this.children.length};a.contains=
function(b){for(;b;){if(b==this)return true;b=b.parent}return false};a.hitTest=function(b,a){return this.getObjectUnderPoint(b,a)!=null};a.getObjectsUnderPoint=function(b,a){var c=[],d=this.localToGlobal(b,a);this._getObjectsUnderPoint(d.x,d.y,c);return c};a.getObjectUnderPoint=function(b,a){var c=this.localToGlobal(b,a);return this._getObjectsUnderPoint(c.x,c.y)};a.clone=function(b){var a=new c;this.cloneProps(a);if(b)for(var d=a.children=[],e=0,h=this.children.length;e<h;e++){var j=this.children[e].clone(b);
j.parent=a;d.push(j)}return a};a.toString=function(){return"[Container (name="+this.name+")]"};a._tick=function(){for(var b=this.children.length-1;b>=0;b--){var a=this.children[b];a._tick&&a._tick();a.tick&&a.tick()}};a._getObjectsUnderPoint=function(b,a,d,e){var h=DisplayObject._hitTestContext,j=DisplayObject._hitTestCanvas,k=this._matrix,l=e&1&&(this.onPress||this.onClick||this.onDoubleClick)||e&2&&(this.onMouseOver||this.onMouseOut);if(this.cacheCanvas)if(this.getConcatenatedMatrix(k),h.setTransform(k.a,
k.b,k.c,k.d,k.tx-b,k.ty-a),h.globalAlpha=k.alpha,this.draw(h),this._testHit(h)){if(j.width=0,j.width=1,l)return this}else return null;for(var m=this.children.length-1;m>=0;m--){var q=this.children[m];if(q.isVisible()&&q.mouseEnabled)if(q instanceof c)if(l){if(q=q._getObjectsUnderPoint(b,a))return this}else{if(q=q._getObjectsUnderPoint(b,a,d,e),!d&&q)return q}else if(!e||l||e&1&&(q.onPress||q.onClick||q.onDoubleClick)||e&2&&(q.onMouseOver||q.onMouseOut))if(q.getConcatenatedMatrix(k),h.setTransform(k.a,
k.b,k.c,k.d,k.tx-b,k.ty-a),h.globalAlpha=k.alpha,q.draw(h),this._testHit(h))if(j.width=0,j.width=1,l)return this;else if(d)d.push(q);else return q}return null};d.Container=c})(window);(function(d){var c=function(b){this.initialize(b)},a=c.prototype=new Container;c._snapToPixelEnabled=false;a.autoClear=true;a.canvas=null;a.mouseX=null;a.mouseY=null;a.onMouseMove=null;a.onMouseUp=null;a.onMouseDown=null;a.snapToPixelEnabled=false;a.mouseInBounds=false;a.tickOnUpdate=true;a._activeMouseEvent=null;a._activeMouseTarget=null;a._mouseOverIntervalID=null;a._mouseOverX=0;a._mouseOverY=0;a._mouseOverTarget=null;a.Container_initialize=a.initialize;a.initialize=function(b){this.Container_initialize();
this.canvas=b instanceof HTMLCanvasElement?b:document.getElementById(b);this._enableMouseEvents(true)};a.update=function(){if(this.canvas)this.autoClear&&this.clear(),c._snapToPixelEnabled=this.snapToPixelEnabled,this.tickOnUpdate&&this._tick(),this.draw(this.canvas.getContext("2d"),false,this.getConcatenatedMatrix(this._matrix))};a.tick=a.update;a.clear=function(){if(this.canvas){var b=this.canvas.getContext("2d");b.setTransform(1,0,0,1,0,0);b.clearRect(0,0,this.canvas.width,this.canvas.height)}};
a.toDataURL=function(b,a){a||(a="image/png");var c=this.canvas.getContext("2d"),d=this.canvas.width,h=this.canvas.height,j;if(b){j=c.getImageData(0,0,d,h);var k=c.globalCompositeOperation;c.globalCompositeOperation="destination-over";c.fillStyle=b;c.fillRect(0,0,d,h)}var l=this.canvas.toDataURL(a);if(b)c.clearRect(0,0,d,h),c.putImageData(j,0,0),c.globalCompositeOperation=k;return l};a.enableMouseOver=function(b){if(this._mouseOverIntervalID)clearInterval(this._mouseOverIntervalID),this._mouseOverIntervalID=
null;if(!(b<=0)){var a=this;this._mouseOverIntervalID=setInterval(function(){a._testMouseOver()},1E3/Math.min(50,b));this._mouseOverX=NaN;this._mouseOverTarget=null}};a.clone=function(){var b=new c(null);this.cloneProps(b);return b};a.toString=function(){return"[Stage (name="+this.name+")]"};a._enableMouseEvents=function(){var b=this,a=d.addEventListener?d:document;a.addEventListener("mouseup",function(a){b._handleMouseUp(a)},false);a.addEventListener("mousemove",function(a){b._handleMouseMove(a)},
false);a.addEventListener("dblclick",function(a){b._handleDoubleClick(a)},false);this.canvas&&this.canvas.addEventListener("mousedown",function(a){b._handleMouseDown(a)},false)};a._handleMouseMove=function(b){if(this.canvas){if(!b)b=d.event;var a=this.mouseInBounds;this._updateMousePosition(b.pageX,b.pageY);if(a||this.mouseInBounds){b=new MouseEvent("onMouseMove",this.mouseX,this.mouseY,this,b);if(this.onMouseMove)this.onMouseMove(b);if(this._activeMouseEvent&&this._activeMouseEvent.onMouseMove)this._activeMouseEvent.onMouseMove(b)}}else this.mouseX=
this.mouseY=null};a._updateMousePosition=function(b,a){var c=this.canvas;do b-=c.offsetLeft,a-=c.offsetTop;while(c=c.offsetParent);if(this.mouseInBounds=b>=0&&a>=0&&b<this.canvas.width&&a<this.canvas.height)this.mouseX=b,this.mouseY=a};a._handleMouseUp=function(b){var a=new MouseEvent("onMouseUp",this.mouseX,this.mouseY,this,b);if(this.onMouseUp)this.onMouseUp(a);if(this._activeMouseEvent&&this._activeMouseEvent.onMouseUp)this._activeMouseEvent.onMouseUp(a);if(this._activeMouseTarget&&this._activeMouseTarget.onClick&&
this._getObjectsUnderPoint(this.mouseX,this.mouseY,null,true,this._mouseOverIntervalID?3:1)==this._activeMouseTarget)this._activeMouseTarget.onClick(new MouseEvent("onClick",this.mouseX,this.mouseY,this._activeMouseTarget,b));this._activeMouseEvent=this._activeMouseTarget=null};a._handleMouseDown=function(b){if(this.onMouseDown)this.onMouseDown(new MouseEvent("onMouseDown",this.mouseX,this.mouseY,this,b));var a=this._getObjectsUnderPoint(this.mouseX,this.mouseY,null,this._mouseOverIntervalID?3:1);
if(a){if(a.onPress instanceof Function&&(b=new MouseEvent("onPress",this.mouseX,this.mouseY,a,b),a.onPress(b),b.onMouseMove||b.onMouseUp))this._activeMouseEvent=b;this._activeMouseTarget=a}};a._testMouseOver=function(){if(!(this.mouseX==this._mouseOverX&&this.mouseY==this._mouseOverY&&this.mouseInBounds)){var a=null;if(this.mouseInBounds)a=this._getObjectsUnderPoint(this.mouseX,this.mouseY,null,3),this._mouseOverX=this.mouseX,this._mouseOverY=this.mouseY;if(this._mouseOverTarget!=a){if(this._mouseOverTarget&&
this._mouseOverTarget.onMouseOut)this._mouseOverTarget.onMouseOut(new MouseEvent("onMouseOut",this.mouseX,this.mouseY,this._mouseOverTarget));if(a&&a.onMouseOver)a.onMouseOver(new MouseEvent("onMouseOver",this.mouseX,this.mouseY,a));this._mouseOverTarget=a}}};a._handleDoubleClick=function(a){if(this.onDoubleClick)this.onDoubleClick(new MouseEvent("onDoubleClick",this.mouseX,this.mouseY,this,a));var c=this._getObjectsUnderPoint(this.mouseX,this.mouseY,null,this._mouseOverIntervalID?3:1);if(c&&c.onDoubleClick instanceof
Function)c.onDoubleClick(new MouseEvent("onPress",this.mouseX,this.mouseY,c,a))};d.Stage=c})(window);(function(d){var c=function(a){this.initialize(a)},a=c.prototype=new DisplayObject;a.image=null;a.snapToPixel=true;a.DisplayObject_initialize=a.initialize;a.initialize=function(a){this.DisplayObject_initialize();typeof a=="string"?(this.image=new Image,this.image.src=a):this.image=a};a.isVisible=function(){return this.visible&&this.alpha>0&&this.scaleX!=0&&this.scaleY!=0&&this.image&&(this.image.complete||this.image.getContext||this.image.readyState==2)};a.DisplayObject_draw=a.draw;a.draw=function(a,
c){if(this.DisplayObject_draw(a,c))return true;a.drawImage(this.image,0,0);return true};a.clone=function(){var a=new c(this.image);this.cloneProps(a);return a};a.toString=function(){return"[Bitmap (name="+this.name+")]"};d.Bitmap=c})(window);(function(d){var c=function(a){this.initialize(a)},a=c.prototype=new DisplayObject;a.onAnimationEnd=null;a.currentFrame=-1;a.currentAnimation=null;a.paused=true;a.spriteSheet=null;a.snapToPixel=true;a.offset=0;a.currentAnimationFrame=0;a._advanceCount=0;a._animation=null;a.DisplayObject_initialize=a.initialize;a.initialize=function(a){this.DisplayObject_initialize();this.spriteSheet=a};a.isVisible=function(){return this.visible&&this.alpha>0&&this.scaleX!=0&&this.scaleY!=0&&this.spriteSheet.complete&&
this.currentFrame>=0};a.DisplayObject_draw=a.draw;a.draw=function(a,c){if(this.DisplayObject_draw(a,c))return true;this._normalizeFrame();var d=this.spriteSheet.getFrame(this.currentFrame);if(d!=null){var e=d.rect;a.drawImage(d.image,e.x,e.y,e.width,e.height,-d.regX,-d.regY,e.width,e.height);return true}};a.gotoAndPlay=function(a){this.paused=false;this._goto(a)};a.gotoAndStop=function(a){this.paused=true;this._goto(a)};a.advance=function(){this._animation?this.currentAnimationFrame++:this.currentFrame++;
this._normalizeFrame()};a.clone=function(){var a=new c(this.spriteSheet);this.cloneProps(a);return a};a.toString=function(){return"[BitmapAnimation (name="+this.name+")]"};a._tick=function(){var a=this._animation?this._animation.frequency:1;!this.paused&&(++this._advanceCount+this.offset)%a==0&&this.advance()};a._normalizeFrame=function(){var a=this._animation;if(a)if(this.currentAnimationFrame>=a.frames.length){if(a.next?this._goto(a.next):(this.paused=true,this.currentAnimationFrame=a.frames.length-
1,this.currentFrame=a.frames[this.currentAnimationFrame]),this.onAnimationEnd)this.onAnimationEnd(this,a.name)}else this.currentFrame=a.frames[this.currentAnimationFrame];else if(this.currentFrame>=this.spriteSheet.getNumFrames()&&(this.currentFrame=0,this.onAnimationEnd))this.onAnimationEnd(this,null)};a.DisplayObject_cloneProps=a.cloneProps;a.cloneProps=function(a){this.DisplayObject_cloneProps(a);a.onAnimationEnd=this.onAnimationEnd;a.currentFrame=this.currentFrame;a.currentAnimation=this.currentAnimation;
a.paused=this.paused;a.offset=this.offset;a._animation=this._animation;a.currentAnimationFrame=this.currentAnimationFrame};a._goto=function(a){if(isNaN(a)){var c=this.spriteSheet.getAnimation(a);if(c)this.currentAnimationFrame=0,this._animation=c,this.currentAnimation=a,this._normalizeFrame()}else this.currentAnimation=this._animation=null,this.currentFrame=a};d.BitmapAnimation=c})(window);(function(d){var c=function(a){this.initialize(a)},a=c.prototype=new DisplayObject;a.graphics=null;a.DisplayObject_initialize=a.initialize;a.initialize=function(a){this.DisplayObject_initialize();this.graphics=a?a:new Graphics};a.isVisible=function(){return this.visible&&this.alpha>0&&this.scaleX!=0&&this.scaleY!=0&&this.graphics};a.DisplayObject_draw=a.draw;a.draw=function(a,c){if(this.DisplayObject_draw(a,c))return true;this.graphics.draw(a);return true};a.clone=function(a){a=new c(a&&this.graphics?
this.graphics.clone():this.graphics);this.cloneProps(a);return a};a.toString=function(){return"[Shape (name="+this.name+")]"};d.Shape=c})(window);(function(d){var c=function(a,c,d){this.initialize(a,c,d)},a=c.prototype=new DisplayObject;c._workingContext=document.createElement("canvas").getContext("2d");a.text="";a.font=null;a.color=null;a.textAlign=null;a.textBaseline=null;a.maxWidth=null;a.outline=false;a.lineHeight=null;a.lineWidth=null;a.DisplayObject_initialize=a.initialize;a.initialize=function(a,c,d){this.DisplayObject_initialize();this.text=a;this.font=c;this.color=d?d:"#000"};a.isVisible=function(){return Boolean(this.visible&&this.alpha>
0&&this.scaleX!=0&&this.scaleY!=0&&this.text!=null&&this.text!="")};a.DisplayObject_draw=a.draw;a.draw=function(a,c){if(this.DisplayObject_draw(a,c))return true;this.outline?a.strokeStyle=this.color:a.fillStyle=this.color;a.font=this.font;a.textAlign=this.textAlign?this.textAlign:"start";a.textBaseline=this.textBaseline?this.textBaseline:"alphabetic";for(var d=String(this.text).split(/(?:\r\n|\r|\n)/),e=this.lineHeight==null?this.getMeasuredLineHeight():this.lineHeight,h=0,j=0,k=d.length;j<k;j++){var l=
a.measureText(d[j]).width;if(this.lineWidth==null||l<this.lineWidth)this._drawTextLine(a,d[j],h);else{for(var l=d[j].split(/(\s)/),m=l[0],q=1,r=l.length;q<r;q+=2)a.measureText(m+l[q]+l[q+1]).width>this.lineWidth?(this._drawTextLine(a,m,h),h+=e,m=l[q+1]):m+=l[q]+l[q+1];this._drawTextLine(a,m,h)}h+=e}return true};a.getMeasuredWidth=function(){return this._getWorkingContext().measureText(this.text).width};a.getMeasuredLineHeight=function(){return this._getWorkingContext().measureText("M").width*1.2};
a.clone=function(){var a=new c(this.text,this.font,this.color);this.cloneProps(a);return a};a.toString=function(){return"[Text (text="+(this.text.length>20?this.text.substr(0,17)+"...":this.text)+")]"};a.DisplayObject_cloneProps=a.cloneProps;a.cloneProps=function(a){this.DisplayObject_cloneProps(a);a.textAlign=this.textAlign;a.textBaseline=this.textBaseline;a.maxWidth=this.maxWidth;a.outline=this.outline;a.lineHeight=this.lineHeight;a.lineWidth=this.lineWidth};a._getWorkingContext=function(){var a=
c._workingContext;a.font=this.font;a.textAlign=this.textAlign?this.textAlign:"start";a.textBaseline=this.textBaseline?this.textBaseline:"alphabetic";return a};a._drawTextLine=function(a,c,d){this.outline?a.strokeText(c,0,d,this.maxWidth):a.fillText(c,0,d,this.maxWidth)};d.Text=c})(window);(function(d){var c=function(){throw"SpriteSheetUtils cannot be instantiated";};c._workingCanvas=document.createElement("canvas");c._workingContext=c._workingCanvas.getContext("2d");c.addFlippedFrames=function(a,b,d,g){if(b||d||g){var e=0;b&&c._flip(a,++e,true,false);d&&c._flip(a,++e,false,true);g&&c._flip(a,++e,true,true)}};c.extractFrame=function(a,b){isNaN(b)&&(b=a.getAnimation(b).frames[0]);var d=a.getFrame(b);if(!d)return null;var g=d.rect,e=c._workingCanvas;e.width=g.width;e.height=g.height;
c._workingContext.drawImage(d.image,g.x,g.y,g.width,g.height,0,0,g.width,g.height);d=new Image;d.src=e.toDataURL("image/png");return d};c._flip=function(a,b,d,g){for(var e=a._images,h=c._workingCanvas,j=c._workingContext,k=e.length/b,l=0;l<k;l++){var m=e[l];m.__tmp=l;h.width=m.width;h.height=m.height;j.setTransform(d?-1:1,0,0,g?-1:1,d?m.width:0,g?m.height:0);j.drawImage(m,0,0);var q=new Image;q.src=h.toDataURL("image/png");q.width=m.width;q.height=m.height;e.push(q)}j=a._frames;h=j.length/b;for(l=
0;l<h;l++){var m=j[l],r=m.rect.clone(),q=e[m.image.__tmp+k*b],u={image:q,rect:r,regX:m.regX,regY:m.regY};if(d)r.x=q.width-r.x-r.width,u.regX=r.width-m.regX;if(g)r.y=q.height-r.y-r.height,u.regY=r.height-m.regY;j.push(u)}d="_"+(d?"h":"")+(g?"v":"");g=a._animations;a=a._data;e=g.length/b;for(l=0;l<e;l++){j=g[l];m=a[j];k={name:j+d,frequency:m.frequency,next:m.next,frames:[]};m.next&&(k.next+=d);j=m.frames;m=0;for(q=j.length;m<q;m++)k.frames.push(j[m]+h*b);a[k.name]=k;g.push(k.name)}};d.SpriteSheetUtils=
c})(window);(function(d){var c=function(a){this.initialize(a)},a=c.prototype=new DisplayObject;a.htmlElement=null;a._style=null;a.DisplayObject_initialize=a.initialize;a.initialize=function(a){typeof a=="string"&&(a=document.getElementById(a));this.DisplayObject_initialize();this.mouseEnabled=false;if(this.htmlElement=a)this._style=a.style,this._style.position="absolute",this._style.transformOrigin=this._style.webkitTransformOrigin=this._style.MozTransformOrigin="0% 0%"};a.isVisible=function(){return this.htmlElement!=
null};a.draw=function(){if(this.htmlElement!=null){var a=this._matrix,c=this.htmlElement;c.style.opacity=""+a.alpha;c.style.visibility=this.visible?"visible":"hidden";c.style.transform=c.style.webkitTransform=c.style.oTransform=["matrix("+a.a,a.b,a.c,a.d,a.tx,a.ty+")"].join(",");c.style.MozTransform=["matrix("+a.a,a.b,a.c,a.d,a.tx+"px",a.ty+"px)"].join(",");return true}};a.cache=function(){};a.uncache=function(){};a.updateCache=function(){};a.hitTest=function(){};a.localToGlobal=function(){};a.globalToLocal=
function(){};a.localToLocal=function(){};a.clone=function(){var a=new c;this.cloneProps(a);return a};a.toString=function(){return"[DOMElement (name="+this.name+")]"};a._tick=function(){if(this.htmlElement!=null)this.htmlElement.style.visibility="hidden"};d.DOMElement=c})(window);(function(d){var c=function(){this.initialize()},a=c.prototype;a.initialize=function(){};a.getBounds=function(){return new Rectangle(0,0,0,0)};a.applyFilter=function(){};a.toString=function(){return"[Filter]"};a.clone=function(){return new c};d.Filter=c})(window);(function(d){var c=function(a,c,d){this.initialize(a,c,d)},a=c.prototype=new Filter;a.initialize=function(a,c,d){if(isNaN(a)||a<0)a=0;this.blurX=a|0;if(isNaN(c)||c<0)c=0;this.blurY=c|0;if(isNaN(d)||d<1)d=1;this.quality=d|0};a.blurX=0;a.blurY=0;a.quality=1;a.getBounds=function(){return new Rectangle(-this.blurX,-this.blurY,2*this.blurX,2*this.blurY)};a.applyFilter=function(a,c,d,e,h,j,k,l){j=j||a;k==null&&(k=c);l==null&&(l=d);try{var m=a.getImageData(c,d,e,h)}catch(q){return false}a=this.blurX;if(isNaN(a)||
a<0)return false;a|=0;var r=this.blurY;if(isNaN(r)||r<0)return false;r|=0;if(a==0&&r==0)return false;var u=this.quality;if(isNaN(u)||u<1)u=1;u|=0;u>3&&(u=3);u<1&&(u=1);for(var s=m.data,z,t,A,p,w,o,v,B,H=e-1,I=h-1,C=a+1,D=r+1,E=1/((a+C)*(r+D)),F=[],G=[],K=[],L=[],M=[],J=[];u-- >0;){for(d=B=v=0;d<h;d++){z=s[B]*C;t=s[B+1]*C;A=s[B+2]*C;p=s[B+3]*C;for(w=1;w<=a;w++)c=B+((w>H?H:w)<<2),z+=s[c++],t+=s[c++],A+=s[c++],p+=s[c];for(c=0;c<e;c++)F[v]=z,G[v]=t,K[v]=A,L[v]=p,d==0&&(M[c]=Math.min(c+C,H)<<2,J[c]=Math.max(c-
a,0)<<2),w=B+M[c],o=B+J[c],z+=s[w++]-s[o++],t+=s[w++]-s[o++],A+=s[w++]-s[o++],p+=s[w]-s[o],v++;B+=e<<2}for(c=0;c<e;c++){d=c;z=F[d]*D;t=G[d]*D;A=K[d]*D;p=L[d]*D;for(w=1;w<=r;w++)d+=w>I?0:e,z+=F[d],t+=G[d],A+=K[d],p+=L[d];v=c<<2;for(d=0;d<h;d++)s[v]=z*E+0.5|0,s[v+1]=t*E+0.5|0,s[v+2]=A*E+0.5|0,s[v+3]=p*E+0.5|0,c==0&&(M[d]=Math.min(d+D,I)*e,J[d]=Math.max(d-r,0)*e),w=c+M[d],o=c+J[d],z+=F[w]-F[o],t+=G[w]-G[o],A+=K[w]-K[o],p+=L[w]-L[o],v+=e<<2}}j.putImageData(m,k,l);return true};a.clone=function(){return new c(this.blurX,
this.blurY,this.quality)};a.toString=function(){return"[BoxBlurFilter (name="+this.name+")]"};d.BoxBlurFilter=c})(window);(function(d){var c=function(a,c,d,e,h,j,k,l){this.initialize(a,c,d,e,h,j,k,l)},a=c.prototype=new Filter;a.redMultiplier=1;a.greenMultiplier=1;a.blueMultiplier=1;a.alphaMultiplier=1;a.redOffset=0;a.greenOffset=0;a.blueOffset=0;a.alphaOffset=0;a.initialize=function(a,c,d,e,h,j,k,l){this.redMultiplier=a!=null?a:1;this.greenMultiplier=c!=null?c:1;this.blueMultiplier=d!=null?d:1;this.alphaMultiplier=e!=null?e:1;this.redOffset=h||0;this.greenOffset=j||0;this.blueOffset=k||0;this.alphaOffset=l||0};a.applyFilter=
function(a,c,d,e,h,j,k,l){j=j||a;k==null&&(k=c);l==null&&(l=d);try{var m=a.getImageData(c,d,e,h)}catch(q){return false}a=m.data;c=a.length;for(d=0;d<c;d+=4)a[d]=a[d]*this.redMultiplier+this.redOffset,a[d+1]=a[d+1]*this.greenMultiplier+this.greenOffset,a[d+2]=a[d+2]*this.blueMultiplier+this.blueOffset,a[d+3]=a[d+3]*this.alphaMultiplier+this.alphaOffset;m.data=a;j.putImageData(m,k,l);return true};a.toString=function(){return"[ColorFilter]"};a.clone=function(){return new c(this.redMultiplier,this.greenMultiplier,
this.blueMultiplier,this.alphaMultiplier,this.redOffset,this.greenOffset,this.blueOffset,this.alphaOffset)};d.ColorFilter=c})(window);(function(d){var c=function(a){this.initialize(a)},a=c.prototype=new Filter;a.matrix=null;a.initialize=function(a){this.matrix=a};a.applyFilter=function(a,c,d,e,h,j,k,l){j=j||a;k==null&&(k=c);l==null&&(l=d);try{var m=a.getImageData(c,d,e,h)}catch(q){return false}var a=m.data,c=a.length,r,u,s,z;r=this.matrix;for(var d=r[0],e=r[1],h=r[2],t=r[3],A=r[4],p=r[5],w=r[6],o=r[7],v=r[8],B=r[9],H=r[10],I=r[11],C=r[12],D=r[13],E=r[14],F=r[15],G=r[16],K=r[17],L=r[18],M=r[19],J=0;J<c;J+=4)r=a[J],u=a[J+1],s=a[J+
2],z=a[J+3],a[J]=r*d+u*e+s*h+z*t+A,a[J+1]=r*p+u*w+s*o+z*v+B,a[J+2]=r*H+u*I+s*C+z*D+E,a[J+3]=r*F+u*G+s*K+z*L+M;m.data=a;j.putImageData(m,k,l);return true};a.toString=function(){return"[ColorMatrixFilter]"};a.clone=function(){return new c(this.matrix)};d.ColorMatrixFilter=c})(window);(function(d){var c=function(){throw"Touch cannot be instantiated";};c.isSupported=function(){return"ontouchstart"in d};c.enable=function(a){if(a!=null&&c.isSupported())a._primaryTouchId=-1,a._handleTouchMoveListener=null,a.canvas.addEventListener("touchstart",function(b){c._handleTouchStart(a,b)},false),document.addEventListener("touchend",function(b){c._handleTouchEnd(a,b)},false)};c._handleTouchStart=function(a,b){b.preventDefault();if(a._primaryTouchId==-1){a._handleTouchMoveListener=a._handleTouchMoveListener||
function(b){c._handleTouchMove(a,b)};document.addEventListener("touchmove",a._handleTouchMoveListener,false);var d=b.changedTouches[0];a._primaryTouchId=d.identifier;a._updateMousePosition(d.pageX,d.pageY);a._handleMouseDown(d)}};c._handleTouchMove=function(a,b){var d=c._findPrimaryTouch(a,b.changedTouches);d&&a._handleMouseMove(d)};c._handleTouchEnd=function(a,b){var d=c._findPrimaryTouch(a,b.changedTouches);if(d)a._primaryTouchId=-1,a._handleMouseUp(d),document.removeEventListener("touchmove",a._handleTouchMoveListener),
a._handleTouchMoveListener=null};c._findPrimaryTouch=function(a,b){for(var c=b.length,d=0;d<c;d++){var e=b[d];if(e.identifier==a._primaryTouchId)return e}return null};d.Touch=c})(window);(function(){var d=false,c=/xyz/.test(function(){})?/\b_super\b/:/.*/;this.Class=function(){};Class.extend=function(a){function b(){!d&&this.init&&this.init.apply(this,arguments)}var f=this.prototype;d=true;var g=new this;d=false;for(var e in a)g[e]=typeof a[e]=="function"&&typeof f[e]=="function"&&c.test(a[e])?function(a,b){return function(){var c=this._super;this._super=f[a];var d=b.apply(this,arguments);this._super=c;return d}}(e,a[e]):a[e];b.prototype=g;b.constructor=b;b.extend=arguments.callee;
return b}})();var Edge=function(d,c,a){this.vertexOne=d;this.vertexTwo=c;this.pair=[d,c];this.attributes=a||{};return this};var Graph=function(){this.vertices={};return this};Graph.prototype.compare=function(d,c){return JSON.stringify(d)===JSON.stringify(c)};Graph.prototype.getVertices=function(){return this.vertices};Graph.prototype.getEdges=function(){var d=0,c=[],a;for(a in this.vertices){c[d]===void 0&&(c[d]={},c[d][a]=[]);for(var b in this.vertices[a].edges)c[d][a].push(b);++d}return c};Graph.prototype.hasVertex=function(d){return d in this.vertices};
Graph.prototype.addVertex=function(d){this.vertices[d.label]===void 0&&(this.vertices[d.label]=d)};Graph.prototype.addEdge=function(d){var c=d.vertexOne,d=d.vertexTwo;!(c in this.vertices[d].edges)&&!(d in this.vertices[c].edges)&&(this.vertices[c].edges[d]={},this.vertices[d].edges[c]={})};Graph.prototype.deleteVertex=function(d){delete this.vertices[d]};Graph.prototype.deleteEdge=function(d){delete this.vertices[d.vertexOne].edges[d.vertexTwo];delete this.vertices[d.vertexTwo].edges[d.vertexOne]};
Graph.prototype.hasEdge=function(d){var c=d.vertexOne,d=d.vertexTwo,a;for(a in this.vertices)if(a.edges[c]!==void 0&&a.edges[d]!==void 0)return true;return false};Graph.prototype.vertexOrder=function(d){var c=0,a;for(a in this.vertices){if(a.label==d)return c;++c}};var Vertex=function(d,c){this.label=d;this.edges={};this.attributes=c||{};return this};Vertex.prototype.getNeighbours=function(){return this.edges};Vertex.prototype.isNeighbourOf=function(d){return this.edges!==void 0&&d in this.edges?true:false};var Adjacency=function(d){this.vertices=d;this.matrix={};var c=this;this.build=function(a){var d={},a=a.getNeighbours(),g;for(g in c.vertices)d[g]=0,g in a&&(d[g]=1);return d};for(var a in d)c.matrix[a]=c.build(d[a]);return c.matrix};var DepthFirstSearch=function(d,c){this.vertices=d;this.visited={};this.spanningTree={};this.preorder=[];this.postorder=[];var a=this;this.search=function(b){if(typeof b==="undefined")return false;a.visited[b.label]=1;a.preorder.push(b.label);if(a.vertices[b.label]!==void 0)for(neighbour in a.vertices[b.label].getNeighbours())!(neighbour in a.visited)&&a.vertices[neighbour]!==void 0&&(a.spanningTree[neighbour]=a.vertices[neighbour],a.search(a.vertices[neighbour]));a.postorder.push(b.label)};if(c===
void 0)for(var b in d)b in a.visited||(a.spanningTree[b]=null,a.search(d[b]));else a.spanningTree[c]=null,a.search(d[c.label]);return{spanningTree:a.spanningTree,preorder:a.preorder,postorder:a.postorder}};var Dijkstra=function(d,c,a,b){this.dist=this.infinity=b||Infinity;this.graph=d;this.search=function(a){this.costs[a]=0;for(vertices in d);}};(function(){SimpleMaskContainer=function(){this.initialize()};var d=SimpleMaskContainer.prototype=new Container;d.canvas=null;d.rectangleMask=null;d._hitTestMask=function(c,a){var b=this.rectangleMask;return!b||c>b.x&&a>b.y&&c<b.x+b.width&&a<b.y+b.height?true:false};d.Container_getObjectsUnderPoint=d._getObjectsUnderPoint;d._getObjectsUnderPoint=function(c,a,b,d){return this._hitTestMask(c,a)?this.Container_getObjectsUnderPoint(c,a,b,d):null};d.Container_draw=d.draw;d.draw=function(c,a,b){var d=this.rectangleMask,
g=Stage._snapToPixelEnabled;b?b=b.clone():(b=new Matrix2D,b.appendProperties(this.alpha,this.shadow,this.compositeOperation));if(d){if(!this.canvas)this.canvas=document.createElement("canvas");this.canvas.width=d.width;this.canvas.height=d.height;var e=this.canvas.getContext("2d"),h=new Matrix2D;h.translate(-d.x,-d.y);this.Container_draw(e,a,h);a=new Bitmap;a.image=this.canvas;g&&a.snapToPixel&&b.a==1&&b.b==0&&b.c==0&&b.d==1?c.setTransform(b.a,b.b,b.c,b.d,b.tx+0.5|0,b.ty+0.5|0):c.setTransform(b.a,
b.b,b.c,b.d,b.tx,b.ty);c.translate(d.x,d.y);a.draw(c,false,b.clone())}else this.Container_draw(c,a,b.clone());return true}})(window);(function(d){Tween=function(a,b){this.initialize(a,b)};var c=Tween.prototype;Tween.NONE=0;Tween.LOOP=1;Tween.REVERSE=2;Tween._tweens=[];Tween.cssSuffixMap={top:"px",left:"px",bottom:"px",right:"px",width:"px",height:"px",opacity:""};Tween.get=function(a,b){return new Tween(a,b)};Tween.tick=function(a,b){for(var c=Tween._tweens,d=c.length-1;d>=0;d--){var e=c[d];if(!b||e.ignoreGlobalPause)e.tick(e._useTicks?1:a)}};Ticker&&Ticker.addListener(Tween,false);Tween.removeTweens=function(a){if(a.tweenjs_count){for(var b=
Tween._tweens,c=b.length-1;c>=0;c--)b[c]._target==a&&b.splice(c,1);a.tweenjs_count=0}};Tween._register=function(a,b){var c=a._target;if(b){if(c)c.tweenjs_count=c.tweenjs_count?c.tweenjs_count+1:1;Tween._tweens.push(a)}else c&&c.tweenjs_count--,c=Tween._tweens.indexOf(a),c!=-1&&Tween._tweens.splice(c,1)};c.ignoreGlobalPause=false;c.loop=false;c.cssSuffixMap=null;c.duration=0;c._paused=false;c._curQueueProps=null;c._initQueueProps=null;c._steps=null;c._actions=null;c._prevPosition=0;c._prevPos=-1;c._prevIndex=
-1;c._target=null;c._css=false;c._useTicks=false;c.initialize=function(a,b){this._target=a;if(b)this._useTicks=b.useTicks,this._css=b.css,this.ignoreGlobalPause=b.ignoreGlobalPause,this.loop=b.loop,b.override&&Tween.removeTweens(a);this._curQueueProps={};this._initQueueProps={};this._steps=[];this._actions=[];this._catalog=[];Tween._register(this,true)};c.wait=function(a){if(a==null||a<=0)return this;var b=this._cloneProps(this._curQueueProps);return this._addStep({d:a,p0:b,e:this._linearEase,p1:b})};
c.to=function(a,b,c){if(isNaN(b)||b<0)b=0;return this._addStep({d:b||0,p0:this._cloneProps(this._curQueueProps),e:c,p1:this._cloneProps(this._appendQueueProps(a))})};c.call=function(a,b,c){return this._addAction({f:a,p:b?b:[this],o:c?c:this._target})};c.set=function(a,b){return this._addAction({f:this._set,o:this,p:[a,b?b:this._target]})};c.play=function(a){return this.call(a.setPaused,[false],a)};c.pause=function(a){a||(a=this);return this.call(a.setPaused,[true],a)};c.setPosition=function(a,b){b==
null&&(b=1);var c=a,d=false;if(c>=this.duration)this.loop?c%=this.duration:(c=this.duration,d=true);if(c==this._prevPos)return d;if(c!=this._prevPos)if(d)this._updateTargetProps(null,1);else if(this._steps.length>0){for(var e=0,h=this._steps.length;e<h;e++)if(this._steps[e].t>c)break;e=this._steps[e-1];this._updateTargetProps(e,(c-e.t)/e.d)}e=this._prevPos;this._prevPos=c;this._prevPosition=a;b!=0&&this._actions.length>0&&(this._useTicks?this._runActions(c,c):b==1&&c<e?(e!=this.duration&&this._runActions(e,
this.duration),this._runActions(0,c,true)):this._runActions(e,c));d&&this.setPaused(true);return d};c.tick=function(a){this._paused||this.setPosition(this._prevPosition+a)};c.setPaused=function(a){if(this._paused!=!!a)this._paused=!!a,Tween._register(this,!a)};c.w=c.wait;c.t=c.to;c.c=c.call;c.s=c.set;c.toString=function(){return"[Tween]"};c.clone=function(){throw"Tween can not be cloned.";};c._updateTargetProps=function(a,b){if(this._css)var c=this.cssSuffixMap||Tween.cssSuffixMap;var d,e,h,j;!a&&
b==1?d=e=this._curQueueProps:(a.e&&(b=a.e(b,0,1,1)),d=a.p0,e=a.p1);for(n in this._initQueueProps){if((h=d[n])==null)d[n]=h=this._initQueueProps[n];if((j=e[n])==null)e[n]=j=h;h==j||b==0||b==1||typeof h!="number"?b==1&&(h=j):h+=(j-h)*b;this._target[n]=c&&c[n]?h+c[n]:h}};c._runActions=function(a,b,c){var d=a,e=b,h=-1,j=this._actions.length,k=1;a>b&&(d=b,e=a,h=j,j=k=-1);for(;(h+=k)!=j;){var b=this._actions[h],l=b.t;(l==e||l>d&&l<e||c&&l==a)&&b.f.apply(b.o,b.p)}};c._appendQueueProps=function(a){if(this._css)var b=
this.cssSuffixMap||Tween.cssSuffixMap;var c,d,e;for(e in a){if(this._initQueueProps[e]==null)if(b&&(c=b[e])!=null){var h=this._target[e],j=h.length-c.length;if((d=h.substr(j))!=c)throw"TweenJS Error: Suffixes do not match. ("+c+":"+d+")";else this._initQueueProps[e]=parseInt(h.substr(0,j))}else this._initQueueProps[e]=this._target[e];this._curQueueProps[e]=a[e]}return this._curQueueProps};c._cloneProps=function(a){var b={},c;for(c in a)b[c]=a[c];return b};c._addStep=function(a){if(a.d>0)this._steps.push(a),
a.t=this.duration,this.duration+=a.d;return this};c._addAction=function(a){a.t=this.duration;this._actions.push(a);return this};c._set=function(a,b){for(var c in a)b[c]=a[c]};d.Tween=Tween})(window);(function(d){var c=function(){throw"Ease cannot be instantiated.";};c.linear=function(a){return a};c.none=c.linear;c.get=function(a){a<-1&&(a=-1);a>1&&(a=1);return function(b){return a==0?b:a<0?b*(b*-a+1+a):b*((2-b)*a+(1-a))}};c.getPowIn=function(a){return function(b){return Math.pow(b,a)}};c.getPowOut=function(a){return function(b){return 1-Math.pow(1-b,a)}};c.getPowInOut=function(a){return function(b){return(b*=2)<1?0.5*Math.pow(b,a):1-0.5*Math.abs(Math.pow(2-b,a))}};c.quadIn=c.getPowIn(2);c.quadOut=
c.getPowOut(2);c.quadInOut=c.getPowInOut(2);c.cubicIn=c.getPowIn(3);c.cubicOut=c.getPowOut(3);c.cubicInOut=c.getPowInOut(3);c.quartIn=c.getPowIn(4);c.quartOut=c.getPowOut(4);c.quartInOut=c.getPowInOut(4);c.quintIn=c.getPowIn(5);c.quintOut=c.getPowOut(5);c.quintInOut=c.getPowInOut(5);c.sineIn=function(a){return 1-Math.cos(a*Math.PI/2)};c.sineOut=function(a){return Math.sin(a*Math.PI/2)};c.sineInOut=function(a){return-0.5*(Math.cos(Math.PI*a)-1)};c.getBackIn=function(a){return function(b){return b*
b*((a+1)*b-a)}};c.backIn=c.getBackIn(1.7);c.getBackOut=function(a){return function(b){return--b*b*((a+1)*b+a)+1}};c.backOut=c.getBackOut(1.7);c.getBackInOut=function(a){a*=1.525;return function(b){return(b*=2)<1?0.5*b*b*((a+1)*b-a):0.5*((b-=2)*b*((a+1)*b+a)+2)}};c.backInOut=c.getBackInOut(1.7);c.circIn=function(a){return-(Math.sqrt(1-a*a)-1)};c.circOut=function(a){return Math.sqrt(1- --a*a)};c.circInOut=function(a){return(a*=2)<1?-0.5*(Math.sqrt(1-a*a)-1):0.5*(Math.sqrt(1-(a-=2)*a)+1)};c.bounceIn=
function(a){return 1-c.bounceOut(1-a)};c.bounceOut=function(a){return a<1/2.75?7.5625*a*a:a<2/2.75?7.5625*(a-=1.5/2.75)*a+0.75:a<2.5/2.75?7.5625*(a-=2.25/2.75)*a+0.9375:7.5625*(a-=2.625/2.75)*a+0.984375};c.bounceInOut=function(a){return a<0.5?c.bounceIn(a*2)*0.5:c.bounceOut(a*2-1)*0.5+0.5};c.getElasticIn=function(a,b){var c=Math.PI*2;return function(d){if(d==0||d==1)return d;var e=b/c*Math.asin(1/a);return-(a*Math.pow(2,10*(d-=1))*Math.sin((d-e)*c/b))}};c.elasticIn=c.getElasticIn(1,0.3);c.getElasticOut=
function(a,b){var c=Math.PI*2;return function(d){if(d==0||d==1)return d;var e=b/c*Math.asin(1/a);return a*Math.pow(2,-10*d)*Math.sin((d-e)*c/b)+1}};c.elasticOut=c.getElasticOut(1,0.3);c.getElasticInOut=function(a,b){var c=Math.PI*2;return function(d){var e=b/c*Math.asin(1/a);return(d*=2)<1?-0.5*a*Math.pow(2,10*(d-=1))*Math.sin((d-e)*c/b):a*Math.pow(2,-10*(d-=1))*Math.sin((d-e)*c/b)*0.5+1}};c.elasticInOut=c.getElasticInOut(1,0.3*1.5);d.Ease=c})(window);function Bezier(d){this.points=d;this.order=d.length}function distance(d,c){var a=c.x-d.x,b=c.y-d.y;return Math.sqrt(a*a+b*b)}Bezier.prototype._triangle=function(){for(var d=this.points,c=[d],a=1;a<this.order;a++){for(var b=[],f=0;f<this.order-a;f++){var g=d[f],e=d[f+1];b[f]={x:(g.x+e.x)/2,y:(g.y+e.y)/2}}c.push(b);d=b}return(this._triangle=function(){return c})()};
Bezier.prototype.split=function(){for(var d=this._triangle(),c=Array(this.order),a=Array(this.order),b=0;b<this.order;b++)c[b]=d[b][0],a[b]=d[this.order-1-b][b];return[new Bezier(c),new Bezier(a)]};Bezier.prototype.midpointT=function(){return this.atT(0.5)};
Bezier.prototype.getCoefficients=function(){function d(a){for(;a.length>1;){for(var b=Array(a.length-1),c=0;c<a.length-1;c++){var d=b,f=c,g=a[c],q=a[c+1];g.push(0);var r=Array(g.length);r[0]=g[0];for(var u=0;u<q.length;u++)r[u+1]=g[u+1]+q[u]-g[u];d[f]=r}a=b}return a[0]}for(var c=[],a=[],b=0,f;f=this.points[b++];)c.push([f.x]),a.push([f.y]);var g={xs:d(c),ys:d(a)};return(this.getCoefficients=function(){return g})()};
Bezier.prototype.atT=function(d){for(var c=this.getCoefficients(),a=c.xs,c=c.ys,b=a[a.length-1],f=c[c.length-1],g=a.length-1;--g>=0;)b=b*d+a[g],f=f*d+c[g];return{x:b,y:f}};Bezier.prototype.measureLength=function(d){arguments.length<1&&(d=1);var c=0,a=[this];do{for(var b=a.pop(),f=b.points,g=distance(f[0],f[this.order-1]),e=0,h=0;h<this.order-1;h++)e+=distance(f[h],f[h+1]);e-g<=d?c+=e:a=a.concat(b.split())}while(a.length);return(this.measureLength=function(){return c})()};
Bezier.prototype.draw=function(d){var c=this.points;d.moveTo(c[0].x,c[0].y);var a=Bezier.drawCommands[this.order];if(a){for(var b=[],f=c.length?1:0;f<c.length;f++)b.push(c[f].x),b.push(c[f].y);a.apply(d,b)}else error("don't know how to draw an order *"+this.order+" bezier")};Bezier.drawCommands=[null,function(d,c){this.lineTo(d,c)},function(d,c){this.lineTo(d,c)},function(d,c,a,b){this.quadraticCurveTo(d,c,a,b)},function(d,c,a,b,f,g){this.bezierCurveTo(d,c,a,b,f,g)}];function Path(d){this.segments=d||[]}Path.prototype.resetMetrics=function(){this.measureLength=Path.prototype.measureLength};Path.prototype.measureLength=function(){for(var d=0,c=0,a;a=this.segments[c++];)d+=a.measureLength();return(this.measureLength=function(){return d})()};Path.prototype.atT=function(d){d*=this.measureLength();for(var c=0,a=this.segments[c++];d>a.measureLength()&&c<this.segments.length;)d-=a.measureLength(),a=this.segments[c++];return a.atT(d/a.measureLength())};
Path.prototype.draw=function(d){for(var c=0,a;a=this.segments[c++];)a.draw(d)};Path.prototype.addBezier=function(d){this.segments.push(new Path.Bezier(d));this.resetMetrics()};Path.Bezier=function(d){this.bezier=d instanceof Array?new Bezier(d):d};Path.Bezier.prototype.atT=function(d){return this.bezier.atT(d)};Path.Bezier.prototype.measureLength=function(){var d=this.bezier.measureLength();return(this.measureLength=function(){return d})()};Path.Bezier.prototype.draw=function(d){this.bezier.draw(d)};
Path.prototype.addLine=function(d,c){this.segments.push(new Path.Line([d,c]));this.resetMetrics()};Path.Line=function(d){this.points=d};Path.Line.prototype.measureLength=function(){var d=distance.apply(null,this.points);return(this.measureLength=function(){return d})()};Path.Line.prototype.atT=function(d){var c=this.points[0],a=this.points[1];return{x:c.x+(a.x-c.x)*d,y:c.y+(a.y-c.y)*d}};Path.Line.prototype.draw=function(d){var c=this.points;d.moveTo(c[0].x,c[0].y);d.lineTo(c[1].x,c[1].y)};function Point2D(d,c){if(arguments.length>0)this.x=d,this.y=c}Point2D.prototype.clone=function(){return new Point2D(this.x,this.y)};Point2D.prototype.add=function(d){return new Point2D(this.x+d.x,this.y+d.y)};Point2D.prototype.addEquals=function(d){this.x+=d.x;this.y+=d.y;return this};
Point2D.prototype.offset=function(d,c){var a=0;if(!(c.x<=this.x||this.x+d.x<=0)){var b;c.x*d.y-d.x*c.y>0?this.x<0?(b=this.x*d.y,b=b/d.x-this.y):this.x>0?(b=this.x*c.y,b=b/c.x-this.y):b=-this.y:c.x<this.x+d.x?(b=(c.x-this.x)*d.y,b=c.y-(this.y+b/d.x)):c.x>this.x+d.x?(b=(d.x+this.x)*c.y,b=b/c.x-(this.y+d.y)):b=c.y-(this.y+d.y);b>0&&(a=b)}return a};Point2D.prototype.rmoveto=function(d,c){this.x+=d;this.y+=c};Point2D.prototype.scalarAdd=function(d){return new Point2D(this.x+d,this.y+d)};
Point2D.prototype.scalarAddEquals=function(d){this.x+=d;this.y+=d;return this};Point2D.prototype.subtract=function(d){return new Point2D(this.x-d.x,this.y-d.y)};Point2D.prototype.subtractEquals=function(d){this.x-=d.x;this.y-=d.y;return this};Point2D.prototype.scalarSubtract=function(d){return new Point2D(this.x-d,this.y-d)};Point2D.prototype.scalarSubtractEquals=function(d){this.x-=d;this.y-=d;return this};Point2D.prototype.multiply=function(d){return new Point2D(this.x*d,this.y*d)};
Point2D.prototype.multiplyEquals=function(d){this.x*=d;this.y*=d;return this};Point2D.prototype.divide=function(d){return new Point2D(this.x/d,this.y/d)};Point2D.prototype.divideEquals=function(d){this.x/=d;this.y/=d;return this};Point2D.prototype.compare=function(d){return this.x-d.x||this.y-d.y};Point2D.prototype.eq=function(d){return this.x==d.x&&this.y==d.y};Point2D.prototype.lt=function(d){return this.x<d.x&&this.y<d.y};Point2D.prototype.lte=function(d){return this.x<=d.x&&this.y<=d.y};
Point2D.prototype.gt=function(d){return this.x>d.x&&this.y>d.y};Point2D.prototype.gte=function(d){return this.x>=d.x&&this.y>=d.y};Point2D.prototype.lerp=function(d,c){return new Point2D(this.x+(d.x-this.x)*c,this.y+(d.y-this.y)*c)};Point2D.prototype.distanceFrom=function(d){var c=this.x-d.x,d=this.y-d.y;return Math.sqrt(c*c+d*d)};Point2D.prototype.min=function(d){return new Point2D(Math.min(this.x,d.x),Math.min(this.y,d.y))};
Point2D.prototype.max=function(d){return new Point2D(Math.max(this.x,d.x),Math.max(this.y,d.y))};Point2D.prototype.toString=function(){return this.x+","+this.y};Point2D.prototype.setXY=function(d,c){this.x=d;this.y=c};Point2D.prototype.setFromPoint=function(d){this.x=d.x;this.y=d.y};Point2D.prototype.swap=function(d){var c=this.x,a=this.y;this.x=d.x;this.y=d.y;d.x=c;d.y=a};
Point2D.prototype.rotate=function(d,c){var a=Math.PI/180*(+d||0);this.x-=c.x;this.y-=c.y;var b=this.x*Math.cos(a)-this.y*Math.sin(a),a=this.x*Math.sin(a)+this.y*Math.cos(a);this.x=b+c.x;this.y=a+c.y};Point2D.prototype.closeTo=function(d,c){return Math.abs(this.x-d.x)<c&&Math.abs(this.y-d.y)<c};
Point2D.prototype.getAngle=function(d,c){var a,b;a=new Point2D(this.x,this.y);b=new Point2D(d.x,d.y);var f,g;f=new Point2D(this.x,this.y);g=new Point2D(c.x,c.y);var e=b.x-a.x;a=b.y-a.y;b=f.x-g.x;f=f.y-g.y;g=Math.sqrt(e*e+a*a);var h=Math.sqrt(b*b+f*f);e/=g;a/=g;b/=h;f/=h;return(Math.atan2(f,b)-Math.atan2(a,e))/(Math.PI*2/360)};function Vector2D(d,c){if(arguments.length>0)this.x=d,this.y=c}Vector2D.prototype.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y)};Vector2D.prototype.dot=function(d){return this.x*d.x+this.y*d.y};Vector2D.prototype.cross=function(d){return this.x*d.y-this.y*d.x};Vector2D.prototype.unit=function(){return this.divide(this.length())};Vector2D.prototype.unitEquals=function(){this.divideEquals(this.length());return this};
Vector2D.prototype.add=function(d){return new Vector2D(this.x+d.x,this.y+d.y)};Vector2D.prototype.addEquals=function(d){this.x+=d.x;this.y+=d.y;return this};Vector2D.prototype.subtract=function(d){return new Vector2D(this.x-d.x,this.y-d.y)};Vector2D.prototype.subtractEquals=function(d){this.x-=d.x;this.y-=d.y;return this};Vector2D.prototype.multiply=function(d){return new Vector2D(this.x*d,this.y*d)};Vector2D.prototype.multiplyEquals=function(d){this.x*=d;this.y*=d;return this};
Vector2D.prototype.divide=function(d){return new Vector2D(this.x/d,this.y/d)};Vector2D.prototype.divideEquals=function(d){this.x/=d;this.y/=d;return this};Vector2D.prototype.perp=function(){return new Vector2D(-this.y,this.x)};Vector2D.prototype.perpendicular=function(d){return this.subtract(this.project(d))};Vector2D.prototype.project=function(d){var c=this.dot(d)/d.dot(d);return d.multiply(c)};Vector2D.prototype.toString=function(){return this.x+","+this.y};
Vector2D.fromPoints=function(d,c){return new Vector2D(c.x-d.x,c.y-d.y)};Polynomial.TOLERANCE=1.0E-6;Polynomial.ACCURACY=6;
Polynomial.interpolate=function(d,c,a,b,f){if(d.constructor!==Array||c.constructor!==Array)throw Error("Polynomial.interpolate: xs and ys must be arrays");if(isNaN(a)||isNaN(b)||isNaN(f))throw Error("Polynomial.interpolate: n, offset, and x must be numbers");for(var g=0,e=0,h=Array(a),j=Array(a),k=0,g=Math.abs(f-d[b]),l=0;l<a;l++){var m=Math.abs(f-d[b+l]);m<g&&(k=l,g=m);h[l]=j[l]=c[b+l]}g=c[b+k];k--;for(c=1;c<a;c++){for(l=0;l<a-c;l++){var e=d[b+l]-f,m=d[b+l+c]-f,q=e-m;if(q==0)break;q=(h[l+1]-j[l])/
q;j[l]=m*q;h[l]=e*q}e=2*(k+1)<a-c?h[k+1]:j[k--];g+=e}return{y:g,dy:e}};function Polynomial(){this.init(arguments)}Polynomial.prototype.init=function(d){this.coefs=[];for(var c=d.length-1;c>=0;c--)this.coefs.push(d[c]);this._variable="t";this._s=0};Polynomial.prototype.eval=function(d){if(isNaN(d))throw Error("Polynomial.eval: parameter must be a number");for(var c=0,a=this.coefs.length-1;a>=0;a--)c=c*d+this.coefs[a];return c};
Polynomial.prototype.add=function(d){for(var c=new Polynomial,a=this.getDegree(),b=d.getDegree(),f=Math.max(a,b),g=0;g<=f;g++)c.coefs[g]=(g<=a?this.coefs[g]:0)+(g<=b?d.coefs[g]:0);return c};Polynomial.prototype.multiply=function(d){for(var c=new Polynomial,a=0;a<=this.getDegree()+d.getDegree();a++)c.coefs.push(0);for(a=0;a<=this.getDegree();a++)for(var b=0;b<=d.getDegree();b++)c.coefs[a+b]+=this.coefs[a]*d.coefs[b];return c};
Polynomial.prototype.divide_scalar=function(d){for(var c=0;c<this.coefs.length;c++)this.coefs[c]/=d};Polynomial.prototype.simplify=function(){for(var d=this.getDegree();d>=0;d--)if(Math.abs(this.coefs[d])<=Polynomial.TOLERANCE)this.coefs.pop();else break};
Polynomial.prototype.bisection=function(d,c){var a=this.eval(d),b=this.eval(c),f;if(Math.abs(a)<=Polynomial.TOLERANCE)f=d;else if(Math.abs(b)<=Polynomial.TOLERANCE)f=c;else if(a*b<=0)for(var b=Math.log(c-d),b=Math.ceil((b+Math.LN10*Polynomial.ACCURACY)/Math.LN2),g=0;g<b;g++){f=0.5*(d+c);var e=this.eval(f);if(Math.abs(e)<=Polynomial.TOLERANCE)break;e*a<0?c=f:(d=f,a=e)}return f};
Polynomial.prototype.toString=function(){for(var d=[],c=[],a=this.coefs.length-1;a>=0;a--){var b=Math.round(this.coefs[a]*1E3)/1E3;if(b!=0){var f=b<0?" - ":" + ",b=Math.abs(b);if(a>0)b==1?b=this._variable:b+=this._variable;a>1&&(b+="^"+a);c.push(f);d.push(b)}}c[0]=c[0]==" + "?"":"-";b="";for(a=0;a<d.length;a++)b+=c[a]+d[a];return b};
Polynomial.prototype.trapezoid=function(d,c,a){if(isNaN(d)||isNaN(c)||isNaN(a))throw Error("Polynomial.trapezoid: parameters must be numbers");var b=c-d;if(a==1)a=this.eval(d),c=this.eval(c),this._s=0.5*b*(a+c);else{c=1<<a-2;a=b/c;d+=0.5*a;for(var f=0,g=0;g<c;g++)f+=this.eval(d),d+=a;this._s=0.5*(this._s+b*f/c)}if(isNaN(this._s))throw Error("Polynomial.trapezoid: this._s is NaN");return this._s};
Polynomial.prototype.simpson=function(d,c){if(isNaN(d)||isNaN(c))throw Error("Polynomial.simpson: parameters must be numbers");for(var a=c-d,b=0.5*a*(this.eval(d)+this.eval(c)),f=b,g=4*b/3,e=g,h=b,j=1,k=2;k<=20;k++){for(var b=a/j,g=d+0.5*b,l=0,m=1;m<=j;m++)l+=this.eval(g),g+=b;b=f=0.5*(f+a*l/j);g=(4*b-h)/3;if(Math.abs(g-e)<1.0E-7*Math.abs(e))break;e=g;h=b;j<<=1}return g};
Polynomial.prototype.romberg=function(d,c){if(isNaN(d)||isNaN(c))throw Error("Polynomial.romberg: parameters must be numbers");for(var a=Array(21),b=Array(21),f={y:0,dy:0},g=b[0]=1;g<=20;g++){a[g-1]=this.trapezoid(d,c,g);if(g>=3&&(f=Polynomial.interpolate(b,a,3,g-3,0),Math.abs(f.dy)<=1.0E-6*f.y))break;a[g]=a[g-1];b[g]=0.25*b[g-1]}return f.y};Polynomial.prototype.getDegree=function(){return this.coefs.length-1};
Polynomial.prototype.getDerivative=function(){for(var d=new Polynomial,c=1;c<this.coefs.length;c++)d.coefs.push(c*this.coefs[c]);return d};Polynomial.prototype.getRoots=function(){var d;this.simplify();switch(this.getDegree()){case 0:d=[];break;case 1:d=this.getLinearRoot();break;case 2:d=this.getQuadraticRoots();break;case 3:d=this.getCubicRoots();break;case 4:d=this.getQuarticRoots();break;default:d=[]}return d};
Polynomial.prototype.getRootsInInterval=function(d,c){var a=[],b;if(this.getDegree()==1)b=this.bisection(d,c);else{var f=this.getDerivative().getRootsInInterval(d,c);if(f.length>0){b=this.bisection(d,f[0]);b!=null&&a.push(b);for(i=0;i<=f.length-2;i++)b=this.bisection(f[i],f[i+1]),b!=null&&a.push(b);b=this.bisection(f[f.length-1],c)}else b=this.bisection(d,c)}b!=null&&a.push(b);return a};Polynomial.prototype.getLinearRoot=function(){var d=[],c=this.coefs[1];c!=0&&d.push(-this.coefs[0]/c);return d};
Polynomial.prototype.getQuadraticRoots=function(){var d=[];if(this.getDegree()==2){var c=this.coefs[2],a=this.coefs[1]/c,c=a*a-4*(this.coefs[0]/c);c>0?(c=Math.sqrt(c),d.push(0.5*(-a+c)),d.push(0.5*(-a-c))):c==0&&d.push(0.5*-a)}return d};
Polynomial.prototype.getCubicRoots=function(){var d=[];if(this.getDegree()==3){var c=this.coefs[3],a=this.coefs[2]/c,b=this.coefs[1]/c,f=(3*b-a*a)/3,c=(2*a*a*a-9*b*a+27*(this.coefs[0]/c))/27;a/=3;b=c*c/4+f*f*f/27;c/=2;Math.abs(b)<=Polynomial.TOLERANCE&&(disrim=0);if(b>0){var f=Math.sqrt(b),g,b=-c+f;g=b>=0?Math.pow(b,1/3):-Math.pow(-b,1/3);b=-c-f;b>=0?g+=Math.pow(b,1/3):g-=Math.pow(-b,1/3);d.push(g-a)}else b<0?(f=Math.sqrt(-f/3),b=Math.atan2(Math.sqrt(-b),-c)/3,c=Math.cos(b),b=Math.sin(b),g=Math.sqrt(3),
d.push(2*f*c-a),d.push(-f*(c+g*b)-a),d.push(-f*(c-g*b)-a)):(b=c>=0?-Math.pow(c,1/3):Math.pow(-c,1/3),d.push(2*b-a),d.push(-b-a))}return d};
Polynomial.prototype.getQuarticRoots=function(){var d=[];if(this.getDegree()==4){var c=this.coefs[4],a=this.coefs[3]/c,b=this.coefs[2]/c,f=this.coefs[1]/c,c=this.coefs[0]/c,g=(new Polynomial(1,-b,a*f-4*c,-a*a*c+4*b*c-f*f)).getCubicRoots()[0],e=a*a/4-b+g;Math.abs(e)<=Polynomial.TOLERANCE&&(e=0);e>0?(c=Math.sqrt(e),g=3*a*a/4-c*c-2*b,f=(4*a*b-8*f-a*a*a)/(4*c),b=g+f,f=g-f,Math.abs(b)<=Polynomial.TOLERANCE&&(b=0),Math.abs(f)<=Polynomial.TOLERANCE&&(f=0),b>=0&&(b=Math.sqrt(b),d.push(-a/4+(c+b)/2),d.push(-a/
4+(c-b)/2)),f>=0&&(b=Math.sqrt(f),d.push(-a/4+(b-c)/2),d.push(-a/4-(b+c)/2))):e<0||(f=g*g-4*c,f>=-Polynomial.TOLERANCE&&(f<0&&(f=0),f=2*Math.sqrt(f),g=3*a*a/4-2*b,g+f>=Polynomial.TOLERANCE&&(b=Math.sqrt(g+f),d.push(-a/4+b/2),d.push(-a/4-b/2)),g-f>=Polynomial.TOLERANCE&&(b=Math.sqrt(g-f),d.push(-a/4+b/2),d.push(-a/4-b/2))))}return d};function Intersection(d){arguments.length>0&&this.init(d)}Intersection.prototype.init=function(d){this.status=d;this.points=[]};Intersection.prototype.appendPoint=function(d){this.points.push(d)};Intersection.prototype.appendPoints=function(d){this.points=this.points.concat(d)};
Intersection.intersectShapes=function(d,c){var a=d.getIntersectionParams(),b=c.getIntersectionParams(),f;if(a!=null&&b!=null)if(a.name=="Path")f=Intersection.intersectPathShape(d,c);else if(b.name=="Path")f=Intersection.intersectPathShape(c,d);else{a.name<b.name?(f="intersect"+a.name+b.name,a=a.params.concat(b.params)):(f="intersect"+b.name+a.name,a=b.params.concat(a.params));if(!(f in Intersection))throw Error("Intersection not available: "+f);f=Intersection[f].apply(null,a)}else f=new Intersection("No Intersection");
return f};Intersection.intersectPathShape=function(d,c){return d.intersectShape(c)};
Intersection.intersectBezier2Bezier2=function(d,c,a,b,f,g){var e,h,j=new Intersection("No Intersection");e=c.multiply(-2);a=d.add(e.add(a));e=d.multiply(-2);h=c.multiply(2);c=e.add(h);d=new Point2D(d.x,d.y);e=f.multiply(-2);g=b.add(e.add(g));e=b.multiply(-2);h=f.multiply(2);f=e.add(h);b=new Point2D(b.x,b.y);e=a.x*c.y-c.x*a.y;h=g.x*c.y-c.x*g.y;var k=g.x*a.y-a.x*g.y,l=f.x*a.y-a.x*f.y,m=a.x*(d.y-b.y)+a.y*(-d.x+b.x);e=(new Polynomial(-k*k,-2*k*l,e*h-l*l-2*k*m,e*(f.x*c.y-c.x*f.y)-2*l*m,e*(c.x*(d.y-b.y)+
c.y*(-d.x+b.x))-m*m)).getRoots();for(h=0;h<e.length;h++)if(k=e[h],0<=k&&k<=1&&(l=(new Polynomial(-a.x,-c.x,-d.x+b.x+k*f.x+k*k*g.x)).getRoots(),m=(new Polynomial(-a.y,-c.y,-d.y+b.y+k*f.y+k*k*g.y)).getRoots(),l.length>0&&m.length>0)){var q=0;a:for(;q<l.length;q++){var r=l[q];if(0<=r&&r<=1)for(var u=0;u<m.length;u++)if(Math.abs(r-m[u])<1.0E-4){j.points.push(g.multiply(k*k).add(f.multiply(k).add(b)));break a}}}return j};
Intersection.intersectBezier2Bezier3=function(d,c,a,b,f,g,e){var h,j,k,l=new Intersection("No Intersection");h=c.multiply(-2);a=d.add(h.add(a));h=d.multiply(-2);j=c.multiply(2);c=h.add(j);d=new Point2D(d.x,d.y);h=b.multiply(-1);j=f.multiply(3);k=g.multiply(-3);h=h.add(j.add(k.add(e)));e=new Vector2D(h.x,h.y);h=b.multiply(3);j=f.multiply(-6);k=g.multiply(3);h=h.add(j.add(k));g=new Vector2D(h.x,h.y);h=b.multiply(-3);j=f.multiply(3);k=h.add(j);f=new Vector2D(k.x,k.y);b=new Vector2D(b.x,b.y);h=c.x*c.x;
j=c.y*c.y;k=a.x*a.x;var m=a.y*a.y;h=(new Polynomial(-2*a.x*a.y*e.x*e.y+k*e.y*e.y+m*e.x*e.x,-2*a.x*a.y*g.x*e.y-2*a.x*a.y*g.y*e.x+2*m*g.x*e.x+2*k*g.y*e.y,-2*a.x*f.x*a.y*e.y-2*a.x*a.y*f.y*e.x-2*a.x*a.y*g.x*g.y+2*f.x*m*e.x+m*g.x*g.x+k*(2*f.y*e.y+g.y*g.y),2*d.x*a.x*a.y*e.y+2*d.y*a.x*a.y*e.x+c.x*c.y*a.x*e.y+c.x*c.y*a.y*e.x-2*b.x*a.x*a.y*e.y-2*a.x*b.y*a.y*e.x-2*a.x*f.x*a.y*g.y-2*a.x*a.y*f.y*g.x-2*d.x*m*e.x-2*d.y*k*e.y+2*b.x*m*e.x+2*f.x*m*g.x-j*a.x*e.x-h*a.y*e.y+k*(2*b.y*e.y+2*f.y*g.y),2*d.x*a.x*a.y*g.y+
2*d.y*a.x*a.y*g.x+c.x*c.y*a.x*g.y+c.x*c.y*a.y*g.x-2*b.x*a.x*a.y*g.y-2*a.x*b.y*a.y*g.x-2*a.x*f.x*a.y*f.y-2*d.x*m*g.x-2*d.y*k*g.y+2*b.x*m*g.x-j*a.x*g.x-h*a.y*g.y+f.x*f.x*m+k*(2*b.y*g.y+f.y*f.y),2*d.x*a.x*a.y*f.y+2*d.y*a.x*f.x*a.y+c.x*c.y*a.x*f.y+c.x*c.y*f.x*a.y-2*b.x*a.x*a.y*f.y-2*a.x*b.y*f.x*a.y-2*d.x*f.x*m-2*d.y*k*f.y+2*b.x*f.x*m-j*a.x*f.x-h*a.y*f.y+2*k*b.y*f.y,-2*d.x*d.y*a.x*a.y-d.x*c.x*c.y*a.y-d.y*c.x*c.y*a.x+2*d.x*a.x*b.y*a.y+2*d.y*b.x*a.x*a.y+c.x*b.x*c.y*a.y+c.x*c.y*a.x*b.y-2*b.x*a.x*b.y*a.y-
2*d.x*b.x*m+d.x*j*a.x+d.y*h*a.y-2*d.y*k*b.y-b.x*j*a.x-h*b.y*a.y+d.x*d.x*m+d.y*d.y*k+b.x*b.x*m+k*b.y*b.y)).getRootsInInterval(0,1);for(j=0;j<h.length;j++){k=h[j];var m=(new Polynomial(a.x,c.x,d.x-b.x-k*f.x-k*k*g.x-k*k*k*e.x)).getRoots(),q=(new Polynomial(a.y,c.y,d.y-b.y-k*f.y-k*k*g.y-k*k*k*e.y)).getRoots();if(m.length>0&&q.length>0){var r=0;a:for(;r<m.length;r++){var u=m[r];if(0<=u&&u<=1)for(var s=0;s<q.length;s++)if(Math.abs(u-q[s])<1.0E-4){l.points.push(e.multiply(k*k*k).add(g.multiply(k*k).add(f.multiply(k).add(b))));
break a}}}}if(l.points.length>0)l.status="Intersection";return l};Intersection.intersectBezier2Circle=function(d,c,a,b,f){return Intersection.intersectBezier2Ellipse(d,c,a,b,f,f)};
Intersection.intersectBezier2Ellipse=function(d,c,a,b,f,g){var e,h=new Intersection("No Intersection");e=c.multiply(-2);a=d.add(e.add(a));e=d.multiply(-2);c=c.multiply(2);e=e.add(c);d=new Point2D(d.x,d.y);f*=f;g*=g;b=(new Polynomial(g*a.x*a.x+f*a.y*a.y,2*(g*a.x*e.x+f*a.y*e.y),g*(2*a.x*d.x+e.x*e.x)+f*(2*a.y*d.y+e.y*e.y)-2*(g*b.x*a.x+f*b.y*a.y),2*(g*e.x*(d.x-b.x)+f*e.y*(d.y-b.y)),g*(d.x*d.x+b.x*b.x)+f*(d.y*d.y+b.y*b.y)-2*(g*b.x*d.x+f*b.y*d.y)-f*g)).getRoots();for(g=0;g<b.length;g++)f=b[g],0<=f&&f<=
1&&h.points.push(a.multiply(f*f).add(e.multiply(f).add(d)));if(h.points.length>0)h.status="Intersection";return h};
Intersection.intersectBezier2Line=function(d,c,a,b,f){var g,e,h,j,k,l=b.min(f),m=b.max(f),q=new Intersection("No Intersection");g=c.multiply(-2);h=d.add(g.add(a));g=d.multiply(-2);e=c.multiply(2);g=g.add(e);e=new Point2D(d.x,d.y);k=new Vector2D(b.y-f.y,f.x-b.x);j=b.x*f.y-f.x*b.y;roots=(new Polynomial(k.dot(h),k.dot(g),k.dot(e)+j)).getRoots();for(h=0;h<roots.length;h++)if(g=roots[h],0<=g&&g<=1)if(e=d.lerp(c,g),j=c.lerp(a,g),g=e.lerp(j,g),b.x==f.x){if(l.y<=g.y&&g.y<=m.y)q.status="Intersection",q.appendPoint(g)}else if(b.y==
f.y){if(l.x<=g.x&&g.x<=m.x)q.status="Intersection",q.appendPoint(g)}else if(g.gte(l)&&g.lte(m))q.status="Intersection",q.appendPoint(g);return q};Intersection.intersectBezier2Polygon=function(d,c,a,b){for(var f=new Intersection("No Intersection"),g=b.length,e=0;e<g;e++){var h=Intersection.intersectBezier2Line(d,c,a,b[e],b[(e+1)%g]);f.appendPoints(h.points)}if(f.points.length>0)f.status="Intersection";return f};
Intersection.intersectBezier2Rectangle=function(d,c,a,b,f){var g=b.min(f),e=b.max(f),f=new Point2D(e.x,g.y),h=new Point2D(g.x,e.y),b=Intersection.intersectBezier2Line(d,c,a,g,f),f=Intersection.intersectBezier2Line(d,c,a,f,e),e=Intersection.intersectBezier2Line(d,c,a,e,h),d=Intersection.intersectBezier2Line(d,c,a,h,g),c=new Intersection("No Intersection");c.appendPoints(b.points);c.appendPoints(f.points);c.appendPoints(e.points);c.appendPoints(d.points);if(c.points.length>0)c.status="Intersection";
return c};
Intersection.intersectBezier3Bezier3=function(d,c,a,b,f,g,e,h){var j,k,l,m=new Intersection("No Intersection");j=d.multiply(-1);k=c.multiply(3);l=a.multiply(-3);j=j.add(k.add(l.add(b)));b=new Vector2D(j.x,j.y);j=d.multiply(3);k=c.multiply(-6);l=a.multiply(3);j=j.add(k.add(l));a=new Vector2D(j.x,j.y);j=d.multiply(-3);k=c.multiply(3);l=j.add(k);c=new Vector2D(l.x,l.y);d=new Vector2D(d.x,d.y);j=f.multiply(-1);k=g.multiply(3);l=e.multiply(-3);j=j.add(k.add(l.add(h)));h=new Vector2D(j.x,j.y);j=f.multiply(3);
k=g.multiply(-6);l=e.multiply(3);j=j.add(k.add(l));e=new Vector2D(j.x,j.y);j=f.multiply(-3);k=g.multiply(3);l=j.add(k);g=new Vector2D(l.x,l.y);f=new Vector2D(f.x,f.y);j=d.x*d.x;k=d.y*d.y;l=c.x*c.x;var q=c.x*c.x*c.x,r=c.y*c.y,u=c.y*c.y*c.y,s=a.x*a.x,z=a.x*a.x*a.x,t=a.y*a.y,A=a.y*a.y*a.y,p=b.x*b.x,w=b.x*b.x*b.x,o=b.y*b.y,v=b.y*b.y*b.y,B=f.x*f.x,H=f.y*f.y,I=g.x*g.x,C=g.y*g.y,D=e.x*e.x,E=e.y*e.y,F=h.x*h.x,G=h.y*h.y;j=(new Polynomial(-w*h.y*h.y*h.y+v*h.x*h.x*h.x-3*b.x*o*F*h.y+3*p*b.y*h.x*G,-6*b.x*e.x*
o*h.x*h.y+6*p*b.y*e.y*h.x*h.y+3*e.x*v*F-3*w*e.y*G-3*b.x*o*e.y*F+3*p*e.x*b.y*G,-6*g.x*b.x*o*h.x*h.y-6*b.x*e.x*o*e.y*h.x+6*p*e.x*b.y*e.y*h.y+3*g.x*v*F+3*D*v*h.x+3*g.x*p*b.y*G-3*b.x*g.y*o*F-3*b.x*D*o*h.y+p*b.y*h.x*(6*g.y*h.y+3*E)+w*(-g.y*G-2*E*h.y-h.y*(2*g.y*h.y+E)),c.x*a.y*b.x*b.y*h.x*h.y-c.y*a.x*b.x*b.y*h.x*h.y+6*g.x*e.x*v*h.x+3*c.x*a.x*b.x*b.y*G+6*d.x*b.x*o*h.x*h.y-3*c.x*a.x*o*h.x*h.y-3*c.y*a.y*b.x*b.y*F-6*d.y*p*b.y*h.x*h.y-6*f.x*b.x*o*h.x*h.y+3*c.y*a.y*p*h.x*h.y-2*a.x*t*b.x*h.x*h.y-6*g.x*b.x*e.x*
o*h.y-6*g.x*b.x*o*e.y*h.x-6*b.x*g.y*e.x*o*h.x+6*g.x*p*b.y*e.y*h.y+2*s*a.y*b.y*h.x*h.y+e.x*e.x*e.x*v-3*d.x*v*F+3*d.y*w*G+3*f.x*v*F+A*b.x*F-z*b.y*G-3*d.x*p*b.y*G+3*d.y*b.x*o*F-2*c.x*a.y*p*G+c.x*a.y*o*F-c.y*a.x*p*G+2*c.y*a.x*o*F+3*f.x*p*b.y*G-a.x*t*b.y*F-3*f.y*b.x*o*F+s*a.y*b.x*G-3*b.x*D*o*e.y+p*b.y*h.x*(6*f.y*h.y+6*g.y*e.y)+p*e.x*b.y*(6*g.y*h.y+3*E)+w*(-2*g.y*e.y*h.y-f.y*G-e.y*(2*g.y*h.y+E)-h.y*(2*f.y*h.y+2*g.y*e.y)),6*c.x*a.x*b.x*b.y*e.y*h.y+c.x*a.y*b.x*e.x*b.y*h.y+c.x*a.y*b.x*b.y*e.y*h.x-c.y*a.x*
b.x*e.x*b.y*h.y-c.y*a.x*b.x*b.y*e.y*h.x-6*c.y*a.y*b.x*e.x*b.y*h.x-6*d.x*e.x*v*h.x+6*f.x*e.x*v*h.x+6*d.y*w*e.y*h.y+2*A*b.x*e.x*h.x-2*z*b.y*e.y*h.y+6*d.x*b.x*e.x*o*h.y+6*d.x*b.x*o*e.y*h.x+6*d.y*b.x*e.x*o*h.x-3*c.x*a.x*e.x*o*h.y-3*c.x*a.x*o*e.y*h.x+2*c.x*a.y*e.x*o*h.x+4*c.y*a.x*e.x*o*h.x-6*d.x*p*b.y*e.y*h.y-6*d.y*p*e.x*b.y*h.y-6*d.y*p*b.y*e.y*h.x-4*c.x*a.y*p*e.y*h.y-6*f.x*b.x*e.x*o*h.y-6*f.x*b.x*o*e.y*h.x-2*c.y*a.x*p*e.y*h.y+3*c.y*a.y*p*e.x*h.y+3*c.y*a.y*p*e.y*h.x-2*a.x*t*b.x*e.x*h.y-2*a.x*t*b.x*e.y*
h.x-2*a.x*t*e.x*b.y*h.x-6*f.y*b.x*e.x*o*h.x-6*g.x*b.x*g.y*o*h.x-6*g.x*b.x*e.x*o*e.y+6*f.x*p*b.y*e.y*h.y+2*s*a.y*b.x*e.y*h.y+2*s*a.y*e.x*b.y*h.y+2*s*a.y*b.y*e.y*h.x+3*g.x*D*v+3*I*v*h.x-3*b.x*g.y*D*o-3*I*b.x*o*h.y+p*e.x*b.y*(6*f.y*h.y+6*g.y*e.y)+p*b.y*h.x*(6*f.y*e.y+3*C)+g.x*p*b.y*(6*g.y*h.y+3*E)+w*(-2*f.y*e.y*h.y-h.y*(2*f.y*e.y+C)-g.y*(2*g.y*h.y+E)-e.y*(2*f.y*h.y+2*g.y*e.y)),c.x*g.x*a.y*b.x*b.y*h.y+c.x*a.y*b.x*g.y*b.y*h.x+c.x*a.y*b.x*e.x*b.y*e.y-c.y*a.x*g.x*b.x*b.y*h.y-c.y*a.x*b.x*g.y*b.y*h.x-c.y*
a.x*b.x*e.x*b.y*e.y-6*c.y*g.x*a.y*b.x*b.y*h.x-6*d.x*g.x*v*h.x+6*f.x*g.x*v*h.x+2*g.x*A*b.x*h.x+6*d.x*g.x*b.x*o*h.y+6*d.x*b.x*g.y*o*h.x+6*d.x*b.x*e.x*o*e.y+6*d.y*g.x*b.x*o*h.x-3*c.x*a.x*g.x*o*h.y-3*c.x*a.x*g.y*o*h.x-3*c.x*a.x*e.x*o*e.y+2*c.x*g.x*a.y*o*h.x+4*c.y*a.x*g.x*o*h.x-6*d.y*g.x*p*b.y*h.y-6*d.y*p*g.y*b.y*h.x-6*d.y*p*e.x*b.y*e.y-6*f.x*g.x*b.x*o*h.y-6*f.x*b.x*g.y*o*h.x-6*f.x*b.x*e.x*o*e.y+3*c.y*g.x*a.y*p*h.y-3*c.y*a.y*b.x*D*b.y+3*c.y*a.y*p*g.y*h.x+3*c.y*a.y*p*e.x*e.y-2*a.x*g.x*t*b.x*h.y-2*a.x*g.x*
t*b.y*h.x-2*a.x*t*b.x*g.y*h.x-2*a.x*t*b.x*e.x*e.y-6*f.y*g.x*b.x*o*h.x-6*g.x*b.x*g.y*e.x*o+6*f.y*p*g.y*b.y*h.x+2*s*g.x*a.y*b.y*h.y+2*s*a.y*g.y*b.y*h.x+2*s*a.y*e.x*b.y*e.y-3*d.x*D*v+3*f.x*D*v+3*I*e.x*v+A*b.x*D+3*d.y*b.x*D*o+c.x*a.y*D*o+2*c.y*a.x*D*o-a.x*t*D*b.y-3*f.y*b.x*D*o-3*I*b.x*o*e.y+s*a.y*b.x*(2*g.y*h.y+E)+c.x*a.x*b.x*b.y*(6*g.y*h.y+3*E)+g.x*p*b.y*(6*f.y*h.y+6*g.y*e.y)+z*b.y*(-2*g.y*h.y-E)+d.y*w*(6*g.y*h.y+3*E)+c.y*a.x*p*(-2*g.y*h.y-E)+c.x*a.y*p*(-4*g.y*h.y-2*E)+d.x*p*b.y*(-6*g.y*h.y-3*E)+p*e.x*
b.y*(6*f.y*e.y+3*C)+f.x*p*b.y*(6*g.y*h.y+3*E)+w*(-2*f.y*g.y*h.y-e.y*(2*f.y*e.y+C)-f.y*(2*g.y*h.y+E)-g.y*(2*f.y*h.y+2*g.y*e.y)),-d.x*c.x*a.y*b.x*b.y*h.y+d.x*c.y*a.x*b.x*b.y*h.y+6*d.x*c.y*a.y*b.x*b.y*h.x-6*d.y*c.x*a.x*b.x*b.y*h.y-d.y*c.x*a.y*b.x*b.y*h.x+d.y*c.y*a.x*b.x*b.y*h.x+c.x*c.y*a.x*a.y*b.x*h.y-c.x*c.y*a.x*a.y*b.y*h.x+c.x*f.x*a.y*b.x*b.y*h.y+c.x*f.y*a.y*b.x*b.y*h.x+c.x*g.x*a.y*b.x*b.y*e.y+c.x*a.y*b.x*g.y*e.x*b.y-f.x*c.y*a.x*b.x*b.y*h.y-6*f.x*c.y*a.y*b.x*b.y*h.x-c.y*a.x*f.y*b.x*b.y*h.x-c.y*a.x*
g.x*b.x*b.y*e.y-c.y*a.x*b.x*g.y*e.x*b.y-6*c.y*g.x*a.y*b.x*e.x*b.y-6*d.x*f.x*v*h.x-6*d.x*g.x*e.x*v-2*d.x*A*b.x*h.x+6*f.x*g.x*e.x*v+2*f.x*A*b.x*h.x+2*g.x*A*b.x*e.x+2*d.y*z*b.y*h.y-6*d.x*d.y*b.x*o*h.x+3*d.x*c.x*a.x*o*h.y-2*d.x*c.x*a.y*o*h.x-4*d.x*c.y*a.x*o*h.x+3*d.y*c.x*a.x*o*h.x+6*d.x*d.y*p*b.y*h.y+6*d.x*f.x*b.x*o*h.y-3*d.x*c.y*a.y*p*h.y+2*d.x*a.x*t*b.x*h.y+2*d.x*a.x*t*b.y*h.x+6*d.x*f.y*b.x*o*h.x+6*d.x*g.x*b.x*o*e.y+6*d.x*b.x*g.y*e.x*o+4*d.y*c.x*a.y*p*h.y+6*d.y*f.x*b.x*o*h.x+2*d.y*c.y*a.x*p*h.y-3*d.y*
c.y*a.y*p*h.x+2*d.y*a.x*t*b.x*h.x+6*d.y*g.x*b.x*e.x*o-3*c.x*f.x*a.x*o*h.y+2*c.x*f.x*a.y*o*h.x+c.x*c.y*t*b.x*h.x-3*c.x*a.x*f.y*o*h.x-3*c.x*a.x*g.x*o*e.y-3*c.x*a.x*g.y*e.x*o+2*c.x*g.x*a.y*e.x*o+4*f.x*c.y*a.x*o*h.x+4*c.y*a.x*g.x*e.x*o-2*d.x*s*a.y*b.y*h.y-6*d.y*f.x*p*b.y*h.y-6*d.y*f.y*p*b.y*h.x-6*d.y*g.x*p*b.y*e.y-2*d.y*s*a.y*b.x*h.y-2*d.y*s*a.y*b.y*h.x-6*d.y*p*g.y*e.x*b.y-c.x*c.y*s*b.y*h.y-2*c.x*r*b.x*b.y*h.x+3*f.x*c.y*a.y*p*h.y-2*f.x*a.x*t*b.x*h.y-2*f.x*a.x*t*b.y*h.x-6*f.x*f.y*b.x*o*h.x-6*f.x*g.x*b.x*
o*e.y-6*f.x*b.x*g.y*e.x*o+3*c.y*f.y*a.y*p*h.x+3*c.y*g.x*a.y*p*e.y+3*c.y*a.y*p*g.y*e.x-2*a.x*f.y*t*b.x*h.x-2*a.x*g.x*t*b.x*e.y-2*a.x*g.x*t*e.x*b.y-2*a.x*t*b.x*g.y*e.x-6*f.y*g.x*b.x*e.x*o-r*a.x*a.y*b.x*h.x+2*f.x*s*a.y*b.y*h.y+6*f.y*p*g.y*e.x*b.y+2*l*c.y*b.x*b.y*h.y+l*a.x*a.y*b.y*h.y+2*s*f.y*a.y*b.y*h.x+2*s*g.x*a.y*b.y*e.y+2*s*a.y*g.y*e.x*b.y+g.x*g.x*g.x*v+3*j*v*h.x-3*k*w*h.y+3*B*v*h.x+u*p*h.x-q*o*h.y-c.x*r*p*h.y+l*c.y*o*h.x-3*j*b.x*o*h.y+3*k*p*b.y*h.x-l*t*b.x*h.y+r*s*b.y*h.x-3*I*b.x*g.y*o-3*B*b.x*o*
h.y+3*H*p*b.y*h.x+c.x*a.x*b.x*b.y*(6*f.y*h.y+6*g.y*e.y)+z*b.y*(-2*f.y*h.y-2*g.y*e.y)+d.y*w*(6*f.y*h.y+6*g.y*e.y)+c.y*a.x*p*(-2*f.y*h.y-2*g.y*e.y)+s*a.y*b.x*(2*f.y*h.y+2*g.y*e.y)+c.x*a.y*p*(-4*f.y*h.y-4*g.y*e.y)+d.x*p*b.y*(-6*f.y*h.y-6*g.y*e.y)+f.x*p*b.y*(6*f.y*h.y+6*g.y*e.y)+g.x*p*b.y*(6*f.y*e.y+3*C)+w*(-2*f.y*g.y*e.y-H*h.y-g.y*(2*f.y*e.y+C)-f.y*(2*f.y*h.y+2*g.y*e.y)),-d.x*c.x*a.y*b.x*b.y*e.y+d.x*c.y*a.x*b.x*b.y*e.y+6*d.x*c.y*a.y*b.x*e.x*b.y-6*d.y*c.x*a.x*b.x*b.y*e.y-d.y*c.x*a.y*b.x*e.x*b.y+d.y*c.y*
a.x*b.x*e.x*b.y+c.x*c.y*a.x*a.y*b.x*e.y-c.x*c.y*a.x*a.y*e.x*b.y+c.x*f.x*a.y*b.x*b.y*e.y+c.x*f.y*a.y*b.x*e.x*b.y+c.x*g.x*a.y*b.x*g.y*b.y-f.x*c.y*a.x*b.x*b.y*e.y-6*f.x*c.y*a.y*b.x*e.x*b.y-c.y*a.x*f.y*b.x*e.x*b.y-c.y*a.x*g.x*b.x*g.y*b.y-6*d.x*f.x*e.x*v-2*d.x*A*b.x*e.x+2*f.x*A*b.x*e.x+2*d.y*z*b.y*e.y-6*d.x*d.y*b.x*e.x*o+3*d.x*c.x*a.x*o*e.y-2*d.x*c.x*a.y*e.x*o-4*d.x*c.y*a.x*e.x*o+3*d.y*c.x*a.x*e.x*o+6*d.x*d.y*p*b.y*e.y+6*d.x*f.x*b.x*o*e.y-3*d.x*c.y*a.y*p*e.y+2*d.x*a.x*t*b.x*e.y+2*d.x*a.x*t*e.x*b.y+6*d.x*
f.y*b.x*e.x*o+6*d.x*g.x*b.x*g.y*o+4*d.y*c.x*a.y*p*e.y+6*d.y*f.x*b.x*e.x*o+2*d.y*c.y*a.x*p*e.y-3*d.y*c.y*a.y*p*e.x+2*d.y*a.x*t*b.x*e.x-3*c.x*f.x*a.x*o*e.y+2*c.x*f.x*a.y*e.x*o+c.x*c.y*t*b.x*e.x-3*c.x*a.x*f.y*e.x*o-3*c.x*a.x*g.x*g.y*o+4*f.x*c.y*a.x*e.x*o-2*d.x*s*a.y*b.y*e.y-6*d.y*f.x*p*b.y*e.y-6*d.y*f.y*p*e.x*b.y-6*d.y*g.x*p*g.y*b.y-2*d.y*s*a.y*b.x*e.y-2*d.y*s*a.y*e.x*b.y-c.x*c.y*s*b.y*e.y-2*c.x*r*b.x*e.x*b.y+3*f.x*c.y*a.y*p*e.y-2*f.x*a.x*t*b.x*e.y-2*f.x*a.x*t*e.x*b.y-6*f.x*f.y*b.x*e.x*o-6*f.x*g.x*b.x*
g.y*o+3*c.y*f.y*a.y*p*e.x+3*c.y*g.x*a.y*p*g.y-2*a.x*f.y*t*b.x*e.x-2*a.x*g.x*t*b.x*g.y-r*a.x*a.y*b.x*e.x+2*f.x*s*a.y*b.y*e.y-3*c.y*I*a.y*b.x*b.y+6*f.y*g.x*p*g.y*b.y+2*l*c.y*b.x*b.y*e.y+l*a.x*a.y*b.y*e.y+2*s*f.y*a.y*e.x*b.y+2*s*g.x*a.y*g.y*b.y-3*d.x*I*v+3*f.x*I*v+3*j*e.x*v-3*k*w*e.y+3*B*e.x*v+I*A*b.x+u*p*e.x-q*o*e.y+3*d.y*I*b.x*o-c.x*r*p*e.y+c.x*I*a.y*o+2*c.y*a.x*I*o+l*c.y*e.x*o-a.x*I*t*b.y-3*f.y*I*b.x*o-3*j*b.x*o*e.y+3*k*p*e.x*b.y-l*t*b.x*e.y+r*s*e.x*b.y-3*B*b.x*o*e.y+3*H*p*e.x*b.y+s*a.y*b.x*(2*f.y*
e.y+C)+c.x*a.x*b.x*b.y*(6*f.y*e.y+3*C)+z*b.y*(-2*f.y*e.y-C)+d.y*w*(6*f.y*e.y+3*C)+c.y*a.x*p*(-2*f.y*e.y-C)+c.x*a.y*p*(-4*f.y*e.y-2*C)+d.x*p*b.y*(-6*f.y*e.y-3*C)+f.x*p*b.y*(6*f.y*e.y+3*C)+w*(-2*f.y*C-H*e.y-f.y*(2*f.y*e.y+C)),-d.x*c.x*a.y*b.x*g.y*b.y+d.x*c.y*a.x*b.x*g.y*b.y+6*d.x*c.y*g.x*a.y*b.x*b.y-6*d.y*c.x*a.x*b.x*g.y*b.y-d.y*c.x*g.x*a.y*b.x*b.y+d.y*c.y*a.x*g.x*b.x*b.y-c.x*c.y*a.x*g.x*a.y*b.y+c.x*c.y*a.x*a.y*b.x*g.y+c.x*f.x*a.y*b.x*g.y*b.y+6*c.x*a.x*f.y*b.x*g.y*b.y+c.x*f.y*g.x*a.y*b.x*b.y-f.x*c.y*
a.x*b.x*g.y*b.y-6*f.x*c.y*g.x*a.y*b.x*b.y-c.y*a.x*f.y*g.x*b.x*b.y-6*d.x*f.x*g.x*v-2*d.x*g.x*A*b.x+6*d.y*f.y*w*g.y+2*f.x*g.x*A*b.x+2*d.y*z*g.y*b.y-2*z*f.y*g.y*b.y-6*d.x*d.y*g.x*b.x*o+3*d.x*c.x*a.x*g.y*o-2*d.x*c.x*g.x*a.y*o-4*d.x*c.y*a.x*g.x*o+3*d.y*c.x*a.x*g.x*o+6*d.x*d.y*p*g.y*b.y+6*d.x*f.x*b.x*g.y*o-3*d.x*c.y*a.y*p*g.y+2*d.x*a.x*g.x*t*b.y+2*d.x*a.x*t*b.x*g.y+6*d.x*f.y*g.x*b.x*o+4*d.y*c.x*a.y*p*g.y+6*d.y*f.x*g.x*b.x*o+2*d.y*c.y*a.x*p*g.y-3*d.y*c.y*g.x*a.y*p+2*d.y*a.x*g.x*t*b.x-3*c.x*f.x*a.x*g.y*o+
2*c.x*f.x*g.x*a.y*o+c.x*c.y*g.x*t*b.x-3*c.x*a.x*f.y*g.x*o+4*f.x*c.y*a.x*g.x*o-6*d.x*f.y*p*g.y*b.y-2*d.x*s*a.y*g.y*b.y-6*d.y*f.x*p*g.y*b.y-6*d.y*f.y*g.x*p*b.y-2*d.y*s*g.x*a.y*b.y-2*d.y*s*a.y*b.x*g.y-c.x*c.y*s*g.y*b.y-4*c.x*f.y*a.y*p*g.y-2*c.x*r*g.x*b.x*b.y+3*f.x*c.y*a.y*p*g.y-2*f.x*a.x*g.x*t*b.y-2*f.x*a.x*t*b.x*g.y-6*f.x*f.y*g.x*b.x*o-2*c.y*a.x*f.y*p*g.y+3*c.y*f.y*g.x*a.y*p-2*a.x*f.y*g.x*t*b.x-r*a.x*g.x*a.y*b.x+6*f.x*f.y*p*g.y*b.y+2*f.x*s*a.y*g.y*b.y+2*l*c.y*b.x*g.y*b.y+l*a.x*a.y*g.y*b.y+2*s*f.y*g.x*
a.y*b.y+2*s*f.y*a.y*b.x*g.y+3*j*g.x*v-3*k*w*g.y+3*B*g.x*v+u*g.x*p-q*g.y*o-3*H*w*g.y-c.x*r*p*g.y+l*c.y*g.x*o-3*j*b.x*g.y*o+3*k*g.x*p*b.y-l*t*b.x*g.y+r*s*g.x*b.y-3*B*b.x*g.y*o+3*H*g.x*p*b.y,d.x*d.y*c.x*a.y*b.x*b.y-d.x*d.y*c.y*a.x*b.x*b.y+d.x*c.x*c.y*a.x*a.y*b.y-d.y*c.x*c.y*a.x*a.y*b.x-d.x*c.x*f.y*a.y*b.x*b.y+6*d.x*f.x*c.y*a.y*b.x*b.y+d.x*c.y*a.x*f.y*b.x*b.y-d.y*c.x*f.x*a.y*b.x*b.y-6*d.y*c.x*a.x*f.y*b.x*b.y+d.y*f.x*c.y*a.x*b.x*b.y-c.x*f.x*c.y*a.x*a.y*b.y+c.x*c.y*a.x*f.y*a.y*b.x+c.x*f.x*f.y*a.y*b.x*b.y-
f.x*c.y*a.x*f.y*b.x*b.y-2*d.x*f.x*A*b.x+2*d.y*z*f.y*b.y-3*d.x*d.y*c.x*a.x*o-6*d.x*d.y*f.x*b.x*o+3*d.x*d.y*c.y*a.y*p-2*d.x*d.y*a.x*t*b.x-2*d.x*c.x*f.x*a.y*o-d.x*c.x*c.y*t*b.x+3*d.x*c.x*a.x*f.y*o-4*d.x*f.x*c.y*a.x*o+3*d.y*c.x*f.x*a.x*o+6*d.x*d.y*f.y*p*b.y+2*d.x*d.y*s*a.y*b.y+2*d.x*c.x*r*b.x*b.y+2*d.x*f.x*a.x*t*b.y+6*d.x*f.x*f.y*b.x*o-3*d.x*c.y*f.y*a.y*p+2*d.x*a.x*f.y*t*b.x+d.x*r*a.x*a.y*b.x+d.y*c.x*c.y*s*b.y+4*d.y*c.x*f.y*a.y*p-3*d.y*f.x*c.y*a.y*p+2*d.y*f.x*a.x*t*b.x+2*d.y*c.y*a.x*f.y*p+c.x*f.x*c.y*
t*b.x-3*c.x*f.x*a.x*f.y*o-2*d.x*s*f.y*a.y*b.y-6*d.y*f.x*f.y*p*b.y-2*d.y*f.x*s*a.y*b.y-2*d.y*l*c.y*b.x*b.y-d.y*l*a.x*a.y*b.y-2*d.y*s*f.y*a.y*b.x-2*c.x*f.x*r*b.x*b.y-c.x*c.y*s*f.y*b.y+3*f.x*c.y*f.y*a.y*p-2*f.x*a.x*f.y*t*b.x-f.x*r*a.x*a.y*b.x+3*k*c.x*a.x*b.x*b.y+3*c.x*a.x*H*b.x*b.y+2*f.x*s*f.y*a.y*b.y-3*j*c.y*a.y*b.x*b.y+2*l*c.y*f.y*b.x*b.y+l*a.x*f.y*a.y*b.y-3*B*c.y*a.y*b.x*b.y-d.x*d.x*d.x*v+d.y*d.y*d.y*w+f.x*f.x*f.x*v-f.y*f.y*f.y*w-3*d.x*B*v-d.x*u*p+3*j*f.x*v+d.y*q*o+3*d.y*H*w+f.x*u*p+j*A*b.x-3*k*f.y*
w-k*z*b.y+B*A*b.x-q*f.y*o-z*H*b.y-d.x*l*c.y*o+d.y*c.x*r*p-3*d.x*k*p*b.y-d.x*r*s*b.y+d.y*l*t*b.x-c.x*r*f.y*p+3*j*d.y*b.x*o+j*c.x*a.y*o+2*j*c.y*a.x*o-2*k*c.x*a.y*p-k*c.y*a.x*p+l*f.x*c.y*o-3*d.x*H*p*b.y+3*d.y*B*b.x*o+c.x*B*a.y*o-2*c.x*H*a.y*p+f.x*r*s*b.y-c.y*a.x*H*p-j*a.x*t*b.y-3*j*f.y*b.x*o+3*k*f.x*p*b.y+k*s*a.y*b.x-l*f.y*t*b.x+2*B*c.y*a.x*o+3*f.x*H*p*b.y-B*a.x*t*b.y-3*B*f.y*b.x*o+s*H*a.y*b.x)).getRootsInInterval(0,1);for(k=0;k<j.length;k++)if(l=j[k],q=(new Polynomial(b.x,a.x,c.x,d.x-f.x-l*g.x-l*l*
e.x-l*l*l*h.x)).getRoots(),r=(new Polynomial(b.y,a.y,c.y,d.y-f.y-l*g.y-l*l*e.y-l*l*l*h.y)).getRoots(),q.length>0&&r.length>0){u=0;a:for(;u<q.length;u++)if(s=q[u],0<=s&&s<=1)for(z=0;z<r.length;z++)if(Math.abs(s-r[z])<1.0E-4){m.points.push(h.multiply(l*l*l).add(e.multiply(l*l).add(g.multiply(l).add(f))));break a}}if(m.points.length>0)m.status="Intersection";return m};Intersection.intersectBezier3Circle=function(d,c,a,b,f,g){return Intersection.intersectBezier3Ellipse(d,c,a,b,f,g,g)};
Intersection.intersectBezier3Ellipse=function(d,c,a,b,f,g,e){var h,j,k,l=new Intersection("No Intersection");h=d.multiply(-1);j=c.multiply(3);k=a.multiply(-3);h=h.add(j.add(k.add(b)));b=new Vector2D(h.x,h.y);h=d.multiply(3);j=c.multiply(-6);k=a.multiply(3);h=h.add(j.add(k));a=new Vector2D(h.x,h.y);h=d.multiply(-3);j=c.multiply(3);k=h.add(j);c=new Vector2D(k.x,k.y);d=new Vector2D(d.x,d.y);g*=g;e*=e;f=(new Polynomial(b.x*b.x*e+b.y*b.y*g,2*(b.x*a.x*e+b.y*a.y*g),2*(b.x*c.x*e+b.y*c.y*g)+a.x*a.x*e+a.y*
a.y*g,2*b.x*e*(d.x-f.x)+2*b.y*g*(d.y-f.y)+2*(a.x*c.x*e+a.y*c.y*g),2*a.x*e*(d.x-f.x)+2*a.y*g*(d.y-f.y)+c.x*c.x*e+c.y*c.y*g,2*c.x*e*(d.x-f.x)+2*c.y*g*(d.y-f.y),d.x*d.x*e-2*d.y*f.y*g-2*d.x*f.x*e+d.y*d.y*g+f.x*f.x*e+f.y*f.y*g-g*e)).getRootsInInterval(0,1);for(e=0;e<f.length;e++)g=f[e],l.points.push(b.multiply(g*g*g).add(a.multiply(g*g).add(c.multiply(g).add(d))));if(l.points.length>0)l.status="Intersection";return l};
Intersection.intersectBezier3Line=function(d,c,a,b,f,g){var e,h,j,k,l,m,q=f.min(g),r=f.max(g),u=new Intersection("No Intersection");e=d.multiply(-1);h=c.multiply(3);j=a.multiply(-3);k=e.add(h.add(j.add(b)));l=new Vector2D(k.x,k.y);e=d.multiply(3);h=c.multiply(-6);j=a.multiply(3);k=e.add(h.add(j));k=new Vector2D(k.x,k.y);e=d.multiply(-3);h=c.multiply(3);j=e.add(h);e=new Vector2D(j.x,j.y);h=new Vector2D(d.x,d.y);m=new Vector2D(f.y-g.y,g.x-f.x);j=f.x*g.y-g.x*f.y;roots=(new Polynomial(m.dot(l),m.dot(k),
m.dot(e),m.dot(h)+j)).getRoots();for(l=0;l<roots.length;l++)if(k=roots[l],0<=k&&k<=1)if(j=d.lerp(c,k),e=c.lerp(a,k),h=a.lerp(b,k),j=j.lerp(e,k),e=e.lerp(h,k),k=j.lerp(e,k),f.x==g.x){if(q.y<=k.y&&k.y<=r.y)u.status="Intersection",u.appendPoint(k)}else if(f.y==g.y){if(q.x<=k.x&&k.x<=r.x)u.status="Intersection",u.appendPoint(k)}else if(k.gte(q)&&k.lte(r))u.status="Intersection",u.appendPoint(k);return u};
Intersection.intersectBezier3Polygon=function(d,c,a,b,f){for(var g=new Intersection("No Intersection"),e=f.length,h=0;h<e;h++){var j=Intersection.intersectBezier3Line(d,c,a,b,f[h],f[(h+1)%e]);g.appendPoints(j.points)}if(g.points.length>0)g.status="Intersection";return g};
Intersection.intersectBezier3Rectangle=function(d,c,a,b,f,g){var e=f.min(g),h=f.max(g),g=new Point2D(h.x,e.y),j=new Point2D(e.x,h.y),f=Intersection.intersectBezier3Line(d,c,a,b,e,g),g=Intersection.intersectBezier3Line(d,c,a,b,g,h),h=Intersection.intersectBezier3Line(d,c,a,b,h,j),d=Intersection.intersectBezier3Line(d,c,a,b,j,e),c=new Intersection("No Intersection");c.appendPoints(f.points);c.appendPoints(g.points);c.appendPoints(h.points);c.appendPoints(d.points);if(c.points.length>0)c.status="Intersection";
return c};Intersection.intersectCircleCircle=function(d,c,a,b){var f;f=c+b;var g=Math.abs(c-b),e=d.distanceFrom(a);e>f?f=new Intersection("Outside"):e<g?f=new Intersection("Inside"):(f=new Intersection("Intersection"),b=(c*c-b*b+e*e)/(2*e),c=Math.sqrt(c*c-b*b),b=d.lerp(a,b/e),e=c/e,f.points.push(new Point2D(b.x-e*(a.y-d.y),b.y+e*(a.x-d.x))),f.points.push(new Point2D(b.x+e*(a.y-d.y),b.y-e*(a.x-d.x))));return f};
Intersection.intersectCircleEllipse=function(d,c,a,b,f){return Intersection.intersectEllipseEllipse(d,c,c,a,b,f)};
Intersection.intersectCircleLine=function(d,c,a,b){var f;f=(b.x-a.x)*(b.x-a.x)+(b.y-a.y)*(b.y-a.y);var g=2*((b.x-a.x)*(a.x-d.x)+(b.y-a.y)*(a.y-d.y)),d=g*g-4*f*(d.x*d.x+d.y*d.y+a.x*a.x+a.y*a.y-2*(d.x*a.x+d.y*a.y)-c*c);d<0?f=new Intersection("Outside"):d==0?f=new Intersection("Tangent"):(c=Math.sqrt(d),d=(-g+c)/(2*f),g=(-g-c)/(2*f),(d<0||d>1)&&(g<0||g>1)?f=d<0&&g<0||d>1&&g>1?new Intersection("Outside"):new Intersection("Inside"):(f=new Intersection("Intersection"),0<=d&&d<=1&&f.points.push(a.lerp(b,
d)),0<=g&&g<=1&&f.points.push(a.lerp(b,g))));return f};Intersection.intersectCirclePolygon=function(d,c,a){for(var b=new Intersection("No Intersection"),f=a.length,g,e=0;e<f;e++)g=Intersection.intersectCircleLine(d,c,a[e],a[(e+1)%f]),b.appendPoints(g.points);b.status=b.points.length>0?"Intersection":g.status;return b};
Intersection.intersectCircleRectangle=function(d,c,a,b){var f=a.min(b),g=a.max(b),b=new Point2D(g.x,f.y),e=new Point2D(f.x,g.y),a=Intersection.intersectCircleLine(d,c,f,b),b=Intersection.intersectCircleLine(d,c,b,g),g=Intersection.intersectCircleLine(d,c,g,e),d=Intersection.intersectCircleLine(d,c,e,f),c=new Intersection("No Intersection");c.appendPoints(a.points);c.appendPoints(b.points);c.appendPoints(g.points);c.appendPoints(d.points);c.status=c.points.length>0?"Intersection":a.status;return c};
Intersection.intersectEllipseEllipse=function(d,c,a,b,f,g){for(var d=[a*a,0,c*c,-2*a*a*d.x,-2*c*c*d.y,a*a*d.x*d.x+c*c*d.y*d.y-c*c*a*a],b=[g*g,0,f*f,-2*g*g*b.x,-2*f*f*b.y,g*g*b.x*b.x+f*f*b.y*b.y-f*f*g*g],f=Intersection.bezout(d,b).getRoots(),g=(d[0]*d[0]+2*d[1]*d[1]+d[2]*d[2])*0.0010,c=(b[0]*b[0]+2*b[1]*b[1]+b[2]*b[2])*0.0010,a=new Intersection("No Intersection"),e=0;e<f.length;e++)for(var h=(new Polynomial(d[0],d[3]+f[e]*d[1],d[5]+f[e]*(d[4]+f[e]*d[2]))).getRoots(),j=0;j<h.length;j++){var k=(d[0]*
h[j]+d[1]*f[e]+d[3])*h[j]+(d[2]*f[e]+d[4])*f[e]+d[5];Math.abs(k)<g&&(k=(b[0]*h[j]+b[1]*f[e]+b[3])*h[j]+(b[2]*f[e]+b[4])*f[e]+b[5],Math.abs(k)<c&&a.appendPoint(new Point2D(h[j],f[e])))}if(a.points.length>0)a.status="Intersection";return a};
Intersection.intersectEllipseLine=function(d,c,a,b,f){var g,e=new Vector2D(b.x,b.y);g=Vector2D.fromPoints(b,f);d=new Vector2D(d.x,d.y);d=e.subtract(d);e=new Vector2D(g.x/(c*c),g.y/(a*a));a=new Vector2D(d.x/(c*c),d.y/(a*a));c=g.dot(e);g=g.dot(a);d=d.dot(a)-1;a=g*g-c*d;a<0?g=new Intersection("Outside"):a>0?(d=Math.sqrt(a),a=(-g-d)/c,c=(-g+d)/c,(a<0||1<a)&&(c<0||1<c)?g=a<0&&c<0||a>1&&c>1?new Intersection("Outside"):new Intersection("Inside"):(g=new Intersection("Intersection"),0<=a&&a<=1&&g.appendPoint(b.lerp(f,
a)),0<=c&&c<=1&&g.appendPoint(b.lerp(f,c)))):(c=-g/c,0<=c&&c<=1?(g=new Intersection("Intersection"),g.appendPoint(b.lerp(f,c))):g=new Intersection("Outside"));return g};Intersection.intersectEllipsePolygon=function(d,c,a,b){for(var f=new Intersection("No Intersection"),g=b.length,e=0;e<g;e++){var h=Intersection.intersectEllipseLine(d,c,a,b[e],b[(e+1)%g]);f.appendPoints(h.points)}if(f.points.length>0)f.status="Intersection";return f};
Intersection.intersectEllipseRectangle=function(d,c,a,b,f){var g=b.min(f),e=b.max(f),f=new Point2D(e.x,g.y),h=new Point2D(g.x,e.y),b=Intersection.intersectEllipseLine(d,c,a,g,f),f=Intersection.intersectEllipseLine(d,c,a,f,e),e=Intersection.intersectEllipseLine(d,c,a,e,h),d=Intersection.intersectEllipseLine(d,c,a,h,g),c=new Intersection("No Intersection");c.appendPoints(b.points);c.appendPoints(f.points);c.appendPoints(e.points);c.appendPoints(d.points);if(c.points.length>0)c.status="Intersection";
return c};Intersection.intersectLineLine=function(d,c,a,b){var f,g=(b.x-a.x)*(d.y-a.y)-(b.y-a.y)*(d.x-a.x);f=(c.x-d.x)*(d.y-a.y)-(c.y-d.y)*(d.x-a.x);a=(b.y-a.y)*(c.x-d.x)-(b.x-a.x)*(c.y-d.y);a!=0?(g/=a,f/=a,0<=g&&g<=1&&0<=f&&f<=1?(f=new Intersection("Intersection"),f.points.push(new Point2D(d.x+g*(c.x-d.x),d.y+g*(c.y-d.y)))):f=new Intersection("No Intersection")):f=g==0||f==0?new Intersection("Coincident"):new Intersection("Parallel");return f};
Intersection.intersectLinePolygon=function(d,c,a){for(var b=new Intersection("No Intersection"),f=a.length,g=0;g<f;g++){var e=Intersection.intersectLineLine(d,c,a[g],a[(g+1)%f]);b.appendPoints(e.points)}if(b.points.length>0)b.status="Intersection";return b};
Intersection.intersectLineRectangle=function(d,c,a,b){var f=a.min(b),g=a.max(b),b=new Point2D(g.x,f.y),e=new Point2D(f.x,g.y),a=Intersection.intersectLineLine(f,b,d,c),b=Intersection.intersectLineLine(b,g,d,c),g=Intersection.intersectLineLine(g,e,d,c),d=Intersection.intersectLineLine(e,f,d,c),c=new Intersection("No Intersection");c.appendPoints(a.points);c.appendPoints(b.points);c.appendPoints(g.points);c.appendPoints(d.points);if(c.points.length>0)c.status="Intersection";return c};
Intersection.intersectPolygonPolygon=function(d,c){for(var a=new Intersection("No Intersection"),b=d.length,f=0;f<b;f++){var g=Intersection.intersectLinePolygon(d[f],d[(f+1)%b],c);a.appendPoints(g.points)}if(a.points.length>0)a.status="Intersection";return a};
Intersection.intersectPolygonRectangle=function(d,c,a){var b=c.min(a),f=c.max(a),a=new Point2D(f.x,b.y),g=new Point2D(b.x,f.y),c=Intersection.intersectLinePolygon(b,a,d),a=Intersection.intersectLinePolygon(a,f,d),f=Intersection.intersectLinePolygon(f,g,d),d=Intersection.intersectLinePolygon(g,b,d),b=new Intersection("No Intersection");b.appendPoints(c.points);b.appendPoints(a.points);b.appendPoints(f.points);b.appendPoints(d.points);if(b.points.length>0)b.status="Intersection";return b};
Intersection.intersectRayRay=function(d,c,a,b){var f;f=(b.x-a.x)*(d.y-a.y)-(b.y-a.y)*(d.x-a.x);var g=(c.x-d.x)*(d.y-a.y)-(c.y-d.y)*(d.x-a.x),a=(b.y-a.y)*(c.x-d.x)-(b.x-a.x)*(c.y-d.y);a!=0?(g=f/a,f=new Intersection("Intersection"),f.points.push(new Point2D(d.x+g*(c.x-d.x),d.y+g*(c.y-d.y)))):f=f==0||g==0?new Intersection("Coincident"):new Intersection("Parallel");return f};
Intersection.intersectRectangleRectangle=function(d,c,a,b){var f=d.min(c),g=d.max(c),c=new Point2D(g.x,f.y),e=new Point2D(f.x,g.y),d=Intersection.intersectLineRectangle(f,c,a,b),c=Intersection.intersectLineRectangle(c,g,a,b),g=Intersection.intersectLineRectangle(g,e,a,b),a=Intersection.intersectLineRectangle(e,f,a,b),b=new Intersection("No Intersection");b.appendPoints(d.points);b.appendPoints(c.points);b.appendPoints(g.points);b.appendPoints(a.points);if(b.points.length>0)b.status="Intersection";
return b};Intersection.bezout=function(d,c){var a=d[0]*c[1]-c[0]*d[1],b=d[0]*c[2]-c[0]*d[2],f=d[0]*c[3]-c[0]*d[3],g=d[0]*c[4]-c[0]*d[4],e=d[0]*c[5]-c[0]*d[5],h=d[1]*c[2]-c[1]*d[2],j=d[3]*c[5]-c[3]*d[5],k=d[1]*c[5]-c[1]*d[5]+(d[3]*c[4]-c[3]*d[4]),l=d[1]*c[4]-c[1]*d[4]-(d[2]*c[3]-c[2]*d[3]);return new Polynomial(a*h-b*b,a*l+f*h-2*b*g,a*k+f*l-g*g-2*b*e,a*j+f*k-2*g*e,f*j-e*e)};var debug={showids:false,magnetism:false,connector:false,snapTo:false},colors={defaultTrackFill:"#FFFFFF",defaultTrackStroke:"#A0998A",defaultSelectedTrackFill:"#FCF688",defaultSelectedTrackStroke:"#A0998A",smallTemplateTrackFill:"#A0998A",defaultDialTickStoke:"rgba(0,0,0,0.2)",gridBackground:"#0b9ad3",gridMainLine:"#21a2d6",gridSecondaryLine:"#33aada",mapViewBackground:"rgba(255,255,255,0.4)",mapViewViewport:"rgba(11,154,211,0.4)",bogieMagnetPoint:"rgba(132,119,123,0.7)",carriageFill:"rgba(175,71,95,0.5)",
carriageStroke:"#FFFFFF",arrow:"#204665",arrowHover:"#F1F3AE",tracksDrawerFill:"rgba(255,255,255,0.4)"},config={minimumLibraryVersion:1,pathPrecision:20,maxFPS:30,influenceRadiusMultiplier:2.3,influenceRadiusForConnectors:4,mapViewZoomLevel:0.2,gridMain:200,gridSecondary:5,defaultTemplate:"defaultTemplate",defaultTrackStroke:3,smallTemplate:"smallTemplate",useDefaultLibrary:true,minimumLibraryVersion:1},LIBRARY={data:{version:"1",tracks:[{name:"ShortStraightTrack",vendor:"BRIO",reference:"33334",
regX:"50",regY:"20",influence:"40",connectors:[{name:"cA",type:"FEMALE",p1:{x:"0",y:"0"},p2:{x:"0",y:"40"}},{name:"cB",type:"MALE",p1:{x:"90",y:"40"},p2:{x:"90",y:"0"}}],segments:[{type:"LINE",connectorA:"cA",connectorB:"cB"}],graphics:[{op:"startStroke"},{op:"startFill"},{op:"move",x:"100",y:"20"},{op:"bezier",cp1x:"100",cp1y:"14.6",cp2x:"95.4",cp2y:"10.2",x:"90.0",y:"10.1"},{op:"line",x:"90",y:"0"},{op:"line",x:"0",y:"0"},{op:"line",x:"0",y:"10"},{op:"bezier",cp1x:"5.4",cp1y:"10.2",cp2x:"9.8",cp2y:"14.6",
x:"9.8",y:"20"},{op:"bezier",cp1x:"9.8",cp1y:"25.4",cp2x:"5.4",cp2y:"29.8",x:"0.0",y:"30"},{op:"line",x:"0",y:"40"},{op:"line",x:"90",y:"40"},{op:"line",x:"90",y:"30"},{op:"bezier",cp1x:"95.4",cp1y:"29.8",cp2x:"99.8",cp2y:"25.4",x:"99.8",y:"20"}]},{name:"LargeCurvedTrack",vendor:"BRIO",reference:"33342",regX:"88",regY:"23",influence:"50",connectors:[{name:"cA",type:"MALE",p1:{x:"0",y:"36.7"},p2:{x:"28",y:"65"}},{name:"cB",type:"FEMALE",p1:{x:"148",y:"65"},p2:{x:"176",y:"37"}}],segments:[{type:"BEZIER",
connectorA:"cA",connectorB:"cB",cp1:{x:"67.6",y:"9"},cp2:{x:"112.9",y:"9"}}],graphics:[{op:"startStroke"},{op:"startFill"},{op:"move",x:"152.5",y:"50.4"},{op:"bezier",cp1x:"152.5",cp1y:"44.9",cp2x:"157.0",cp2y:"40.4",x:"162.5",y:"40.4"},{op:"bezier",cp1x:"165.3",cp1y:"40.4",cp2x:"167.9",cp2y:"41.6",x:"169.7",y:"43.4"},{op:"bezier",cp1x:"171.9",cp1y:"41.2",cp2x:"174.1",cp2y:"39.0",x:"176.3",y:"36.9"},{op:"bezier",cp1x:"176.4",cp1y:"36.8",cp2x:"176.5",cp2y:"36.7",x:"176.6",y:"36.6"},{op:"bezier",cp1x:"127.8",
cp1y:"-12.2",cp2x:"48.8",cp2y:"-12.2",x:"0.0",y:"36.6"},{op:"bezier",cp1x:"2.4",cp1y:"39.0",cp2x:"4.8",cp2y:"41.4",x:"7.2",y:"43.8"},{op:"bezier",cp1x:"5.4",cp1y:"45.6",cp2x:"4.3",cp2y:"48.1",x:"4.3",y:"50.9"},{op:"bezier",cp1x:"4.3",cp1y:"56.4",cp2x:"8.8",cp2y:"60.9",x:"14.3",y:"60.9"},{op:"bezier",cp1x:"17.1",cp1y:"60.9",cp2x:"19.6",cp2y:"59.7",x:"21.4",y:"57.9"},{op:"bezier",cp1x:"23.7",cp1y:"60.2",cp2x:"26.0",cp2y:"62.5",x:"28.3",y:"64.9"},{op:"bezier",cp1x:"61.4",cp1y:"31.7",cp2x:"115.1",cp2y:"31.7",
x:"148.3",y:"64.9"},{op:"bezier",cp1x:"150.7",cp1y:"62.4",cp2x:"153.1",cp2y:"60.0",x:"155.6",y:"57.6"},{op:"bezier",cp1x:"153.7",cp1y:"55.7",cp2x:"152.5",cp2y:"53.2",x:"152.5",y:"50.4"}]},{name:"CurvedSwitchingTrack",vendor:"BRIO",reference:"33346",regX:"80",regY:"67",influence:"50",connectors:[{name:"cA",type:"FEMALE",p1:{x:"0",y:"0"},p2:{x:"0",y:"40"}},{name:"cB",type:"MALE",p1:{x:"150",y:"40"},p2:{x:"150",y:"0"}},{name:"cC",type:"MALE",p1:{x:"25",y:"125"},p2:{x:"65",y:"125"}}],segments:[{type:"LINE",
connectorA:"cA",connectorB:"cB"},{type:"BEZIER",connectorA:"cB",connectorB:"cC",cp1:{x:"66.5",y:"20"},cp2:{x:"44",y:"88"}}],switches:[{source:"cB",connectorsArray:["cA","cC"],position:"0"}],graphics:[{op:"startStroke"},{op:"startFill"},{op:"move",x:"150",y:"10.1"},{op:"line",x:"150",y:"9.8"},{op:"bezier",cp1x:"150.0",cp1y:"6.7",cp2x:"150",cp2y:"3.6",x:"150",y:"0.5"},{op:"bezier",cp1x:"150",cp1y:"0.3",cp2x:"150",cp2y:"0.2",x:"150",y:"0.1"},{op:"line",x:"150",y:"0"},{op:"line",x:"0",y:"0"},{op:"line",
x:"0",y:"10.1"},{op:"bezier",cp1x:"5.4",cp1y:"10.2",cp2x:"9.8",cp2y:"14.6",x:"9.8",y:"20.0"},{op:"bezier",cp1x:"9.8",cp1y:"25.4",cp2x:"5.4",cp2y:"29.8",x:"0.0",y:"29.9"},{op:"line",x:"0",y:"40"},{op:"line",x:"58.7",y:"40"},{op:"bezier",cp1x:"38.1",cp1y:"62.3",cp2x:"25.5",cp2y:"92.2",x:"25.5",y:"125.0"},{op:"bezier",cp1x:"28.9",cp1y:"125.0",cp2x:"32.3",cp2y:"125.0",x:"35.7",y:"125.0"},{op:"bezier",cp1x:"35.7",cp1y:"127.0",cp2x:"36.7",cp2y:"130.1",x:"38.6",y:"132.0"},{op:"bezier",cp1x:"42.5",cp1y:"136",
cp2x:"48.9",cp2y:"136",x:"52.8",y:"132.1"},{op:"bezier",cp1x:"54.7",cp1y:"130.1",cp2x:"55.7",cp2y:"127.0",x:"55.7",y:"125.0"},{op:"bezier",cp1x:"59.0",cp1y:"125.0",cp2x:"62.2",cp2y:"125.0",x:"65.5",y:"125.0"},{op:"bezier",cp1x:"65.5",cp1y:"78.0",cp2x:"103.0",cp2y:"40.1",x:"150.0",y:"40.1"},{op:"bezier",cp1x:"150.0",cp1y:"40.1",cp2x:"150.0",cp2y:"40.0",x:"150.0",y:"40.0"},{op:"bezier",cp1x:"150.0",cp1y:"36.6",cp2x:"150.0",cp2y:"33.3",x:"150.0",y:"29.9"},{op:"bezier",cp1x:"155.4",cp1y:"29.8",cp2x:"159.8",
cp2y:"25.4",x:"159.8",y:"20.0"},{op:"bezier",cp1x:"159.8",cp1y:"14.6",cp2x:"155.4",cp2y:"10.2",x:"150.0",y:"10.1"}]}]}};(function(d){function c(){this.initialize()}c.prototype.initialize=function(){this.loadLibrary()};c.prototype.loadLibrary=function(){this.library={};if(config.useDefaultLibrary)this.library=LIBRARY.data;this.library.version<config.minimumLibraryVersion&&console.fatal("Library.prototype.loadLibrary : wrong library version number")};c.prototype.getTrackConfig=function(a){for(var b in this.library.tracks)if(this.library.tracks[b].name==a)return this.library.tracks[b];console.error("Library.prototype.getTrackConfig : Track "+
a+" not found");return null};d.Library=c})(window);(function(d){function c(a){this.config=library.getTrackConfig(a);this.initialize()}c.prototype=new Container;c.prototype.Container_initialize=c.prototype.initialize;c.prototype.initialize=function(){this.type="Track";this.Container_initialize();this.connectors=[];this.scaleX=this.scaleY=this.scale=1;this.vertex=null;this.selected=false;this.segments=[];this.switches=[];this.renderingContext=config.defaultTemplate;for(var a in this.config.connectors){var b=new Connector(this,this.config.connectors[a].type,
this.config.connectors[a].p1,this.config.connectors[a].p2);this.connectors[this.config.connectors[a].name]=b}for(var c in this.config.switches){a=[];for(var d in this.config.switches[c].connectorsArray)a.push(this.connectors[this.config.switches[c].connectorsArray[d]]);this.addSwitch(this.config.switches[c].source,a,parseInt(this.config.switches[c].position))}for(var e in this.config.segments)d=c=void 0,this.config.segments[e].cp1&&(c=new Point2D(parseFloat(this.config.segments[e].cp1.x),parseFloat(this.config.segments[e].cp1.y))),
this.config.segments[e].cp2&&(d=new Point2D(parseFloat(this.config.segments[e].cp2.x),parseFloat(this.config.segments[e].cp2.y))),this.addSegment(new Segment(this.config.segments[e].type,this.connectors[this.config.segments[e].connectorA],this.connectors[this.config.segments[e].connectorB],c,d));this.regX=parseFloat(this.config.regX);this.regY=parseFloat(this.config.regY);this.influence=parseFloat(this.config.influence);for(var h in this.connectors)this.connectors[h].setRegistrationPoint(this.regX,
this.regY);for(h in this.segments)this.segments[h].setRegistrationPoint(this.regX,this.regY);this.trackShape=new Shape;this.trackShape.snapToPixel=true;this.trackPivot=new Shape;this.trackPivot.snapToPixel=true;this.addChild(this.trackShape);this.addChild(this.trackPivot);if(debug.showids)this.trackText=new Text,this.trackText.text=this.id,this.trackText.x=this.regX,this.trackText.y=this.regY,this.addChild(this.trackText);this.makeShape()};c.prototype.setRenderingContext=function(a){this.renderingContext=
a;this.makeShape()};c.prototype.getCoord=function(){return new Point2D(this.x,this.y)};c.prototype.onPress=function(a){var b=this.x-a.stageX,c=this.y-a.stageY,d=this;railroad.selection.reset();if(a.nativeEvent.shiftKey)railroad.selection.add(this);else{var e=new DepthFirstSearch(railroad.graph.getVertices(),this.vertex),h;for(h in e.preorder)railroad.selection.add(railroad.tracks[e.preorder[h]])}railroad.showRotationDial(railroad.selection);railroad.startDrag();a.onMouseMove=function(a){railroad.hideRotationDial();
x=a.stageX+b;y=a.stageY+c;d.moveWithSelection(x,y);railroad.startMagnetism();setDirty()};a.onMouseUp=function(){railroad.endDrag()}};c.prototype.onMouseOver=function(){setDirty()};c.prototype.onMouseOut=function(){setDirty()};c.prototype.move=function(a,b){this.x=a;this.y=b;for(var c in this.connectors)this.connectors[c].move(a,b);for(c=0;c<this.segments.length;c++)this.segments[c].move(a,b)};c.prototype.moveBy=function(a,b){this.move(this.x+a,this.y+b)};c.prototype.moveWithSelection=function(a,b){railroad.selection.move(a-
this.x,b-this.y)};c.prototype.rotate=function(a){this.rotation=a;var b=new Point2D(this.x,this.y),c;for(c in this.connectors)this.connectors[c].rotate(a,b);for(c=0;c<this.segments.length;c++)this.segments[c].rotate(a,b)};c.prototype.setColor=function(a){this.color=a;this.makeShape()};c.prototype.getFillColor=function(){return this.selected?colors.defaultSelectedTrackFill:this.renderingContext==config.smallTemplate?colors.smallTemplateTrackFill:this.color===void 0?colors.defaultTrackFill:this.color};
c.prototype.getStrokeColor=function(){return this.selected?colors.defaultSelectedTrackStroke:colors.defaultTrackStroke};c.prototype.getStrokeWidth=function(){return config.defaultTrackStroke};c.prototype.resetConnections=function(){for(var a in this.connectors)this.connectors[a].resetConnection()};c.prototype.setSelection=function(a){if(a!=this.selected)this.selected=a,this.makeShape()};c.prototype.addSegment=function(a){this.segments.push(a)};c.prototype.getSegmentTo=function(a){for(var b=[],c=0;c<
this.segments.length;c++)(this.segments[c].connectorA==a||this.segments[c].connectorB==a)&&b.push(this.segments[c]);if(b.length==0)console.error("Track.prototype.getSegmentTo : connector without any segment");else{if(b.length==1)return b[0];for(var c=this.switches[a].getCurrentTarget(),d=0;d<b.length;d++)if(b[d].hasConnectors(a,c))return b[d];console.error("Track.prototype.getSegmentTo : segment not found")}};c.prototype.getAllPoints=function(){var a=[],b;for(b in this.segments)a=this.segments[b].getPoints(a);
return a};c.prototype.addSwitch=function(a,b,c){this.switches[a]=new Switch(b,c)};c.prototype.makeShape=function(){var a=this.trackShape.graphics;a.clear();var b,c;for(c in this.config.graphics)switch(b=this.config.graphics[c],b.op){case "line":a.lineTo(b.x,b.y);break;case "bezier":a.bezierCurveTo(b.cp1x,b.cp1y,b.cp2x,b.cp2y,b.x,b.y);break;case "move":a.moveTo(b.x,b.y);break;case "startStroke":a.setStrokeStyle(this.getStrokeWidth());a.beginStroke(this.getStrokeColor());break;case "startFill":a.beginFill(this.getFillColor());
break;default:console.error("Track.prototype.makeShape : unknown operation : "+b.op)}setDirty()};d.Track=c})(window);(function(d){function c(){this.initialize()}c.prototype=new Container;c.prototype.Container_initialize=c.prototype.initialize;c.prototype.initialize=function(){this.type="TracksDrawer";this.templates=[];this.Container_initialize();this.drawerShape=new Shape;this.drawerShape.snapToPixel=true;this.addChild(this.drawerShape)};c.prototype.resetAllTemplates=function(){this.templates=[];this.makeShape()};c.prototype.addTemplate=function(a){this.templates.indexOf(a)==-1&&(this.templates.push(a),this.makeShape())};
c.prototype.makeShape=function(){var a=60;if(this.templates.length!=0){for(var b in this.templates){var c=new Track(this.templates[b]);c.setRenderingContext(config.smallTemplate);c.onPress=function(a){var b=new Track(this.config.name);railroad.addTrack(b);b.x=a.stageX;b.y=a.stageY;b.onPress(a)};c.scaleX=0.5;c.scaleY=0.5;this.addChild(c);c.x=a;c.y=45;a+=100}b=this.drawerShape.graphics;b.clear();b.beginFill(colors.tracksDrawerFill);b.rect(0,0,a-100+80,90);this.x=20;this.y=backgroundGrid.visibleHeight-
120}};d.TracksDrawer=c})(window);function Segment(d,c,a,b,f){if(arguments.length>0)d!="LINE"&&d!="BEZIER"?console.error("Segment.js : unknown type "+d):(this.type=d,b===void 0&&(b=new Point2D),f===void 0&&(f=new Point2D),this.connectorA=c,this.connectorB=a,this.cp1=b,this.cp2=f,this.previousPoint=new Point2D,this.angle=0)}Segment.prototype.getStartPoint=function(){return this.connectorA.getCenter()};Segment.prototype.getEndPoint=function(){return this.connectorB.getCenter()};
Segment.prototype.setRegistrationPoint=function(d,c){if(this.type!="LINE")this.cp1.rmoveto(-d,-c),this.cp2.rmoveto(-d,-c),this.previousPoint.x=0,this.previousPoint.y=0};Segment.prototype.moveBy=function(d,c){this.type!="LINE"&&(this.cp1.rmoveto(d,c),this.cp2.rmoveto(d,c))};Segment.prototype.move=function(d,c){if(this.type!="LINE")this.moveBy(d-this.previousPoint.x,c-this.previousPoint.y),this.previousPoint.x=d,this.previousPoint.y=c};
Segment.prototype.rotate=function(d,c){if(this.type!="LINE"){var a=d-this.angle;this.angle=d;this.cp1.rotate(a,c);this.cp2.rotate(a,c)}};Segment.prototype.hasConnectors=function(d,c){return d==this.connectorA&&c==this.connectorB?true:c==this.connectorA&&d==this.connectorB?true:false};
Segment.prototype.getPoints=function(d,c){d===void 0&&(d=[]);c===void 0&&(c=false);var a=new Point2D,b=new Point2D,f=new Point2D,g=new Point2D;c?(a=this.connectorB.getCenter(),b=this.connectorA.getCenter(),f=this.cp2,g=this.cp1):(a=this.connectorA.getCenter(),b=this.connectorB.getCenter(),f=this.cp1,g=this.cp2);var e=new Path;this.type=="BEZIER"&&e.addBezier([a,f,g,b]);this.type=="LINE"&&e.addLine(a,b);for(a=0;a<100;a+=100/config.pathPrecision)b=e.atT(a/100),b.segment=this,b.position=config.pathPrecision*
a/100,d.push(b);return d};var Connector=Class.extend({init:function(d,c,a,b){this.track=d;this.type=c;this.p1=new Point2D(parseFloat(a.x),parseFloat(a.y));this.p2=new Point2D(parseFloat(b.x),parseFloat(b.y));this.previous=new Point2D(0,0);this.angle=0;this.edge=null;this.shape=new Shape;this.shapeDraw();stage.addChild(this.shape)},evalType:function(){return this.type=="MALE"?1:0},shapeDraw:function(){debug.connector&&(this.shape.graphics.clear(),this.shape.graphics.endFill(),this.shape.graphics.setStrokeStyle(4),this.edge?
color="#B92233":color="#434238",this.shape.graphics.beginStroke(color),this.shape.graphics.moveTo(this.p1.x,this.p1.y).lineTo(this.p2.x,this.p2.y),this.edge?stroke=4:stroke=1,this.shape.graphics.setStrokeStyle(stroke).beginStroke("#fff"),this.shape.graphics.beginFill("#961B2E"),this.shape.graphics.drawEllipse(this.p1.x-5,this.p1.y-5,10,10),this.shape.graphics.beginFill("#24734B"),this.shape.graphics.drawEllipse(this.p2.x-5,this.p2.y-5,10,10),setDirty())},setRegistrationPoint:function(d,c){this.p1.rmoveto(-d,
-c);this.p2.rmoveto(-d,-c);this.shapeDraw()},getDistance:function(d){var c=[];c.push(this.p1.distanceFrom(d.p1));c.push(this.p1.distanceFrom(d.p2));c.push(this.p2.distanceFrom(d.p1));c.push(this.p2.distanceFrom(d.p2));return Math.min.apply(null,c)},move:function(d,c){dx=d-this.previous.x;dy=c-this.previous.y;this.p1.rmoveto(dx,dy);this.p2.rmoveto(dx,dy);this.previous.x=d;this.previous.y=c;this.shapeDraw()},rotate:function(d,c){var a=d-this.angle;this.angle=d;c===void 0?console.error("Connector.rotate : pivotPoint undefined"):
(this.p1.rotate(a,c),this.p2.rotate(a,c),this.shapeDraw())},match:function(d){return this.edge||d.edge?false:this.type!=d.type?true:false},connectTo:function(d){this.edge=d;d.edge=this},getCenter:function(){return new Point2D((this.p1.x+this.p2.x)/2,(this.p1.y+this.p2.y)/2)},resetConnection:function(){if(this.edge){if(this.edge.edge)this.edge.edge=null;this.edge=null}}});(function(d){function c(a,b){this.type="Grid";this.visibleWidth=a;this.visibleHeight=b;this.width=this.visibleWidth+2*config.gridMain;this.height=this.visibleHeight+2*config.gridMain;this.absoluteY=this.absoluteX=0;this.initialize()}c.prototype=new Shape;c.prototype.Shape_initialize=c.prototype.initialize;c.prototype.initialize=function(){this.Shape_initialize();this.snapToPixel=true;this.regX=this.width/2;this.regY=this.height/2;this.x=-config.gridMain;this.y=-config.gridMain;this.makeShape();this.clickWasADrag=
false};c.prototype.onPress=function(a){railroad.hideRotationDial();this.dx=this.x;this.dy=this.y;var b=this.x-a.stageX,c=this.y-a.stageY,d=this;this.clickWasADrag=false;a.onMouseMove=function(a){d.move(a.stageX+b,a.stageY+c);d.clickWasADrag=true;setDirty()};a.onMouseUp=function(){d.clickWasADrag||railroad.selection.reset()}};c.prototype.move=function(a,b){var c=a-this.dx,d=b-this.dy;this.dx=a;this.dy=b;this.absoluteX+=c;this.absoluteY+=d;railroad.moveAllTracks(c,d);this.x=this.absoluteX%config.gridMain+
this.regX-config.gridMain;this.y=this.absoluteY%config.gridMain+this.regY-config.gridMain};c.prototype.makeShape=function(){var a=this.graphics;a.clear();a.beginFill(colors.gridBackground);a.rect(0,0,this.width,this.height);for(var b=0;b<this.width;b+=config.gridMain/config.gridSecondary)a.setStrokeStyle(1),b%config.gridMain?color=colors.gridMainLine:color=colors.gridSecondaryLine,a.beginStroke(color),a.moveTo(b,0).lineTo(b,this.height);for(b=0;b<this.height;b+=config.gridMain/config.gridSecondary)a.setStrokeStyle(1),
b%config.gridMain?color=colors.gridMainLine:color=colors.gridSecondaryLine,a.beginStroke(color),a.moveTo(0,b).lineTo(this.width,b);this.cache(0,0,this.width,this.height)};c.prototype.resetView=function(){this.dx=this.visibleWidth/2;this.dy=this.visibleHeight/2;this.move(this.dx-this.absoluteX,this.dy-this.absoluteY);setDirty()};c.prototype.onDoubleClick=function(){this.resetView()};c.prototype.absolutizePoint=function(a){var b=new Point2D;b.x=a.x-this.absoluteX;b.y=a.y-this.absoluteY;return b};d.Grid=
c})(window);(function(d){function c(a,b,c,d){this.type="MapView";this.zoomFactor=b;this.gridWidth=a.visibleWidth;this.gridHeight=a.visibleHeight;this.originalGrid=a;this.width=c;this.height=d;this.x=this.gridWidth-this.width/2-20;this.y=this.gridHeight-this.height/2-20;this.rectangleMask={};this.rectangleMask.x=-this.width/2;this.rectangleMask.y=-this.height/2;this.rectangleMask.width=this.width;this.rectangleMask.height=this.height;this.initialize()}c.prototype=new SimpleMaskContainer;c.prototype.SimpleMaskContainer_initialize=
c.prototype.initialize;c.prototype.initialize=function(){this.SimpleMaskContainer_initialize();this.background=new Shape;this.background.snapToPixel=true;this.background.width=this.width;this.background.height=this.height;this.background.regX=this.width/2;this.background.regY=this.height/2;this.map=new Shape;this.map.snapToPixel=true;this.map.scaleX=this.zoomFactor;this.map.scaleY=this.zoomFactor;this.map.width=this.gridWidth;this.map.height=this.gridHeight;this.map.regX=this.map.width/2;this.map.regY=
this.map.height/2;this.addChild(this.background);this.addChild(this.map)};c.prototype.makeShape=function(){var a=this.background.graphics;a.clear();a.beginFill(colors.mapViewBackground);a.rect(0,0,this.width,this.height).endFill();a=this.map.graphics;a.clear();for(var b in railroad.tracks)this.drawPath(railroad.tracks[b],a);a.beginFill(colors.mapViewViewport).setStrokeStyle(1/this.zoomFactor).beginStroke("#000");a.rect(-this.originalGrid.absoluteX,-this.originalGrid.absoluteY,this.gridWidth,this.gridHeight);
a.endFill()};c.prototype.refresh=function(){this.makeShape()};c.prototype.drawPath=function(a,b){for(var c in a.segments){var d=backgroundGrid.absolutizePoint(a.segments[c].connectorA.getCenter()),e=backgroundGrid.absolutizePoint(a.segments[c].connectorB.getCenter());b.endFill().setStrokeStyle(5/this.zoomFactor).beginStroke("#000");a.segments[c].type=="LINE"?b.moveTo(d.x,d.y).lineTo(e.x,e.y).closePath():(cp1=backgroundGrid.absolutizePoint(a.segments[c].cp1),cp2=backgroundGrid.absolutizePoint(a.segments[c].cp2),
b.moveTo(d.x,d.y).bezierCurveTo(cp1.x,cp1.y,cp2.x,cp2.y,e.x,e.y))}for(var h in a.connectors)b.endFill().setStrokeStyle(1/this.zoomFactor).beginStroke("#000"),c=backgroundGrid.absolutizePoint(a.connectors[h].p1),d=backgroundGrid.absolutizePoint(a.connectors[h].p2),b.moveTo(c.x,c.y).lineTo(d.x,d.y).closePath()};c.prototype.onPress=function(a){a.onMouseMove=function(){};a.onMouseUp=function(){}};d.MapView=c})(window);(function(d){function c(){this.initialize()}c.prototype=new Shape;c.prototype.Shape_initialize=c.prototype.initialize;c.prototype.initialize=function(){this.Shape_initialize();this.snapToPixel=true};c.prototype.clear=function(){this.graphics.clear();this.target=this.source=null;setDirty()};c.prototype.glue=function(a,b){if(a&&b){this.source=a;this.target=b;var c=this.graphics;c.clear();var d=new Point2D,e=false,d=this.getLineIntersection(this.source,this.target,e);d.status!="Intersection"&&(e=true,
d=this.getLineIntersection(this.source,this.target,e));if(d.status=="Intersection")d=d.intersection,e?c.beginFill("#1F3333").setStrokeStyle(1).beginStroke("#434238").moveTo(this.source.p1.x,this.source.p1.y).quadraticCurveTo(d.x,d.y,this.target.p1.x,this.target.p1.y).lineTo(this.target.p2.x,this.target.p2.y).quadraticCurveTo(d.x,d.y,this.source.p2.x,this.source.p2.y).lineTo(this.source.p1.x,this.source.p1.y).closePath():c.setStrokeStyle(1).beginStroke("#434238").beginFill("#403835").moveTo(this.source.p1.x,
this.source.p1.y).quadraticCurveTo(d.x,d.y,this.target.p2.x,this.target.p2.y).lineTo(this.target.p1.x,this.target.p1.y).quadraticCurveTo(d.x,d.y,this.source.p2.x,this.source.p2.y).lineTo(this.source.p1.x,this.source.p1.y).closePath()}};c.prototype.getLineIntersection=function(a,b,c){var d={},e=new Point2D,h=new Point2D,j=new Point2D,k=new Point2D;c===void 0&&(c=false);c?(e=a.p1,h=b.p2,j=a.p2,k=b.p1):(e=a.p1,h=b.p1,j=a.p2,k=b.p2);b=(k.x-j.x)*(e.y-j.y)-(k.y-j.y)*(e.x-j.x);a=(h.x-e.x)*(e.y-j.y)-(h.y-
e.y)*(e.x-j.x);j=(k.y-j.y)*(h.x-e.x)-(k.x-j.x)*(h.y-e.y);j!=0?(k=b/j,j=a/j,0<=k&&k<=1&&0<=j&&j<=1?(d.status="Intersection",d.intersection=new Point2D(e.x+k*(h.x-e.x),e.y+k*(h.y-e.y))):d.status="No Intersection"):d.status=b==0||a==0?"Coincident":"Parallel";return d};d.Gizmo=c})(window);(function(d){function c(){var a=[];a.push.apply(a,arguments);a.__proto__=c.prototype;return a}c.prototype=[];c.prototype.add=function(a){typeof a=="array"?this.addArray(a):this.addOne(a)};c.prototype.addOne=function(a){a!==void 0&&this.indexOf(a)===-1&&(this.push(a),a.setSelection(true))};c.prototype.addArray=function(a){a instanceof Array||(n_tracksArray=[],n_tracksArray.push(a),a=n_tracksArray);for(var b in a)this.add(a[b])};c.prototype.set=function(a){for(var b in a)this.selection.indexOf(a[b])==
-1?this.add(a[b]):this.remove(a[b])};c.prototype.remove=function(a){a.setSelection(false);a=this.indexOf(a);a!=-1&&this.splice(a,1)};c.prototype.reset=function(){for(var a=this.length-1;a>=0;a--)this.remove(this[a])};c.prototype.clear=function(){this.reset();railroad.rotationDial.hide()};c.prototype.rebuildConnections=function(){};c.prototype.removeConnections=function(){};c.prototype.getCenter=function(){for(var a=new Point2D,b=0,c=0,d=0;d<this.length;d++)b+=this[d].x,c+=this[d].y;a.x=b/this.length;
a.y=c/this.length;return a};c.prototype.move=function(a,b){for(var c=0;c<this.length;c++)this[c].moveBy(a,b)};c.prototype.rotate=function(){};d.Selection=c})(window);(function(d){function c(){this.type="RotationDial";this.initialize()}c.prototype=new Shape;c.prototype.Shape_initialize=c.prototype.initialize;c.prototype.initialize=function(){this.Shape_initialize();this.visible=this.selected=false;this.size=200;this.selection=null;this.makeShape()};c.prototype.show=function(){if(!(this.selection.length<2)){var a=this.selection.getCenter();this.x=a.x;this.y=a.y;this.visible=true;setDirty()}};c.prototype.hide=function(){this.visible=false;this.rotation=0;setDirty()};
c.prototype.onPress=function(a){redirectTickerToStage(true);var b=a.stageX,c=a.stageY,d=this,e=0,h;a.onMouseMove=function(a){h=d.getAngle(new Point2D(b,c),new Point2D(a.stageX,a.stageY));h-=180;delta=h-e;a.nativeEvent.shiftKey&&(delta>0?(h=d.rotation+20,delta=20):(h=d.rotation-20,delta=-20));d.rotation=h;for(a=0;a<d.selection.length;a++){var k=new Point2D(d.selection[a].x,d.selection[a].y);k.rotate(delta,new Point2D(d.x,d.y));d.selection[a].move(k.x,k.y);d.selection[a].rotate(d.selection[a].rotation+
delta)}e=h};a.onMouseUp=function(){redirectTickerToStage(false);setDirty()}};c.prototype.onMouseOver=function(){};c.prototype.onMouseOut=function(){};c.prototype.makeShape=function(){this.graphics.clear();this.graphics.beginFill("rgba(0,0,0,0.2)").drawCircle(0,0,this.size*0.3).endFill();this.createTicks(10,0.8,1,2);this.createTicks(5,0.8,0.9);this.createTicks(10,0.3,0.4);this.graphics.beginStroke("#000000");this.graphics.setStrokeStyle(3);this.graphics.moveTo(0,-this.size/2*0.1).lineTo(0,+this.size/
2*0.1).moveTo(-this.size/2*0.1,0).lineTo(+this.size/2*0.1,0).closePath();setDirty()};c.prototype.createTicks=function(a,b,c,d,e){e===void 0&&(e=this.getDialTickColor());d===void 0&&(d=1);for(var b=new Point2D(0,-this.size/2*b),c=new Point2D(0,-this.size/2*c),h=new Point2D(0,0),j=360/a,k=0;k<j;k++)this.graphics.beginStroke(e),this.graphics.setStrokeStyle(d),this.graphics.moveTo(b.x,b.y).lineTo(c.x,c.y).closePath(),b.rotate(a,h),c.rotate(a,h)};c.prototype.getDialTickColor=function(){return colors.defaultDialTickStoke};
c.prototype.getAngle=function(a,b){var c,d;c=new Point2D(this.x,this.y);d=new Point2D(a.x,a.y);var e,h;e=new Point2D(this.x,this.y);h=new Point2D(b.x,b.y);var j=d.x-c.x;c=d.y-c.y;d=e.x-h.x;e=e.y-h.y;h=Math.sqrt(j*j+c*c);var k=Math.sqrt(d*d+e*e);j/=h;c/=h;d/=k;e/=k;return(Math.atan2(e,d)-Math.atan2(c,j))/(Math.PI*2/360)};d.RotationDial=c})(window);var Railroad=Class.extend({init:function(){this.tracks=[];this.graph=new Graph;this.gizmo=new Gizmo;this.dragGestureConnection={};this.debugView=new Shape;this.selection=new Selection;this.rotationDial=new RotationDial;stage.addChild(this.rotationDial);this.forwardArrow=new Arrow;this.backwardArrow=new Arrow;stage.addChild(this.forwardArrow);stage.addChild(this.backwardArrow)},addTrack:function(d){this.tracks[d.id]=d;d.vertex=new Vertex(d.id,{track:d});this.graph.addVertex(d.vertex);stage.addChild(d)},
removeTrack:function(d){for(var c in d.connectors)stage.removeChild(d.connectors[c].shape),delete d.connectors[c];stage.removeChild(d);d=this.tracks.indexOf(d);d!=-1&&this.tracks.splice(d,1)},moveAllTracks:function(d,c){for(var a in this.tracks)this.tracks[a].moveBy(d,c)},startDrag:function(){this.dragGestureConnection.status=false;stage.addChildAt(this.gizmo,stage.getChildIndex(backgroundGrid)+1);this.disconnectAllConnector(this.selection);this.selection.length>1&&this.reconnectConnectors(this.selection)},
startMagnetism:function(){this.dragGestureConnection.status=false;if(debug.magnetism||debug.snapTo)this.debugView.graphics.clear(),stage.addChild(this.debugView);var d=this.getNeighboursTracks(this.selection);if(d.length==0)this.gizmo.clear();else{for(var c=Number.MAX_VALUE,a=0;a<d.length;a++)for(var b=0;b<this.selection.length;b++)if(target=d[a],source=this.selection[b],connectorMatchResult=this.getMatchingConnectors(source,target),connectorMatchResult.distance<c)this.dragGestureConnection.status=
true,this.dragGestureConnection.sourceTrack=source,this.dragGestureConnection.targetTrack=target,this.dragGestureConnection.sourceConnector=connectorMatchResult.source,this.dragGestureConnection.targetConnector=connectorMatchResult.target,c=connectorMatchResult.distance;this.dragGestureConnection.status?this.gizmo.glue(this.dragGestureConnection.sourceConnector,this.dragGestureConnection.targetConnector):this.gizmo.clear()}},getNeighboursTracks:function(d){d instanceof Array||(n_selection=new Selection,
n_selection.add(d),d=n_selection);var c=[],a;for(a in this.tracks){var b=this.tracks[a];if(d.indexOf(b)==-1)for(var f=0;f<d.length;f++){var g=d[f];debug.magnetism&&this.debugView.graphics.beginFill("rgba(255,237,0,0.1)").drawCircle(g.getCoord().x,g.getCoord().y,g.influence*config.influenceRadiusMultiplier);b.getCoord().distanceFrom(g.getCoord())<(b.influence+g.influence)*config.influenceRadiusMultiplier&&(debug.magnetism&&this.debugView.graphics.beginFill("rgba(0,0,0,0.1)").drawCircle(b.getCoord().x,
b.getCoord().y,b.influence*config.influenceRadiusMultiplier),c.push(b))}}return c},getMatchingConnectors:function(d,c){var a={};a.distance=Number.MAX_VALUE;for(var b in d.connectors)for(var f in c.connectors)if(d.connectors[b].match(c.connectors[f])){var g=d.connectors[b].getDistance(c.connectors[f]);if(g<a.distance)a.distance=g,a.source=d.connectors[b],a.target=c.connectors[f]}return a},endDrag:function(){this.gizmo.clear();(debug.magnetism||debug.snapTo)&&this.debugView.graphics.clear();if(this.dragGestureConnection.status!=
false){var d,c;new Point2D;new Point2D;this.dragGestureConnection.sourceConnector.p1.distanceFrom(this.dragGestureConnection.targetConnector.p2)<this.dragGestureConnection.sourceConnector.p2.distanceFrom(this.dragGestureConnection.targetConnector.p1)?(c=this.dragGestureConnection.sourceConnector.p1,d=this.dragGestureConnection.targetConnector.p2):(c=this.dragGestureConnection.sourceConnector.p2,d=this.dragGestureConnection.targetConnector.p1);var a=new Point2D(this.dragGestureConnection.sourceTrack.x,
this.dragGestureConnection.sourceTrack.y);debug.snapTo&&(this.debugView.graphics.beginFill("rgba(255,255,255,0.5)").drawCircle(c.x,c.y,10),this.debugView.graphics.beginFill("rgba(255,255,255,0.5)").drawCircle(d.x,d.y,10));dx=d.x-c.x;dy=d.y-c.y;debug.snapTo&&this.debugView.graphics.beginFill("rgba(255,0,255,0.5)").drawCircle(a.x,a.y,20);a.rmoveto(dx,dy);debug.snapTo&&this.debugView.graphics.beginFill("rgba(255,255,0,0.5)").drawCircle(a.x,a.y,20);var b=this.dragGestureConnection.sourceTrack.rotation;
c=Math.round(this.getAngle(this.dragGestureConnection.sourceConnector,this.dragGestureConnection.targetConnector));b+=c;a.rotate(c,d);debug.snapTo&&this.debugView.graphics.beginFill("rgba(255,127,127,0.5)").drawCircle(a.x,a.y,10);redirectTickerToStage(true);Tween.get(this.dragGestureConnection.sourceTrack).to({x:a.x,y:a.y,rotation:b},400).call(this.dragGestureConnection.sourceTrack.move,[a.x,a.y]).call(this.dragGestureConnection.sourceTrack.rotate,[b]).call(this.snapSelectionAlong,[this.dragGestureConnection.sourceTrack,
dx,dy,c,d],this).call(this.reconnectConnectorsWithinNeighbourhood,this.selection,this).call(this.extendSelection,[this.dragGestureConnection.sourceTrack],this).call(this.showRotationDial,[this.selection],this).call(redirectTickerToStage,[false])}},snapSelectionAlong:function(d,c,a,b,f){for(var g=0;g<this.selection.length;g++)if(this.selection[g]!=d){var e=new Point2D(this.selection[g].x,this.selection[g].y);e.rmoveto(c,a);e.rotate(b,f);this.selection[g].rotate(this.selection[g].rotation+b);this.selection[g].move(e.x,
e.y)}},connect:function(d,c,a,b){d.connectTo(c);this.graph.addEdge(new Edge(a.id,b.id,{}))},disconnectAllConnector:function(d){for(var c=0;c<d.length;c++){var a=d[c];a.resetConnections();neighbours=a.vertex.getNeighbours();for(var b in neighbours){for(c=0;c<d.length;c++);this.graph.deleteEdge(new Edge(a.vertex.label,b,{}))}}},reconnectConnectorsWithinNeighbourhood:function(d){var c=railroad.getNeighboursTracks(d,railroad.tracks),a=new Selection;a.addArray(d);a.addArray(c);railroad.reconnectConnectors(a);
a.clear()},reconnectConnectors:function(d){for(var c=0;c<d.length;c++)for(var a=0;a<d.length;a++){var b=d[c],f=d[a];if(b.id!=f.id)for(var g in b.connectors)for(var e in f.connectors)b.connectors[g].match(f.connectors[e])&&(b.connectors[g].p1.closeTo(f.connectors[e].p2,config.influenceRadiusForConnectors)||b.connectors[g].p1.closeTo(f.connectors[e].p1,config.influenceRadiusForConnectors))&&railroad.connect(b.connectors[g],f.connectors[e],b,f)}},extendSelection:function(d){this.selection.clear();var d=
new DepthFirstSearch(this.graph.getVertices(),d.vertex),c;for(c in d.preorder)this.selection.add(this.tracks[d.preorder[c]]);setDirty()},getAngle:function(d,c){var a=d.p2.x-d.p1.x,b=d.p2.y-d.p1.y,f=c.p1.x-c.p2.x,g=c.p1.y-c.p2.y,e=Math.sqrt(a*a+b*b),h=Math.sqrt(f*f+g*g);a/=e;b/=e;f/=h;g/=h;return(Math.atan2(g,f)-Math.atan2(b,a))/(Math.PI*2/360)},showRotationDial:function(d){topmost=stage.getNumChildren();stage.addChildAt(this.rotationDial,topmost);this.rotationDial.selection=d;this.rotationDial.show();
Ticker.removeListener(stage);Ticker.addListener(window)},hideRotationDial:function(){this.rotationDial.hide()},hideArrows:function(){redirectTickerToStage(true);Tween.get(this.forwardArrow).to({alpha:0},300).call(this.forwardArrow.hide,[true],this);Tween.get(this.backwardArrow).to({alpha:0},300).call(this.backwardArrow.hide,[true],this).call(redirectTickerToStage,[false])}});(function(d){function c(){this.type="Bogie";this.initialize()}c.prototype=new Container;c.prototype.Container_initialize=c.prototype.initialize;c.prototype.initialize=function(){this.Container_initialize();this.bogie=new Shape;this.bogie.snapToPixel=true;this.makeShape();this.addChild(this.bogie);this.snappedPoint=new Point2D;this.snappedSegment={};this.snapped=false;this.targetConnector=null;this.pointsInPath=[];this.indexInPath=0};c.prototype.makeShape=function(){var a=this.bogie.graphics;a.clear();
a.beginFill(colors.bogieMagnetPoint);a.drawCircle(0,0,10);a.endFill();setDirty()};c.prototype.onPress=function(a){railroad.hideRotationDial();railroad.forwardArrow.hide();railroad.backwardArrow.hide();var b=this.x-a.stageX,c=this.y-a.stageY,d=this;a.onMouseMove=function(a){x=a.stageX+b;y=a.stageY+c;d.moveWithMagnetism(x,y)};a.onMouseUp=function(){}};c.prototype.move=function(a,b){this.x=a;this.y=b;setDirty()};c.prototype.moveBy=function(a,b){this.move(this.x+a,this.y+b)};c.prototype.moveWithMagnetism=
function(a,b){this.snapped=false;var c=stage.getObjectsUnderPoint(a,b),d=this.createNewTargetPoint(a,b),e;for(e in c){var h=c[e].type,j=c[e];if(h===void 0)h=c[e].parent.type,j=c[e].parent;h=="Track"&&(d=this.snapToSegment(new Point2D(a,b),j))}this.makeShape();return d};c.prototype.createNewTargetPoint=function(a,b){var c={};c.distance=Number.MAX_VALUE;c.point=new Point2D(a,b);c.snapped=false;return c};c.prototype.snapToSegment=function(a,b,c){b=b.getAllPoints();c===void 0&&(c=this.createNewTargetPoint(a.x,
a.y));for(var d in b){var e=new Point2D(b[d].x,b[d].y),h=e.distanceFrom(a);if(c.distance>h)c.distance=h,c.point=e,c.segment=b[d].segment,this.snapped=c.snapped=true,this.snappedPoint=e,this.snappedSegment=b[d].segment,this.snappedPosition=b[d].position}return c};c.prototype.start=function(a){console.log("STARTING @ SNAPPED POSITION :"+this.snappedPosition);this.pointsInPath=[];this.indexInPath=this.snappedPosition;this.targetConnector=a;if(a==this.snappedSegment.connectorB)this.pointsInPath=this.snappedSegment.getPoints(this.pointsInPath);
if(a==this.snappedSegment.connectorA)this.pointsInPath=this.snappedSegment.getPoints(this.pointsInPath,true),this.indexInPath=config.pathPrecision-this.indexInPath;console.log("------- "+this.indexInPath+" --------")};c.prototype.step=function(){var a={status:"MOVING"};a.point=new Point2D;this.indexInPath>=config.pathPrecision-1?(console.log("END OF TRACK"),this.snappedPoint=new Point2D(this.x,this.y),this.targetConnector.edge!=null?(console.log("MOVING ON TO TRACK "+this.targetConnector.edge.track.id),
this.requestNextTrack(),a.status="NEXTTRACK"):(console.log("NOWHERE ELSE TO GO : STOP"),console.log("-------------------------"),this.snappedPosition=this.targetConnector==this.snappedSegment.connectorA?0:config.pathPrecision,a.status="STOPPED")):(this.indexInPath++,a.point.x=this.pointsInPath[this.indexInPath].x,a.point.y=this.pointsInPath[this.indexInPath].y);return a};c.prototype.requestNextTrack=function(){this.snappedSegment=this.targetConnector.edge.track.getSegmentTo(this.targetConnector.edge);
if(this.targetConnector.edge==this.snappedSegment.connectorA)this.snappedPosition=0,this.start(this.snappedSegment.connectorB);if(this.targetConnector.edge==this.snappedSegment.connectorB)this.snappedPosition=config.pathPrecision,this.start(this.snappedSegment.connectorA)};d.Bogie=c})(window);(function(d){function c(){this.type="Carriage";this.initialize()}c.prototype=new Container;c.prototype.Container_initialize=c.prototype.initialize;c.prototype.initialize=function(){this.Container_initialize();this.carriage=new Shape;this.carriage.snapToPixel=true;this.bogieFront=new Bogie;this.bogieBack=new Bogie;this.addChild(this.bogieFront);this.addChild(this.bogieBack);this.bogieFrontdx=20;this.bogieFrontdy=15;this.regX=this.bogieFrontdx;this.regY=this.bogieFrontdy;this.bogieFront.x=this.bogieFrontdx;
this.bogieFront.y=this.bogieFrontdy;this.bogieBackdx=80;this.bogieBackdy=15;this.bogieBack.x=this.bogieBackdx;this.bogieBack.y=this.bogieBackdy;this.bogieFrontMagnetism={};this.makeShape();this.addChild(this.carriage);this.moving=this.snapped=false};c.prototype.makeShape=function(){var a=this.carriage.graphics;a.clear();a.beginFill(colors.carriageFill);a.drawRect(0,0,100,30);a.drawCircle(0,15,15);setDirty()};c.prototype.onPress=function(a){railroad.hideRotationDial();railroad.forwardArrow.hide();
railroad.backwardArrow.hide();var b=this.x-a.stageX,c=this.y-a.stageY,d=this;a.onMouseMove=function(a){x=a.stageX+b;y=a.stageY+c;d.moveWithMagnetism(x,y)};a.onMouseUp=function(){d.snapped=false;if(d.bogieFrontMagnetism.snapped){var a=d.snapBackBogie();if(a)d.snapped=true,a=d.getRotationToBackBogie(a),d.makeShape(),d.showArrows(),setDirty(),redirectTickerToStage(true),Tween.get(d).to({rotation:a},600,Ease.bounceOut).call(redirectTickerToStage,[false])}}};c.prototype.snapBackBogie=function(){var a=
new Point2D(this.x+this.regX,this.y+this.regY),b=a.distanceFrom(new Point2D(this.x+this.bogieBackdx,this.y+this.bogieBackdy));if(this.bogieFrontMagnetism.segment.type=="LINE"){var c=this.bogieFrontMagnetism.segment.getStartPoint(),d=this.bogieFrontMagnetism.segment.getEndPoint();c.rmoveto(this.regX,this.regY);d.rmoveto(this.regX,this.regY);c=Intersection.intersectCircleLine(a,b,c,d)}if(this.bogieFrontMagnetism.segment.type=="BEZIER"){var c=this.bogieFrontMagnetism.segment.getStartPoint(),d=this.bogieFrontMagnetism.segment.cp1.clone(),
e=this.bogieFrontMagnetism.segment.cp2.clone(),h=this.bogieFrontMagnetism.segment.getEndPoint();c.rmoveto(this.regX,this.regY);d.rmoveto(this.regX,this.regY);e.rmoveto(this.regX,this.regY);h.rmoveto(this.regX,this.regY);c=Intersection.intersectBezier3Circle(c,d,e,h,a,b)}if((c.status="Intersection")&&c.points.length>0){var a=new Point2D,b=null,j;for(j in c.points)a.x=c.points[j].x,a.y=c.points[j].y,b=a.clone();this.bogieBack.snapToSegment(b,this.bogieFrontMagnetism.segment.connectorA.track);return b}else return null};
c.prototype.getRotationToBackBogie=function(a){if(a===void 0)return console.error("Carriage.prototype.getRotationToBackBogie : cannot rotate to undefined point"),0;var b=new Point2D(this.x+this.bogieBackdx,this.y+this.bogieBackdy);return(new Point2D(this.x+this.bogieFrontdx,this.y+this.bogieFrontdy)).getAngle(b,a)+180};c.prototype.showArrows=function(){railroad.forwardArrow.targetConnector=this.bogieFront.snappedSegment.connectorA;railroad.backwardArrow.targetConnector=this.bogieFront.snappedSegment.connectorB;
railroad.forwardArrow.carriage=this;railroad.backwardArrow.carriage=this;railroad.forwardArrow.x=this.x;railroad.backwardArrow.x=this.x;railroad.forwardArrow.y=this.y-20;railroad.backwardArrow.y=this.y-20;var a=railroad.forwardArrow.targetConnector.getCenter(),b=railroad.backwardArrow.targetConnector.getCenter(),c=new Point2D(this.x,this.y),a=c.getAngle(new Point2D(railroad.forwardArrow.x,railroad.forwardArrow.y),new Point2D(a.x,a.y));railroad.forwardArrow.rotation=a-180;a=new Point2D(railroad.forwardArrow.x,
railroad.forwardArrow.y);a.rotate(railroad.forwardArrow.rotation,new Point2D(this.x,this.y));railroad.forwardArrow.x=a.x;railroad.forwardArrow.y=a.y;b=c.getAngle(new Point2D(railroad.backwardArrow.x,railroad.backwardArrow.y),new Point2D(b.x,b.y));railroad.backwardArrow.rotation=b-180;b=new Point2D(railroad.backwardArrow.x,railroad.backwardArrow.y);b.rotate(railroad.backwardArrow.rotation,new Point2D(this.x,this.y));railroad.backwardArrow.x=b.x;railroad.backwardArrow.y=b.y;railroad.forwardArrow.show();
railroad.backwardArrow.show()};c.prototype.move=function(a,b){this.x=a;this.y=b;setDirty()};c.prototype.moveBy=function(a,b){this.move(this.x+a,this.y+b)};c.prototype.moveWithMagnetism=function(a,b){this.bogieFrontMagnetism=null;this.bogieFrontMagnetism=this.bogieFront.moveWithMagnetism(a,b);this.move(this.bogieFrontMagnetism.point.x,this.bogieFrontMagnetism.point.y);this.makeShape()};c.prototype.start=function(a){this.snapped?(this.bogieFront.start(a),this.bogieBack.start(a),this.moving=true):console.error("Carriage.prototype.start : cannot start an non snapped carriage")};
c.prototype.tick=function(){if(this.moving){var a=this.bogieFront.step(),b=this.bogieBack.step();if(a.status=="STOPPED"||b.status=="STOPPED")this.moving=false;else if(!(a.status=="NEXTTRACK"||b.status=="NEXTTRACK"))b.point.rmoveto(this.regX,this.regY),this.rotation=this.getRotationToBackBogie(b.point),this.move(a.point.x,a.point.y),setDirty()}};c.prototype.stop=function(){this.moving=false};d.Carriage=c})(window);(function(d){function c(){this.type="Arrow";this.initialize()}c.prototype=new Shape;c.prototype.Shape_initialize=c.prototype.initialize;c.prototype.initialize=function(){this.Shape_initialize();this.visible=false;this.currentColor=colors.arrow;this.makeShape();this.targetConnector=this.carriage=null};c.prototype.show=function(){topmost=stage.getNumChildren();stage.addChildAt(this,topmost);this.alpha=0.8;this.visible=true;setDirty()};c.prototype.hide=function(){this.visible=false;this.targetConnector=
this.carriage=null;setDirty()};c.prototype.onClick=function(){railroad.hideArrows();this.carriage.start(this.targetConnector);setDirty()};c.prototype.onMouseOver=function(){this.currentColor=colors.arrowHover;this.makeShape()};c.prototype.onMouseOut=function(){this.currentColor=colors.arrow;this.makeShape()};c.prototype.makeShape=function(){this.graphics.clear();this.regY=this.regX=6;this.graphics.clear();this.graphics.setStrokeStyle(1,"round").beginStroke(this.currentColor).beginFill(this.currentColor);
this.graphics.moveTo(6,0).lineTo(12,12).lineTo(0,12).lineTo(6,0);this.graphics.endFill();setDirty()};c.prototype.getAngle=function(a,b,c){var d;d=new Point2D(a.x,a.y);var b=new Point2D(b.x,b.y),e,a=new Point2D(a.x,a.y);e=new Point2D(c.x,c.y);c=b.x-d.x;d=b.y-d.y;b=a.x-e.x;a=a.y-e.y;e=Math.sqrt(c*c+d*d);var h=Math.sqrt(b*b+a*a);c/=e;d/=e;b/=h;a/=h;return(Math.atan2(a,b)-Math.atan2(d,c))/(Math.PI*2/360)};d.Arrow=c})(window);function Switch(d){this.targetConnectors=d;this.position=0}Switch.prototype.setPosition=function(d){this.position=d};Switch.prototype.getCurrentTarget=function(){return this.targetConnectors[this.position]};Switch.prototype.change=function(){this.position++;if(this.position>this.targetConnectors.length-1)this.position=0;console.log("Switched to position "+this.position);return this.targetConnectors[this.position]};var Keys=function(){return{deleteSelection:function(){if(railroad.selection.length!=0){for(var d=0;d<railroad.selection.length;d++)railroad.removeTrack(railroad.selection[d]);railroad.selection.clear()}},stopTrain:function(){carriage.stop()}}}();var stage,canvas,backgroundGrid,mapView,update=true,railroad,carriage=new Carriage,library=new Library,tracksDrawer=new TracksDrawer;
function init(){canvas=document.getElementById("trackCanvas");stage=new Stage(canvas);var d=window.innerWidth,c=window.innerHeight;canvas.width=d;canvas.height=c;stage.enableMouseOver();stage.snapToPixelEnabled=true;backgroundGrid=new Grid(d,c);backgroundGrid.x=d/2;backgroundGrid.y=c/2;mapView=new MapView(backgroundGrid,config.mapViewZoomLevel,300,250);stage.addChild(backgroundGrid);stage.addChild(mapView);stage.addChild(tracksDrawer);tracksDrawer.addTemplate("ShortStraightTrack");tracksDrawer.addTemplate("LargeCurvedTrack");
tracksDrawer.addTemplate("CurvedSwitchingTrack");railroad=new Railroad}
function createSampleObjects(){for(var d=[],c=0,a=0;a<10;a++){c=Math.floor(Math.random()*3);switch(c){case 0:d[a]=new Track("ShortStraightTrack");break;case 1:d[a]=new Track("ShortStraightTrack");break;case 2:d[a]=new Track("ShortStraightTrack")}railroad.addTrack(d[a]);d[a].move(Math.floor(Math.random()*400),Math.floor(Math.random()*400));d[a].rotate(Math.floor(Math.random()*361))}carriage.move(100,100);stage.addChild(carriage)}
function tick(){carriage&&carriage.moving&&carriage.tick();update&&(update=false,stage.addChild(mapView),mapView.refresh(),stage.update())}function setDirty(){update=true}function redirectTickerToStage(d){d?(Ticker.removeListener(window),Ticker.addListener(stage)):(Ticker.removeListener(stage),Ticker.addListener(window))}$(function(){init();Ticker.addListener(window);Ticker.setFPS(config.maxFPS);$(window).jkey("backspace",Keys.deleteSelection);$(window).jkey("space",Keys.stopTrain)});
